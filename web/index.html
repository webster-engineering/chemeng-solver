<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webster Engineering Equation Solver</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            /* Midnight Blue High-Contrast Theme (WCAG AAA) */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: rgba(33, 38, 45, 0.85);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent: #58a6ff;
            --accent-light: #79c0ff;
            --accent-glow: rgba(88, 166, 255, 0.2);
            --success: #3fb950;
            --warning: #d29922;
            --error: #f85149;
            --border: rgba(48, 54, 61, 0.8);
            --gradient-1: linear-gradient(135deg, #58a6ff 0%, #79c0ff 100%);
            --gradient-2: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-2);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Enhanced Animated Background - Orbital Gradients */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(ellipse at 30% 30%, rgba(88, 166, 255, 0.12) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 70%, rgba(121, 192, 255, 0.10) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 50%, rgba(88, 166, 255, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -2;
            animation: bgOrbit 60s linear infinite;
        }

        @keyframes bgOrbit {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Molecular Hexagonal Lattice Overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='52' viewBox='0 0 60 52'%3E%3Cpath d='M30 0 L60 15 L60 37 L30 52 L0 37 L0 15 Z' fill='none' stroke='rgba(91,110,174,0.025)' stroke-width='0.5'/%3E%3C/svg%3E");
            background-size: 60px 52px;
            pointer-events: none;
            z-index: -1;
            opacity: 0.8;
            animation: latticeShift 120s linear infinite;
        }

        @keyframes latticeShift {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 600px 520px;
            }
        }

        /* Volumetric Glow Pulse */
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(91, 110, 174, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
            animation: glowPulse 8s ease-in-out infinite;
        }

        @keyframes glowPulse {

            0%,
            100% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        /* Performance: Disable heavy animations for users who prefer reduced motion */
        @media (prefers-reduced-motion: reduce) {

            body::before,
            body::after,
            .bg-glow {
                animation: none !important;
            }
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr 380px;
            min-height: 100vh;
        }

        /* Sidebar with glass effect */
        .sidebar {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            padding: 24px 20px;
            overflow-y: auto;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: logoShine 3s ease-in-out infinite;
        }

        @keyframes logoShine {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.2);
            }
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
            transform: translateY(-1px);
        }

        .category {
            margin-bottom: 8px;
            animation: fadeInUp 0.4s ease-out backwards;
        }

        .category:nth-child(1) {
            animation-delay: 0.05s;
        }

        .category:nth-child(2) {
            animation-delay: 0.1s;
        }

        .category:nth-child(3) {
            animation-delay: 0.15s;
        }

        .category:nth-child(4) {
            animation-delay: 0.2s;
        }

        .category:nth-child(5) {
            animation-delay: 0.25s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-header {
            padding: 12px 14px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            transition: all 0.25s ease;
        }

        .category-header:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .category-count {
            background: var(--accent);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .equation-list {
            display: none;
            padding-left: 12px;
            margin-top: 4px;
        }

        .category.expanded {
            background: rgba(91, 110, 174, 0.08);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .category.expanded .category-header {
            color: var(--accent-light);
            background: rgba(91, 110, 174, 0.15);
            border-left: 3px solid var(--accent);
        }

        .category.expanded .category-count {
            background: var(--accent-light);
            box-shadow: 0 0 8px var(--accent-glow);
        }

        .category.expanded .equation-list {
            display: block;
            animation: slideDown 0.3s ease-out;
            padding: 8px 0 8px 12px;
            border-left: 1px solid rgba(91, 110, 174, 0.2);
            margin-left: 14px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .equation-item {
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.85rem;
            margin: 3px 0;
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
        }

        .equation-item:hover {
            background: var(--bg-card);
            border-left-color: var(--accent-light);
            padding-left: 18px;
        }

        .equation-item.active {
            background: var(--gradient-1);
            color: white;
            border-left-color: transparent;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        /* Main Content */
        .main-content {
            padding: 40px;
            overflow-y: auto;
        }

        .equation-header {
            margin-bottom: 32px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .equation-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .equation-description {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .equation-reference {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 8px;
            font-style: italic;
            opacity: 0.7;
        }

        .input-section {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            animation: cardSlideIn 0.5s ease-out;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--accent-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--gradient-1);
            border-radius: 2px;
        }

        .input-grid {
            display: grid;
            gap: 18px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 160px 1fr 110px;
            gap: 14px;
            align-items: center;
            animation: fadeInUp 0.3s ease-out backwards;
        }

        .input-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input-label .symbol {
            color: var(--accent-light);
            margin-right: 6px;
            font-weight: 600;
        }

        .input-field {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.25s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow), 0 4px 12px rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.5);
        }

        .input-field:hover:not(:focus) {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .unit-select {
            padding: 12px;
            background: #2a2a3e;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: #ffffff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .unit-select option {
            background: #2a2a3e;
            color: #ffffff;
            padding: 8px;
        }

        .unit-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .reference-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--accent-light);
            text-decoration: none;
            font-size: 0.85rem;
            margin-top: 10px;
            padding: 8px 14px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .reference-link:hover {
            background: rgba(91, 110, 174, 0.1);
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .calculate-btn {
            width: 100%;
            padding: 16px 28px;
            background: var(--gradient-1);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .calculate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .calculate-btn:hover::before {
            left: 100%;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--accent-glow);
        }

        .calculate-btn:active {
            transform: translateY(-1px);
        }

        .calculate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Panel */
        .results-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
        }

        .results-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 24px;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .validation-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 20px;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .validation-badge.pass {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .validation-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .validation-badge.fail {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .result-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 14px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            animation: resultSlideIn 0.4s ease-out backwards;
        }

        .result-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .result-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .result-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes resultSlideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .result-card:hover {
            border-color: var(--accent);
            transform: translateX(-4px);
            box-shadow: 4px 0 20px var(--accent-glow);
        }

        .result-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 1.6rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
        }

        .result-number {
            -webkit-background-clip: text;
            background-clip: text;
        }

        .result-unit {
            font-size: 0.9rem;
            color: var(--text-secondary);
            -webkit-text-fill-color: var(--text-secondary);
        }

        .result-unit-select {
            font-size: 0.85rem;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            -webkit-text-fill-color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .result-unit-select:hover {
            border-color: var(--accent);
        }

        .result-unit-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .result-card.stored {
            opacity: 0.8;
            border-style: dashed;
        }

        .stored-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stored-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .stored-equation {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 10px;
        }

        .pid-metrics {
            margin: 15px 0;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .metric {
            background: var(--bg-card);
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .metric-label {
            color: var(--text-secondary);
            margin-right: 6px;
        }

        .metric strong {
            color: var(--accent-light);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
            animation: fadeIn 0.6s ease-out;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .empty-state h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .tool-card {
            padding: 14px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tool-card:hover {
            border-color: var(--accent);
            background: rgba(91, 110, 174, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--accent-glow);
        }

        .tool-card svg {
            stroke: var(--accent-light);
        }

        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            border: 1px solid var(--border);
            z-index: 100;
            animation: tooltipFade 0.2s ease-out;
        }

        @keyframes tooltipFade {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            background: var(--accent);
            transform: rotate(20deg);
        }

        /* Tips Carousel - Fixed bottom right (stays on top while scrolling) */
        .tips-carousel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            z-index: 9999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }


        .tips-carousel .tip {
            display: none;
            animation: tipFade 0.5s ease-out;
        }

        .tips-carousel .tip.active {
            display: block;
        }

        .tips-carousel .tip-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .tips-carousel .tip-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .tips-carousel .tip-label {
            font-size: 0.7rem;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        @keyframes tipFade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Equation Preview Tooltip */
        .equation-item {
            position: relative;
        }

        .equation-preview {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            width: 280px;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .equation-item:hover .equation-preview {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
            pointer-events: auto;
        }

        .equation-preview h4 {
            font-size: 0.9rem;
            color: var(--accent-light);
            margin-bottom: 6px;
        }

        .equation-preview p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .equation-preview .preview-inputs {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Input Validation States */
        .input-field.valid {
            border-color: var(--success) !important;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }

        .input-field.warning {
            border-color: var(--warning) !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .input-field.invalid {
            border-color: var(--error) !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        /* Copy Toast */
        .copy-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .copy-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Result Card Copy Interaction */
        .result-card {
            cursor: pointer;
            position: relative;
        }

        .result-card::after {
            content: 'ðŸ“‹ Click to copy';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .result-card:hover::after {
            opacity: 1;
        }

        /* Comparison Mode */
        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .comparison-toggle input {
            accent-color: var(--accent);
        }

        .result-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .result-comparison .result-card {
            font-size: 0.85rem;
        }

        .result-comparison .result-card.previous {
            opacity: 0.6;
            border-style: dashed;
        }

        .delta-indicator {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .delta-indicator.positive {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .delta-indicator.negative {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Calculation Counter */
        .calc-counter {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            z-index: 100;
        }

        .calc-counter strong {
            color: var(--accent-light);
        }

        /* History Dropdown */
        .history-dropdown {
            position: relative;
        }

        .history-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 8px 14px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
            text-align: left;
        }

        .history-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .history-list.show {
            display: block;
        }

        .history-item {
            padding: 10px 14px;
            font-size: 0.8rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .history-item:hover {
            background: rgba(91, 110, 174, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Light Theme */
        body.light-mode {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.6);
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --border: rgba(0, 0, 0, 0.1);
            --gradient-2: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
        }

        body.light-mode::before {
            background:
                radial-gradient(ellipse at 20% 20%, rgba(91, 110, 174, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
        }

        body.light-mode .unit-select,
        body.light-mode .unit-select option {
            background: #f0f0f5;
            color: #1d1d1f;
        }

        body.light-mode .input-field {
            background: rgba(0, 0, 0, 0.03);
            color: #1d1d1f;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* ===============================================
           VISUAL ENHANCEMENTS - Engineering Aesthetics
           =============================================== */

        /* Floating Engineering Symbols Container */
        .floating-symbols {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .floating-symbol {
            position: absolute;
            opacity: 0.04;
            animation: floatDrift 40s ease-in-out infinite;
        }

        .floating-symbol:nth-child(1) {
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .floating-symbol:nth-child(2) {
            top: 60%;
            left: 15%;
            animation-delay: -8s;
        }

        .floating-symbol:nth-child(3) {
            top: 20%;
            right: 10%;
            animation-delay: -16s;
        }

        .floating-symbol:nth-child(4) {
            top: 70%;
            right: 20%;
            animation-delay: -24s;
        }

        .floating-symbol:nth-child(5) {
            top: 40%;
            left: 50%;
            animation-delay: -32s;
        }

        .floating-symbol:nth-child(6) {
            bottom: 15%;
            left: 30%;
            animation-delay: -12s;
        }

        @keyframes floatDrift {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            25% {
                transform: translate(30px, -20px) rotate(5deg);
            }

            50% {
                transform: translate(10px, 30px) rotate(-3deg);
            }

            75% {
                transform: translate(-20px, 10px) rotate(2deg);
            }
        }

        /* Particle Canvas Background */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.6;
        }

        /* Enhanced Button - Neon Edge Glow */
        .calculate-btn {
            position: relative;
            overflow: hidden;
        }

        .calculate-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(90deg, #5b6eae, #6b7db8, #7a8bc4, #6b7db8, #5b6eae);
            background-size: 400% 100%;
            z-index: -1;
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.4s ease;
            animation: neonShift 3s linear infinite;
        }

        .calculate-btn:hover::before {
            opacity: 1;
        }

        @keyframes neonShift {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 400% 50%;
            }
        }

        /* Liquid Metal Ripple Effect on Click */
        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 70%);
            transform: scale(0);
            animation: rippleExpand 0.6s ease-out forwards;
            pointer-events: none;
        }

        @keyframes rippleExpand {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Tool Card Energy Wave Effect */
        .tool-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            z-index: -1;
        }

        .tool-card:hover::before {
            width: 300px;
            height: 300px;
        }

        /* Icon Glow Pulse on Hover */
        .category-header:hover .category-count,
        .equation-item:hover {
            animation: iconGlow 1.5s ease-in-out infinite;
        }

        @keyframes iconGlow {

            0%,
            100% {
                box-shadow: 0 0 5px var(--accent-glow);
            }

            50% {
                box-shadow: 0 0 20px var(--accent-glow), 0 0 30px var(--accent-glow);
            }
        }

        /* Blueprint Line-Draw Animation */
        .blueprint-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawLine 3s ease-out forwards;
        }

        @keyframes drawLine {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* Thermodynamic Contour Decoration */
        .thermo-contour {
            position: absolute;
            opacity: 0.03;
            pointer-events: none;
        }

        .results-panel .thermo-contour {
            bottom: 0;
            right: 0;
            width: 200px;
            height: 200px;
        }

        /* Animated Flask Bubbles */
        @keyframes bubbleRise {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.7;
            }

            50% {
                transform: translateY(-15px) scale(1.2);
                opacity: 0.5;
            }

            100% {
                transform: translateY(-30px) scale(0.8);
                opacity: 0;
            }
        }

        .flask-bubble {
            animation: bubbleRise 2s ease-in-out infinite;
        }

        .flask-bubble:nth-child(1) {
            animation-delay: 0s;
        }

        .flask-bubble:nth-child(2) {
            animation-delay: 0.5s;
        }

        .flask-bubble:nth-child(3) {
            animation-delay: 1s;
        }

        /* Liquid Oscillation in Flask */
        @keyframes liquidWave {

            0%,
            100% {
                d: path('M25 70 Q50 65 75 70 L75 80 Q50 85 25 80 Z');
            }

            50% {
                d: path('M25 70 Q50 75 75 70 L75 80 Q50 75 25 80 Z');
            }
        }

        .flask-liquid {
            animation: liquidWave 3s ease-in-out infinite;
        }

        /* CSS 3D Flask Animation */
        .flask-3d-container {
            perspective: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .flask-3d {
            transform-style: preserve-3d;
            animation: flask3DRotate 20s ease-in-out infinite, flaskFloat 4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(91, 110, 174, 0.4));
        }

        @keyframes flask3DRotate {

            0%,
            100% {
                transform: rotateY(-15deg) rotateX(5deg);
            }

            25% {
                transform: rotateY(10deg) rotateX(-3deg);
            }

            50% {
                transform: rotateY(15deg) rotateX(-5deg);
            }

            75% {
                transform: rotateY(-10deg) rotateX(3deg);
            }
        }

        @keyframes flaskFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .flask-3d:hover {
            animation-play-state: paused;
            transform: rotateY(0deg) rotateX(0deg) scale(1.05);
            transition: transform 0.3s ease;
        }

        /* Typewriter Effect */
        .typewriter {
            overflow: hidden;
            border-right: 2px solid var(--accent);
            white-space: nowrap;
            margin: 20px auto;
            animation: typing 3s steps(40, end), blinkCursor 0.75s step-end infinite;
        }

        @keyframes typing {
            from {
                width: 0;
            }

            to {
                width: 100%;
            }
        }

        @keyframes blinkCursor {

            from,
            to {
                border-color: transparent;
            }

            50% {
                border-color: var(--accent);
            }
        }

        .tagline-fade {
            animation: fadeInUp 1s ease-out 2.5s both;
        }

        /* Engineering Schematics Background */
        .schematics-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.03;
        }

        .schematic-line {
            stroke: var(--accent);
            stroke-width: 1;
            fill: none;
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
            animation: drawLine 8s linear infinite;
        }

        @keyframes drawLine {
            0% {
                stroke-dashoffset: 200;
            }

            50% {
                stroke-dashoffset: 0;
            }

            100% {
                stroke-dashoffset: -200;
            }
        }

        /* Logo Hover Animation */
        .logo:hover {
            animation: logoBounce 0.6s ease;
        }

        .logo:hover svg,
        .logo:hover .logo-icon {
            animation: logoSpin 0.8s ease-in-out;
        }

        @keyframes logoBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            25% {
                transform: translateY(-5px);
            }

            50% {
                transform: translateY(0);
            }

            75% {
                transform: translateY(-3px);
            }
        }

        @keyframes logoSpin {
            0% {
                transform: rotate(0deg) scale(1);
            }

            25% {
                transform: rotate(-10deg) scale(1.1);
            }

            50% {
                transform: rotate(10deg) scale(1.1);
            }

            75% {
                transform: rotate(-5deg) scale(1.05);
            }

            100% {
                transform: rotate(0deg) scale(1);
            }
        }

        /* Category Expansion Animation */
        .category .equations {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 0;
        }

        .category.expanded .equations {
            max-height: 1000px;
            opacity: 1;
        }

        .category-header {
            cursor: pointer;
            position: relative;
            padding-right: 30px;
        }

        .category-header::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            width: 8px;
            height: 8px;
            border-right: 2px solid var(--text-secondary);
            border-bottom: 2px solid var(--text-secondary);
            transform: translateY(-50%) rotate(-45deg);
            transition: transform 0.3s ease;
        }

        .category.expanded .category-header::after {
            transform: translateY(-70%) rotate(45deg);
        }

        /* Gradient Border Effect for Panels */
        .results-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-1);
            opacity: 0.6;
        }

        /* History Dropdown UI */
        .history-dropdown {
            position: relative;
            display: inline-block;
        }

        .history-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 14px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .history-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 280px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 8px;
            padding: 8px;
            z-index: 100;
            display: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .history-menu.show {
            display: block;
            animation: dropdownSlide 0.25s ease-out;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: rgba(91, 110, 174, 0.1);
        }

        .history-item .time {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .history-item .values {
            font-size: 0.8rem;
            color: var(--text-primary);
            margin-top: 4px;
        }

        /* Input Linking Suggestions */
        .link-suggestions {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .link-suggestions h4 {
            font-size: 0.85rem;
            color: var(--accent-light);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .link-suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-glass);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .link-suggestion-item:hover {
            background: rgba(91, 110, 174, 0.12);
            transform: translateX(4px);
        }

        .link-suggestion-item .eq-name {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .link-suggestion-item .param-match {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .link-arrow {
            color: var(--accent);
            font-size: 1.2rem;
        }

        /* Equation Preview Enhancement */
        .equation-preview {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(91, 110, 174, 0.04) 100%);
        }

        .equation-preview .formula {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--accent-light);
            margin: 8px 0;
        }

        /* ===== Tab Navigation ===== */
        .main-tabs {
            display: flex;
            gap: 4px;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .main-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .main-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .main-tab.active {
            color: var(--accent-light);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== Scientific Calculator ===== */
        .sci-calculator {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .calc-display {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .calc-history {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-height: 20px;
            text-align: right;
            padding-right: 5px;
        }

        .calc-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 2rem;
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
            outline: none;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .calc-btn {
            padding: 15px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        .calc-btn.number {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .calc-btn.number.wide {
            grid-column: span 2;
        }

        .calc-btn.operator {
            background: rgba(91, 110, 174, 0.2);
            color: var(--accent-light);
        }

        .calc-btn.function {
            background: rgba(91, 110, 174, 0.1);
            font-size: 0.85rem;
        }

        .calc-btn.memory {
            background: rgba(122, 139, 196, 0.1);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .calc-btn.clear {
            background: rgba(220, 80, 80, 0.15);
            color: #e57373;
        }

        .calc-btn.equals {
            background: var(--accent);
            color: white;
            font-size: 1.5rem;
        }

        .calc-btn.equals:hover {
            background: var(--accent-light);
        }

        .calc-btn.const {
            background: rgba(150, 180, 220, 0.15);
            font-style: italic;
        }

        .calc-info {
            margin-top: 10px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ===== Reference Data Panels ===== */
        .reference-panel {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .reference-panel h2 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
        }

        .ref-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .ref-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            align-items: center;
        }

        .ref-controls input,
        .ref-controls select {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .ref-controls input {
            min-width: 200px;
        }

        .ref-controls input:focus,
        .ref-controls select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .ref-table-container {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
        }

        .ref-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .ref-table th,
        .ref-table td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .ref-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        .ref-table th:first-child,
        .ref-table td:first-child {
            text-align: left;
        }

        .ref-table tbody tr:hover {
            background: rgba(91, 110, 174, 0.1);
        }

        .ref-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Graphing Panel Styles */
        .graphing-panel {
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .graphing-panel h2 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .graph-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .graph-type-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .graph-type-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .graph-type-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .graph-container {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .graph-container.active {
            display: block;
        }

        .graph-container h3 {
            color: var(--text-primary);
            margin: 0 0 15px 0;
            font-size: 1.2rem;
        }

        .graph-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .graph-controls .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .graph-controls label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .graph-controls input,
        .graph-controls select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            width: 140px;
            font-size: 0.9rem;
        }

        .graph-controls input:focus,
        .graph-controls select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chart-wrapper {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
        }

        .chart-wrapper canvas {
            max-height: 400px;
        }

        .moody-result {
            background: linear-gradient(135deg, rgba(91, 110, 174, 0.2), rgba(91, 110, 174, 0.1));
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .moody-result strong {
            color: var(--accent-light);
        }

        /* Unit Converter Styles */
        .converter-panel {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .converter-panel h2 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .converter-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-top: 20px;
        }

        .converter-main {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
        }

        .converter-category-select {
            margin-bottom: 20px;
        }

        .converter-category-select label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .converter-category-select select {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .converter-inputs {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            flex-wrap: wrap;
        }

        .conv-input-group {
            flex: 1;
            min-width: 200px;
        }

        .conv-input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .conv-input-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .conv-input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .conv-input-group input[readonly] {
            background: rgba(91, 110, 174, 0.1);
            color: var(--accent-light);
        }

        .conv-input-group select {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .swap-btn {
            background: var(--accent);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-bottom: 20px;
        }

        .swap-btn:hover {
            background: var(--accent-light);
            transform: rotate(180deg);
        }

        .conv-formula {
            margin-top: 20px;
            padding: 15px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            color: var(--success);
            font-family: monospace;
            font-size: 1rem;
        }

        .conv-history {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .conv-history h4 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        #convHistoryList {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: rgba(91, 110, 174, 0.2);
        }

        /* Cheat Sheet */
        .cheat-sheet {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }

        .cheat-sheet h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .cheat-section {
            margin-bottom: 15px;
        }

        .cheat-section h4 {
            color: var(--accent);
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cheat-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cheat-item {
            padding: 8px 10px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cheat-item:hover {
            background: rgba(91, 110, 174, 0.2);
            color: var(--text-primary);
        }

        @media (max-width: 900px) {
            .converter-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Chemical Database Detail Panel */
        .chem-detail-panel {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(91, 110, 174, 0.15), rgba(91, 110, 174, 0.05));
            border: 1px solid var(--accent);
            border-radius: 12px;
        }

        .chem-detail-panel h3 {
            color: var(--accent-light);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .chem-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .chem-prop {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .chem-prop span {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .chem-prop strong {
            color: var(--text-primary);
            font-size: 1rem;
        }

        /* Collapsible Sections (Derivation/Examples) */
        .collapsible-section {
            margin: 15px 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .section-toggle {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .section-toggle:hover {
            background: rgba(91, 110, 174, 0.2);
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            line-height: 1.7;
        }

        .section-content h4 {
            color: var(--accent-light);
            margin: 15px 0 8px 0;
        }

        .section-content p,
        .section-content li {
            color: var(--text-secondary);
        }

        .section-content strong {
            color: var(--text-primary);
        }

        .section-content code {
            background: rgba(91, 110, 174, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .example-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
        }

        .example-card h5 {
            color: var(--accent-light);
            margin: 0 0 8px 0;
            font-size: 1rem;
        }

        .example-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }

        .example-input {
            background: var(--bg-card);
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .example-input span {
            color: var(--text-secondary);
        }

        .example-input strong {
            color: var(--text-primary);
        }

        .example-steps {
            margin-top: 12px;
            padding-left: 20px;
        }

        .example-steps li {
            margin: 6px 0;
            color: var(--text-secondary);
        }

        .example-conclusion {
            margin-top: 12px;
            padding: 10px;
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid var(--success);
            border-radius: 0 4px 4px 0;
            color: var(--success);
        }

        .load-example-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--accent);
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .load-example-btn:hover {
            background: var(--accent-light);
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar,
            .results-panel {
                display: none;
            }
        }

        /* ================================
           LEARNING MODE STYLES
           ================================ */

        /* Learning Mode Toggle */
        .learning-toggle {
            position: fixed;
            top: 20px;
            right: 70px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .learning-toggle:hover {
            background: rgba(88, 166, 255, 0.1);
            border-color: var(--accent);
        }

        .learning-toggle.active {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            border-color: transparent;
            color: white;
        }

        .learning-toggle .toggle-icon {
            font-size: 1.1rem;
        }

        /* Learning Badge on Equation Items */
        .equation-item .learning-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #34d399);
            color: #1f2937;
            /* Dark gray for better readability */
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            vertical-align: middle;
        }

        /* Responsive Design for Small Screens */

        /* Mobile Hamburger Menu */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn span {
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Mobile Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
        }

        /* Responsive Typography with clamp() */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                display: block;
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: flex;
            }

            .sidebar-overlay {
                display: block;
                pointer-events: none;
            }

            .sidebar-overlay.active {
                pointer-events: auto;
            }

            .results-panel {
                display: none;
            }

            /* Responsive typography */
            h1,
            .equation-title {
                font-size: clamp(1.25rem, 4vw, 1.75rem);
            }

            h2 {
                font-size: clamp(1.1rem, 3.5vw, 1.5rem);
            }

            h3,
            .section-title {
                font-size: clamp(0.9rem, 3vw, 1.1rem);
            }

            .main-content {
                padding: 20px;
                padding-top: 70px;
                /* Space for hamburger menu */
            }

            /* Hide secondary elements on tablet */
            .floating-symbols,
            .tips-carousel,
            .bg-glow {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
                padding-top: 70px;
            }

            /* Touch-friendly buttons (minimum 44x44px) */
            .calculate-btn,
            .learning-nav-btn,
            .tool-card,
            .quiz-option {
                min-height: 44px;
                min-width: 44px;
            }

            .input-field,
            .unit-select {
                min-height: 44px;
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .input-group {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .learning-toggle {
                right: 10px;
                top: 20px;
                padding: 8px 12px;
                font-size: 0.75rem;
                min-height: 44px;
            }

            .learning-stepper {
                flex-wrap: wrap;
                gap: 8px;
            }

            .stepper-step {
                flex: 1 1 auto;
                min-width: 55px;
            }

            .stepper-circle {
                width: 36px;
                height: 36px;
                font-size: 0.8rem;
            }

            .stepper-label {
                font-size: 0.65rem;
            }

            /* Priority-based display - hide non-essential on mobile */
            .equation-reference,
            #externalLinks,
            .collapsible-section,
            .xp-badge,
            .streak-badge {
                display: none;
            }

            /* Compact welcome page on mobile */
            #welcomeState h2 {
                font-size: clamp(1rem, 5vw, 1.5rem);
                padding: 0 10px;
            }

            #welcomeState .tool-card {
                padding: 10px 15px;
                font-size: 0.8rem;
            }

            #welcomeState .tool-card svg {
                width: 18px;
                height: 18px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
                padding-top: 65px;
            }

            /* Stack tool cards vertically on very small screens */
            #welcomeState>div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 10px !important;
            }

            .learning-panel {
                padding: 15px;
            }

            .learning-step-content {
                padding: 10px 0;
            }

            /* Smaller quiz options */
            .quiz-option {
                padding: 12px;
                font-size: 0.85rem;
            }
        }

        /* Difficulty Badges */
        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .difficulty-badge.beginner {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .difficulty-badge.intermediate {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .difficulty-badge.advanced {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Learning Panel - replaces input section when active */
        .learning-panel {
            display: none;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            animation: cardSlideIn 0.5s ease-out;
        }

        .learning-panel.active {
            display: block;
        }

        /* Progress Stepper */
        .learning-stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .learning-stepper::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: var(--border);
        }

        .stepper-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .stepper-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .stepper-step.active .stepper-circle {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .stepper-step.completed .stepper-circle {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .stepper-label {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            max-width: 80px;
        }

        .stepper-step.active .stepper-label {
            color: var(--accent-light);
            font-weight: 600;
        }

        /* Learning Step Content */
        .learning-step-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .learning-step-content.active {
            display: block;
        }

        .step-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-header .step-icon {
            font-size: 1.5rem;
        }

        /* Theory Section */
        .theory-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .theory-content strong {
            color: var(--accent-light);
        }

        .key-concepts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .concept-tag {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: var(--accent-light);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        /* Application Cards */
        .applications-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .application-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .application-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        /* Variable Source Cards */
        .variable-sources {
            display: grid;
            gap: 12px;
            margin-top: 15px;
        }

        .variable-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 15px;
            align-items: center;
        }

        .variable-symbol {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-light);
            text-align: center;
            background: rgba(88, 166, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .variable-info h4 {
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .variable-info p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Quiz Section */
        .quiz-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .quiz-question {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .quiz-options {
            display: grid;
            gap: 10px;
        }

        .quiz-option {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 14px 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .quiz-option:hover {
            border-color: var(--accent);
            background: rgba(88, 166, 255, 0.05);
        }

        .quiz-option.selected {
            border-color: var(--accent);
            background: rgba(88, 166, 255, 0.15);
        }

        .quiz-option.correct {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }

        .quiz-option.incorrect {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
        }

        .quiz-feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .quiz-feedback.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .quiz-feedback.correct {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .quiz-feedback.incorrect {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .quiz-hint-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 15px;
            transition: all 0.2s ease;
        }

        .quiz-hint-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        .quiz-hint {
            margin-top: 12px;
            padding: 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            color: var(--warning);
            font-size: 0.9rem;
            display: none;
        }

        .quiz-hint.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* Progress indicator */
        .quiz-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .quiz-progress-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .quiz-progress-fill {
            height: 100%;
            background: var(--gradient-1);
            transition: width 0.3s ease;
        }

        /* Navigation Buttons */
        .learning-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .learning-nav-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .learning-nav-btn.prev {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .learning-nav-btn.prev:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .learning-nav-btn.next {
            background: var(--gradient-1);
            border: none;
            color: white;
        }

        .learning-nav-btn.next:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .learning-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Explain Button */
        .explain-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            border: none;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .explain-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        /* Explanation Panel */
        .explanation-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .explanation-panel.show {
            display: block;
            animation: cardSlideIn 0.4s ease-out;
        }

        .explanation-step {
            padding: 15px;
            border-left: 3px solid var(--accent);
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 8px 8px 0;
        }

        .explanation-step h4 {
            color: var(--accent-light);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .explanation-step p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .explanation-step .formula {
            font-family: 'Courier New', monospace;
            background: rgba(88, 166, 255, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--accent-light);
            display: inline-block;
        }

        /* Gamification Elements */
        .xp-display {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.8rem;
            color: var(--warning);
            display: none;
            z-index: 999;
        }

        .xp-display.show {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .streak-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* XP Popup Animation */
        .xp-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 16px;
            font-size: 1.5rem;
            font-weight: 700;
            z-index: 10000;
            display: none;
            animation: xpPopup 1s ease-out forwards;
        }

        @keyframes xpPopup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }

            40% {
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -70%) scale(1);
            }
        }

        /* Common Mistakes Warning Box */
        .mistakes-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .mistakes-box h4 {
            color: #ef4444;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mistakes-box ul {
            list-style: none;
            padding: 0;
        }

        .mistakes-box li {
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
        }

        .mistakes-box li::before {
            content: 'âš ';
            position: absolute;
            left: 0;
            color: #ef4444;
        }

        /* Pro Tips Box */
        .tips-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .tips-box h4 {
            color: #10b981;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-box li {
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
        }

        .tips-box li::before {
            content: 'ðŸ’¡';
            position: absolute;
            left: 0;
        }

        /* Interactive Diagram Container */
        .diagram-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .diagram-container svg {
            max-width: 100%;
            height: auto;
        }

        .diagram-label {
            fill: var(--text-secondary);
            font-size: 12px;
        }

        .diagram-value {
            fill: var(--accent-light);
            font-size: 14px;
            font-weight: 600;
        }

        /* Category Progress */
        .category-progress {
            margin-top: 6px;
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .category-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.3s ease;
        }

        /* Completed Equation Item */
        .equation-item.completed {
            position: relative;
        }

        .equation-item.completed::after {
            content: 'âœ“';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #10b981;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Interactive Gas Tank Diagram */
        .diagram-svg {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            display: block;
        }

        .diagram-element {
            transition: all 0.3s ease;
        }

        .diagram-element:hover {
            filter: brightness(1.2);
            cursor: pointer;
        }

        .diagram-tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.85rem;
            color: var(--text-primary);
            z-index: 1000;
            max-width: 250px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            display: none;
        }

        .diagram-tooltip.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        /* Hint Button */
        .hint-btn {
            background: transparent;
            border: 1px dashed var(--warning);
            color: var(--warning);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .hint-btn:hover {
            background: rgba(245, 158, 11, 0.1);
            border-style: solid;
        }

        .hint-content {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 10px;
            color: var(--warning);
            font-size: 0.9rem;
            display: none;
        }

        .hint-content.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .hint-content.level-2 {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }

        .hint-content.level-3 {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* Unit Practice Mode */
        .practice-panel {
            padding: 30px;
            max-width: 900px;
            margin: 0 auto;
        }

        .practice-problem {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }

        .practice-question {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 30px;
        }

        .practice-question .from-value {
            color: var(--accent-light);
            font-weight: 700;
        }

        .practice-question .to-unit {
            color: var(--warning);
            font-weight: 600;
        }

        .practice-input-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .practice-input {
            width: 200px;
            padding: 15px;
            font-size: 1.3rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            text-align: center;
        }

        .practice-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .practice-result-unit {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .practice-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .practice-stat {
            text-align: center;
        }

        .practice-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-light);
        }

        .practice-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .practice-feedback {
            margin-top: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            display: none;
        }

        .practice-feedback.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .practice-feedback.correct {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid #10b981;
            color: #10b981;
        }

        .practice-feedback.incorrect {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid #ef4444;
            color: #ef4444;
        }
    </style>
</head>

<body>
    <!-- Mobile Hamburger Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">ðŸŒ™</button>

    <!-- Learning Mode Toggle -->
    <button class="learning-toggle" id="learningToggle" onclick="toggleLearningMode()" title="Toggle Learning Mode">
        <span class="toggle-icon">ðŸŽ“</span>
        <span class="toggle-text">Learning Mode</span>
    </button>

    <!-- XP Display (shown when learning mode active) -->
    <div class="xp-display" id="xpDisplay">
        â­ <span id="totalXp">0</span> XP
        <span class="streak-badge" id="streakBadge" style="display: none;">ðŸ”¥ <span id="streakCount">0</span></span>
    </div>

    <!-- XP Popup (animated) -->
    <div class="xp-popup" id="xpPopup">+50 XP</div>

    <!-- Copy Toast -->
    <div class="copy-toast" id="copyToast">âœ“ Copied to clipboard!</div>

    <!-- Calculation Counter -->
    <div class="calc-counter" id="calcCounter">
        Calculations today: <strong id="calcCount">0</strong>
    </div>

    <!-- Particle Canvas for Molecular Motion -->
    <canvas id="particleCanvas"></canvas>

    <!-- Volumetric Glow -->
    <div class="bg-glow"></div>

    <!-- Engineering Schematics Background -->
    <svg class="schematics-bg" viewBox="0 0 1000 800" preserveAspectRatio="xMidYMid slice">
        <!-- Pipe network lines -->
        <path class="schematic-line" d="M0 200 L200 200 L200 400 L400 400" style="animation-delay: 0s" />
        <path class="schematic-line" d="M1000 300 L800 300 L800 500 L600 500" style="animation-delay: 2s" />
        <path class="schematic-line" d="M500 0 L500 150 L700 150 L700 300" style="animation-delay: 4s" />
        <path class="schematic-line" d="M100 800 L100 600 L300 600 L300 450" style="animation-delay: 1s" />
        <path class="schematic-line" d="M900 800 L900 650 L700 650 L700 550" style="animation-delay: 3s" />
        <!-- Flow diagram elements -->
        <rect class="schematic-line" x="380" y="380" width="40" height="40" style="animation-delay: 5s" />
        <rect class="schematic-line" x="580" y="480" width="40" height="40" style="animation-delay: 6s" />
        <circle class="schematic-line" cx="200" cy="200" r="15" style="animation-delay: 0.5s" />
        <circle class="schematic-line" cx="800" cy="300" r="15" style="animation-delay: 2.5s" />
        <!-- Additional connecting lines -->
        <path class="schematic-line" d="M420 400 L580 500" style="animation-delay: 5.5s" />
        <path class="schematic-line" d="M300 450 L380 400" style="animation-delay: 1.5s" />
    </svg>

    <!-- Floating Engineering Symbols -->
    <div class="floating-symbols">
        <!-- Pump Symbol -->
        <svg class="floating-symbol" width="80" height="80" viewBox="0 0 100 100" fill="none">
            <circle cx="50" cy="50" r="35" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <path d="M30 50 L70 50 M50 30 L50 70" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <path d="M50 15 L50 30 M50 70 L50 85" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
        <!-- Valve Symbol -->
        <svg class="floating-symbol" width="70" height="70" viewBox="0 0 100 100" fill="none">
            <path d="M20 50 L50 30 L80 50 L50 70 Z" stroke="currentColor" stroke-width="2" fill="none" opacity="0.5" />
            <line x1="10" y1="50" x2="20" y2="50" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="80" y1="50" x2="90" y2="50" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
        <!-- Heat Exchanger Symbol -->
        <svg class="floating-symbol" width="90" height="60" viewBox="0 0 120 80" fill="none">
            <ellipse cx="60" cy="40" rx="50" ry="30" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="10" y1="40" x2="30" y2="40" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="90" y1="40" x2="110" y2="40" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <path d="M40 25 L40 55 M50 25 L50 55 M60 25 L60 55 M70 25 L70 55 M80 25 L80 55" stroke="currentColor"
                stroke-width="1" opacity="0.3" />
        </svg>
        <!-- Reactor Symbol -->
        <svg class="floating-symbol" width="60" height="80" viewBox="0 0 80 100" fill="none">
            <rect x="15" y="20" width="50" height="60" rx="5" stroke="currentColor" stroke-width="2" fill="none"
                opacity="0.5" />
            <path d="M30 20 L30 10 L50 10 L50 20" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <circle cx="40" cy="50" r="15" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <line x1="15" y1="80" x2="15" y2="90" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="65" y1="80" x2="65" y2="90" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
        <!-- Distillation Column Symbol -->
        <svg class="floating-symbol" width="50" height="100" viewBox="0 0 60 120" fill="none">
            <rect x="15" y="10" width="30" height="100" rx="3" stroke="currentColor" stroke-width="2" fill="none"
                opacity="0.5" />
            <line x1="15" y1="30" x2="45" y2="30" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <line x1="15" y1="50" x2="45" y2="50" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <line x1="15" y1="70" x2="45" y2="70" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <line x1="15" y1="90" x2="45" y2="90" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <path d="M5 20 L15 20" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <path d="M45 10 L55 10" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
        <!-- Tank Symbol -->
        <svg class="floating-symbol" width="70" height="70" viewBox="0 0 100 100" fill="none">
            <ellipse cx="50" cy="20" rx="30" ry="10" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <ellipse cx="50" cy="80" rx="30" ry="10" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="20" y1="20" x2="20" y2="80" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="80" y1="20" x2="80" y2="80" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
    </div>


    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="/" class="logo" style="text-decoration: none;">
                <img src="/logo.png" alt="Webster Engineering" style="height: 40px; filter: invert(1);">
            </a>
            <input type="text" class="search-box" placeholder="Search equations..." id="searchBox">
            <div id="categoryList"></div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Equations Tab Content -->
            <div id="equationsTab" class="tab-content active">
                <div id="welcomeState" class="empty-state"
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <h2>Welcome to the Webster Engineering Solver</h2>
                    <p class="tagline-fade">Select an equation from the sidebar to get started</p>
                    <div
                        style="background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 8px; padding: 12px 20px; margin-top: 20px; max-width: 500px;">
                        <p
                            style="color: #f59e0b; font-size: 0.85rem; margin: 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1rem;">âš ï¸</span>
                            <strong>Beta Version</strong> â€” This site is under active development. Results should be
                            verified independently. Report bugs or errors to improve the tool.
                        </p>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">

                        <a href="/pid.html" class="tool-card">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" />
                                <line x1="3" y1="9" x2="21" y2="9" />
                                <line x1="9" y1="21" x2="9" y2="9" />
                            </svg>
                            P&ID Sketcher
                        </a>
                        <a href="/wizard.html" class="tool-card">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M12 1v6m0 6v10M4.22 4.22l4.24 4.24m7.07 7.07l4.24 4.24M1 12h6m6 0h10M4.22 19.78l4.24-4.24m7.07-7.07l4.24-4.24" />
                            </svg>
                            Unit Ops Wizard
                        </a>
                        <button onclick="switchTab('graphing')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                            </svg>
                            Graphing Tools
                        </button>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
                        <button onclick="switchTab('scientific')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="4" y="2" width="16" height="20" rx="2" />
                                <line x1="8" y1="6" x2="16" y2="6" />
                                <line x1="8" y1="10" x2="16" y2="10" />
                                <rect x="8" y="14" width="8" height="6" rx="1" />
                            </svg>
                            Scientific Calculator
                        </button>
                        <button onclick="switchTab('steam')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 2v4m0 0a4 4 0 1 1 0 8m0-8a4 4 0 1 0 0 8m0 0v8" />
                                <path d="M8 14s-2 2-2 4a4 4 0 0 0 8 0c0-2-2-4-2-4" />
                            </svg>
                            Steam Tables
                        </button>
                        <button onclick="switchTab('converter')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M7 16V4m0 0L3 8m4-4l4 4" />
                                <path d="M17 8v12m0 0l4-4m-4 4l-4-4" />
                            </svg>
                            Unit Converter
                        </button>
                        <button onclick="switchTab('fluids')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                            </svg>
                            Fluid Properties
                        </button>
                        <button onclick="switchTab('chemicals')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                                <circle cx="12" cy="5" r="1.5" />
                                <circle cx="17" cy="8" r="1.5" />
                                <circle cx="17" cy="16" r="1.5" />
                                <circle cx="12" cy="19" r="1.5" />
                                <circle cx="7" cy="16" r="1.5" />
                                <circle cx="7" cy="8" r="1.5" />
                            </svg>
                            Chemical Database
                        </button>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
                        <button onclick="switchTab('practice'); initPracticeMode();" class="tool-card"
                            style="cursor: pointer; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1)); border-color: #10b981;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981"
                                stroke-width="2">
                                <path d="M9 11l3 3L22 4" />
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                            </svg>
                            <span style="color: #10b981;">Unit Practice</span>
                        </button>
                    </div>
                </div>
                <div id="equationView" style="display:none;">
                    <div class="equation-header">
                        <h1 class="equation-title" id="eqTitle"></h1>
                        <p class="equation-description" id="eqDescription"></p>
                        <p class="equation-reference" id="eqReference"></p>
                        <div id="externalLinks" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px;">
                        </div>
                    </div>

                    <!-- Derivation Section (Collapsible) -->
                    <div class="collapsible-section" id="derivationSection" style="display: none;">
                        <button class="section-toggle" onclick="toggleSection('derivation')">
                            <span>ðŸ“ Equation Derivation</span>
                            <span class="toggle-icon" id="derivationIcon">â–¼</span>
                        </button>
                        <div class="section-content" id="derivationContent" style="display: none;"></div>
                    </div>

                    <!-- Worked Examples Section (Collapsible) -->
                    <div class="collapsible-section" id="examplesSection" style="display: none;">
                        <button class="section-toggle" onclick="toggleSection('examples')">
                            <span>ðŸ“ Worked Examples</span>
                            <span class="toggle-icon" id="examplesIcon">â–¼</span>
                        </button>
                        <div class="section-content" id="examplesContent" style="display: none;"></div>
                    </div>

                    <div class="input-section">
                        <h3 class="section-title">Inputs</h3>
                        <div class="input-grid" id="inputGrid"></div>
                    </div>
                    <button class="calculate-btn" id="calculateBtn" onclick="calculate()">
                        Calculate
                    </button>
                </div>
            </div><!-- End equationsTab -->

            <!-- Scientific Calculator Tab -->
            <div id="scientificTab" class="tab-content">
                <div class="sci-calculator">
                    <h2 style="margin: 0 0 15px 0; color: var(--text-primary);">Scientific Calculator</h2>
                    <div class="calc-display">
                        <div class="calc-history" id="calcHistory"></div>
                        <input type="text" class="calc-input" id="calcDisplay" value="0" readonly>
                    </div>
                    <div class="calc-buttons">
                        <!-- Row 1: Memory and Clear -->
                        <button class="calc-btn memory" onclick="calcMemory('MC')">MC</button>
                        <button class="calc-btn memory" onclick="calcMemory('MR')">MR</button>
                        <button class="calc-btn memory" onclick="calcMemory('M+')">M+</button>
                        <button class="calc-btn memory" onclick="calcMemory('M-')">Mâˆ’</button>
                        <button class="calc-btn clear" onclick="calcClear()">C</button>
                        <button class="calc-btn clear" onclick="calcBackspace()">âŒ«</button>
                        <!-- Row 2: Scientific -->
                        <button class="calc-btn function" onclick="calcFunction('sin')">sin</button>
                        <button class="calc-btn function" onclick="calcFunction('cos')">cos</button>
                        <button class="calc-btn function" onclick="calcFunction('tan')">tan</button>
                        <button class="calc-btn function" onclick="calcFunction('log')">log</button>
                        <button class="calc-btn function" onclick="calcFunction('ln')">ln</button>
                        <button class="calc-btn function" onclick="calcFunction('sqrt')">âˆš</button>
                        <!-- Row 3: More Scientific -->
                        <button class="calc-btn function" onclick="calcFunction('asin')">sinâ»Â¹</button>
                        <button class="calc-btn function" onclick="calcFunction('acos')">cosâ»Â¹</button>
                        <button class="calc-btn function" onclick="calcFunction('atan')">tanâ»Â¹</button>
                        <button class="calc-btn function" onclick="calcFunction('exp')">eË£</button>
                        <button class="calc-btn function" onclick="calcFunction('pow10')">10Ë£</button>
                        <button class="calc-btn function" onclick="calcFunction('square')">xÂ²</button>
                        <!-- Row 4: Constants and operators -->
                        <button class="calc-btn const" onclick="calcConst('pi')">Ï€</button>
                        <button class="calc-btn const" onclick="calcConst('e')">e</button>
                        <button class="calc-btn operator" onclick="calcOperator('(')">(</button>
                        <button class="calc-btn operator" onclick="calcOperator(')')">)</button>
                        <button class="calc-btn operator" onclick="calcOperator('^')">xÊ¸</button>
                        <button class="calc-btn operator" onclick="calcOperator('!')">n!</button>
                        <!-- Row 5: Numbers 7-9 and operators -->
                        <button class="calc-btn number" onclick="calcDigit('7')">7</button>
                        <button class="calc-btn number" onclick="calcDigit('8')">8</button>
                        <button class="calc-btn number" onclick="calcDigit('9')">9</button>
                        <button class="calc-btn operator" onclick="calcOperator('/')">Ã·</button>
                        <button class="calc-btn operator" onclick="calcOperator('%')">%</button>
                        <button class="calc-btn function" onclick="calcFunction('abs')">|x|</button>
                        <!-- Row 6: Numbers 4-6 -->
                        <button class="calc-btn number" onclick="calcDigit('4')">4</button>
                        <button class="calc-btn number" onclick="calcDigit('5')">5</button>
                        <button class="calc-btn number" onclick="calcDigit('6')">6</button>
                        <button class="calc-btn operator" onclick="calcOperator('*')">Ã—</button>
                        <button class="calc-btn function" onclick="calcFunction('inv')">1/x</button>
                        <button class="calc-btn function" onclick="calcFunction('negate')">Â±</button>
                        <!-- Row 7: Numbers 1-3 -->
                        <button class="calc-btn number" onclick="calcDigit('1')">1</button>
                        <button class="calc-btn number" onclick="calcDigit('2')">2</button>
                        <button class="calc-btn number" onclick="calcDigit('3')">3</button>
                        <button class="calc-btn operator" onclick="calcOperator('-')">âˆ’</button>
                        <button class="calc-btn equals" onclick="calcEquals()">=</button>
                        <button class="calc-btn function" onclick="calcToggleDegRad()">DEG</button>
                        <!-- Row 8: Zero and decimal -->
                        <button class="calc-btn number wide" onclick="calcDigit('0')">0</button>
                        <button class="calc-btn number" onclick="calcDigit('.')">.</button>
                        <button class="calc-btn operator" onclick="calcOperator('+')">+</button>
                        <button class="calc-btn function" onclick="calcAns()">ANS</button>
                    </div>
                    <div class="calc-info">
                        <span id="calcMode">DEG</span> | <span id="calcMemoryIndicator"></span>
                    </div>
                </div>
            </div>

            <!-- Steam Tables Tab -->
            <div id="steamTab" class="tab-content">
                <div class="reference-panel">
                    <h2>Steam Tables</h2>
                    <p class="ref-description">Saturated steam properties at common temperatures and pressures</p>
                    <div class="ref-controls">
                        <label>View by:
                            <select id="steamViewType" onchange="updateSteamTable()">
                                <option value="temp">Temperature</option>
                                <option value="pressure">Pressure</option>
                            </select>
                        </label>
                    </div>
                    <div class="ref-table-container">
                        <table class="ref-table" id="steamTable">
                            <thead>
                                <tr>
                                    <th>T (Â°C)</th>
                                    <th>P (kPa)</th>
                                    <th>vf (mÂ³/kg)</th>
                                    <th>vg (mÂ³/kg)</th>
                                    <th>hf (kJ/kg)</th>
                                    <th>hfg (kJ/kg)</th>
                                    <th>hg (kJ/kg)</th>
                                    <th>sf (kJ/kgÂ·K)</th>
                                    <th>sg (kJ/kgÂ·K)</th>
                                </tr>
                            </thead>
                            <tbody id="steamTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Fluid Properties Tab -->
            <div id="fluidsTab" class="tab-content">
                <div class="reference-panel">
                    <h2>Fluid Properties</h2>
                    <p class="ref-description">Common fluid properties at 25Â°C and 1 atm (unless noted)</p>
                    <div class="ref-controls">
                        <input type="text" id="fluidSearch" placeholder="Search fluids..." oninput="filterFluids()">
                    </div>
                    <div class="ref-table-container">
                        <table class="ref-table" id="fluidsTable">
                            <thead>
                                <tr>
                                    <th>Fluid</th>
                                    <th>Ï (kg/mÂ³)</th>
                                    <th>Î¼ (mPaÂ·s)</th>
                                    <th>Cp (kJ/kgÂ·K)</th>
                                    <th>k (W/mÂ·K)</th>
                                    <th>Tb (Â°C)</th>
                                    <th>Tc (Â°C)</th>
                                    <th>Pc (MPa)</th>
                                </tr>
                            </thead>
                            <tbody id="fluidsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Unit Converter Tab -->
            <div id="converterTab" class="tab-content">
                <div class="converter-panel">
                    <h2>ðŸ”„ Unit Converter</h2>
                    <p class="ref-description">Quick unit conversions for chemical engineering</p>

                    <div class="converter-layout">
                        <!-- Main Converter -->
                        <div class="converter-main">
                            <div class="converter-category-select">
                                <label>Category:</label>
                                <select id="convCategory" onchange="updateConversionUnits()">
                                    <option value="length">Length</option>
                                    <option value="mass">Mass</option>
                                    <option value="temperature">Temperature</option>
                                    <option value="pressure" selected>Pressure</option>
                                    <option value="flow">Flow Rate</option>
                                    <option value="volume">Volume</option>
                                    <option value="energy">Energy</option>
                                    <option value="power">Power</option>
                                    <option value="density">Density</option>
                                    <option value="viscosity">Viscosity</option>
                                    <option value="velocity">Velocity</option>
                                    <option value="area">Area</option>
                                </select>
                            </div>

                            <div class="converter-inputs">
                                <div class="conv-input-group">
                                    <label>From:</label>
                                    <input type="number" id="convFromValue" value="1" oninput="convertUnits()">
                                    <select id="convFromUnit" onchange="convertUnits()"></select>
                                </div>

                                <button class="swap-btn" onclick="swapUnits()" title="Swap units">â‡„</button>

                                <div class="conv-input-group">
                                    <label>To:</label>
                                    <input type="number" id="convToValue" readonly>
                                    <select id="convToUnit" onchange="convertUnits()"></select>
                                </div>
                            </div>

                            <div class="conv-formula" id="convFormula"></div>

                            <!-- Conversion History -->
                            <div class="conv-history">
                                <h4>Recent Conversions</h4>
                                <div id="convHistoryList"></div>
                            </div>
                        </div>

                        <!-- Quick Reference Cheat Sheet -->
                        <div class="cheat-sheet">
                            <h3>ðŸ“‹ ChemE Quick Reference</h3>

                            <div class="cheat-section">
                                <h4>Pressure</h4>
                                <div class="cheat-items">
                                    <div class="cheat-item" onclick="quickConvert('pressure', 1, 'atm', 'kPa')">1 atm =
                                        101.325 kPa</div>
                                    <div class="cheat-item" onclick="quickConvert('pressure', 1, 'bar', 'psi')">1 bar =
                                        14.504 psi</div>
                                    <div class="cheat-item" onclick="quickConvert('pressure', 1, 'psi', 'kPa')">1 psi =
                                        6.895 kPa</div>
                                    <div class="cheat-item" onclick="quickConvert('pressure', 1, 'mmHg', 'kPa')">1 mmHg
                                        = 0.133 kPa</div>
                                </div>
                            </div>

                            <div class="cheat-section">
                                <h4>Flow Rate</h4>
                                <div class="cheat-items">
                                    <div class="cheat-item" onclick="quickConvert('flow', 1, 'gpm', 'm3/h')">1 gpm =
                                        0.227 mÂ³/h</div>
                                    <div class="cheat-item" onclick="quickConvert('flow', 1, 'm3/h', 'gpm')">1 mÂ³/h =
                                        4.403 gpm</div>
                                    <div class="cheat-item" onclick="quickConvert('flow', 1, 'L/s', 'gpm')">1 L/s =
                                        15.85 gpm</div>
                                    <div class="cheat-item" onclick="quickConvert('flow', 1, 'bbl/day', 'm3/h')">1
                                        bbl/day = 0.00663 mÂ³/h</div>
                                </div>
                            </div>

                            <div class="cheat-section">
                                <h4>Energy & Power</h4>
                                <div class="cheat-items">
                                    <div class="cheat-item" onclick="quickConvert('energy', 1, 'BTU', 'kJ')">1 BTU =
                                        1.055 kJ</div>
                                    <div class="cheat-item" onclick="quickConvert('power', 1, 'hp', 'kW')">1 hp = 0.746
                                        kW</div>
                                    <div class="cheat-item" onclick="quickConvert('power', 1000000, 'BTU/hr', 'kW')">1
                                        MM BTU/hr = 293 kW</div>
                                </div>
                            </div>

                            <div class="cheat-section">
                                <h4>Density & Viscosity</h4>
                                <div class="cheat-items">
                                    <div class="cheat-item" onclick="quickConvert('density', 1, 'lb/ft3', 'kg/m3')">1
                                        lb/ftÂ³ = 16.02 kg/mÂ³</div>
                                    <div class="cheat-item" onclick="quickConvert('viscosity', 1, 'cP', 'PaÂ·s')">1 cP =
                                        0.001 PaÂ·s</div>
                                    <div class="cheat-item" onclick="quickConvert('viscosity', 1, 'cSt', 'mm2/s')">1 cSt
                                        = 1 mmÂ²/s</div>
                                </div>
                            </div>

                            <div class="cheat-section">
                                <h4>Temperature</h4>
                                <div class="cheat-items">
                                    <div class="cheat-item" onclick="quickConvert('temperature', 0, 'Â°C', 'Â°F')">0Â°C =
                                        32Â°F</div>
                                    <div class="cheat-item" onclick="quickConvert('temperature', 100, 'Â°C', 'Â°F')">100Â°C
                                        = 212Â°F</div>
                                    <div class="cheat-item" onclick="quickConvert('temperature', 25, 'Â°C', 'K')">25Â°C =
                                        298.15 K</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chemical Database Tab -->
            <div id="chemicalsTab" class="tab-content">
                <div class="ref-panel">
                    <h2>ðŸ§ª Chemical Database</h2>
                    <p class="ref-description">Thermophysical properties for common chemicals (DIPPR/NIST data)</p>
                    <div class="ref-controls">
                        <input type="text" id="chemSearch" placeholder="Search chemicals..."
                            oninput="filterChemicals()">
                        <select id="chemCategory" onchange="filterChemicals()">
                            <option value="all">All Categories</option>
                            <option value="alkane">Alkanes</option>
                            <option value="alcohol">Alcohols</option>
                            <option value="aromatic">Aromatics</option>
                            <option value="inorganic">Inorganics</option>
                            <option value="organic">Other Organics</option>
                        </select>
                    </div>
                    <div class="ref-table-container">
                        <table class="ref-table" id="chemicalsTable">
                            <thead>
                                <tr>
                                    <th>Chemical</th>
                                    <th>Formula</th>
                                    <th>MW</th>
                                    <th>Tb (Â°C)</th>
                                    <th>Tc (K)</th>
                                    <th>Pc (MPa)</th>
                                    <th>Ï‰</th>
                                    <th>Ï @ 25Â°C</th>
                                </tr>
                            </thead>
                            <tbody id="chemicalsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="chem-detail-panel" id="chemDetailPanel" style="display: none;">
                        <h3 id="chemDetailName"></h3>
                        <div class="chem-detail-grid" id="chemDetailGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Graphing Tools Tab -->
            <div id="graphingTab" class="tab-content">
                <div class="graphing-panel">
                    <h2>ðŸ“Š Engineering Graphing Tools</h2>
                    <p class="ref-description">Interactive graphs for process analysis and design</p>

                    <!-- Graph Type Selector -->
                    <div class="graph-selector">
                        <button class="graph-type-btn active" onclick="selectGraph('pid')">PID Response</button>
                        <button class="graph-type-btn" onclick="selectGraph('pump')">Pump Curves</button>
                        <button class="graph-type-btn" onclick="selectGraph('txy')">T-xy Diagram</button>
                        <button class="graph-type-btn" onclick="selectGraph('moody')">Moody Diagram</button>
                        <button class="graph-type-btn" onclick="selectGraph('phase')">Phase Diagram</button>
                        <button class="graph-type-btn" onclick="selectGraph('arrhenius')">Arrhenius Plot</button>
                        <button class="graph-type-btn" onclick="selectGraph('ntu')">Effectiveness-NTU</button>
                        <button class="graph-type-btn" onclick="selectGraph('bode')">Bode Plot</button>
                        <button class="graph-type-btn" onclick="selectGraph('heat')">Heat Curves</button>
                    </div>

                    <!-- PID Step Response -->
                    <div id="pidGraph" class="graph-container active">
                        <h3>Controller Step Response</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>Controller Type:</label>
                                <select id="pidType">
                                    <option value="P">P-Only</option>
                                    <option value="PI">PI Controller</option>
                                    <option value="PID" selected>PID Controller</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Process Gain (Kp):</label>
                                <input type="number" id="pidK" value="1" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Process Time Constant (Ï„p, s):</label>
                                <input type="number" id="pidTau" value="5" step="0.5">
                            </div>
                            <div class="input-group">
                                <label>Controller Gain (Kc):</label>
                                <input type="number" id="pidKc" value="2" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Integral Time (Ï„I, s):</label>
                                <input type="number" id="pidTauI" value="10" step="1">
                            </div>
                            <div class="input-group">
                                <label>Derivative Time (Ï„D, s):</label>
                                <input type="number" id="pidTauD" value="1" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Time Scale (s):</label>
                                <input type="number" id="pidTmax" value="50" step="10" min="10">
                            </div>
                            <div class="input-group">
                                <label>Setpoint Change:</label>
                                <input type="number" id="pidStep" value="1" step="0.1">
                            </div>
                            <button class="calculate-btn" onclick="plotPIDResponse()">Plot Response</button>
                        </div>
                        <div class="pid-metrics" id="pidMetrics"></div>
                        <div class="chart-wrapper">
                            <canvas id="pidChart"></canvas>
                        </div>
                    </div>

                    <!-- Pump System Curves -->
                    <div id="pumpGraph" class="graph-container">
                        <h3>Pump System Curves</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>Pump Shutoff Head (m):</label>
                                <input type="number" id="pumpH0" value="50" step="1">
                            </div>
                            <div class="input-group">
                                <label>Max Flow (mÂ³/h):</label>
                                <input type="number" id="pumpQmax" value="100" step="5">
                            </div>
                            <div class="input-group">
                                <label>Static Head (m):</label>
                                <input type="number" id="sysStatic" value="20" step="1">
                            </div>
                            <div class="input-group">
                                <label>System Resistance (K):</label>
                                <input type="number" id="sysK" value="0.002" step="0.0005">
                            </div>
                            <button class="calculate-btn" onclick="plotPumpCurves()">Plot Curves</button>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="pumpChart"></canvas>
                        </div>
                    </div>

                    <!-- T-xy Diagram -->
                    <div id="txyGraph" class="graph-container">
                        <h3>T-xy Diagram (Binary VLE)</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>System:</label>
                                <select id="txySystem" onchange="updateTxyParams()">
                                    <option value="benzene-toluene">Benzene-Toluene</option>
                                    <option value="methanol-water">Methanol-Water</option>
                                    <option value="ethanol-water">Ethanol-Water</option>
                                    <option value="acetone-water">Acetone-Water</option>
                                    <option value="hexane-ethanol">n-Hexane-Ethanol</option>
                                    <option value="propanol-water">n-Propanol-Water</option>
                                    <option value="acetone-chloroform">Acetone-Chloroform</option>
                                    <option value="pentane-hexane">n-Pentane-n-Hexane</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Pressure (kPa):</label>
                                <input type="number" id="txyP" value="101.325" step="1">
                            </div>
                            <div class="input-group">
                                <label>Feed Composition (zF):</label>
                                <input type="number" id="txyXf" value="0.5" step="0.05" min="0" max="1">
                            </div>
                            <div class="input-group">
                                <label>Feed Temperature (Â°C):</label>
                                <input type="number" id="txyTf" value="90" step="1">
                            </div>
                            <button class="calculate-btn" onclick="plotTxy()">Plot Diagram</button>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="txyChart"></canvas>
                        </div>
                    </div>

                    <!-- Moody Diagram -->
                    <div id="moodyGraph" class="graph-container">
                        <h3>Moody Diagram</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>Reynolds Number:</label>
                                <input type="number" id="moodyRe" value="100000" step="10000">
                            </div>
                            <div class="input-group">
                                <label>Relative Roughness (Îµ/D):</label>
                                <input type="number" id="moodyED" value="0.001" step="0.0001">
                            </div>
                            <button class="calculate-btn" onclick="plotMoody()">Plot & Find f</button>
                        </div>
                        <div class="moody-result" id="moodyResult"></div>
                        <div class="chart-wrapper">
                            <canvas id="moodyChart"></canvas>
                        </div>
                    </div>

                    <!-- Phase Diagram -->
                    <div id="phaseGraph" class="graph-container">
                        <h3>Phase Diagram (T-P)</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>Substance:</label>
                                <select id="phaseSubstance" onchange="updatePhaseParams()">
                                    <option value="water">Water</option>
                                    <option value="co2">Carbon Dioxide</option>
                                    <option value="ammonia">Ammonia</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Temperature (K):</label>
                                <input type="number" id="phaseT" value="300" step="10">
                            </div>
                            <div class="input-group">
                                <label>Pressure (kPa):</label>
                                <input type="number" id="phaseP" value="101.325" step="10">
                            </div>
                            <button class="calculate-btn" onclick="plotPhase()">Plot Diagram</button>
                        </div>
                        <div class="moody-result" id="phaseResult"></div>
                        <div class="chart-wrapper">
                            <canvas id="phaseChart"></canvas>
                        </div>
                    </div>

                    <!-- Arrhenius Plot -->
                    <div id="arrheniusGraph" class="graph-container">
                        <h3>Arrhenius Plot (ln k vs 1/T)</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>Pre-exponential (A, sâ»Â¹):</label>
                                <input type="number" id="arrA" value="1e13" step="1e12">
                            </div>
                            <div class="input-group">
                                <label>Activation Energy (Ea, kJ/mol):</label>
                                <input type="number" id="arrEa" value="80" step="5">
                            </div>
                            <div class="input-group">
                                <label>T min (K):</label>
                                <input type="number" id="arrTmin" value="300" step="10">
                            </div>
                            <div class="input-group">
                                <label>T max (K):</label>
                                <input type="number" id="arrTmax" value="600" step="10">
                            </div>
                            <button class="calculate-btn" onclick="plotArrhenius()">Plot</button>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="arrheniusChart"></canvas>
                        </div>
                    </div>

                    <!-- Effectiveness-NTU -->
                    <div id="ntuGraph" class="graph-container">
                        <h3>Heat Exchanger Effectiveness-NTU</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>HX Type:</label>
                                <select id="ntuType">
                                    <option value="counterflow">Counterflow</option>
                                    <option value="parallelflow">Parallel Flow</option>
                                    <option value="shell1">Shell & Tube (1 shell)</option>
                                    <option value="crossflow">Crossflow (unmixed)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Capacity Ratio (Cr):</label>
                                <input type="number" id="ntuCr" value="0.5" step="0.1" min="0" max="1">
                            </div>
                            <div class="input-group">
                                <label>NTU (to calculate):</label>
                                <input type="number" id="ntuValue" value="2" step="0.5">
                            </div>
                            <button class="calculate-btn" onclick="plotNTU()">Plot Curves</button>
                        </div>
                        <div class="moody-result" id="ntuResult"></div>
                        <div class="chart-wrapper">
                            <canvas id="ntuChart"></canvas>
                        </div>
                    </div>

                    <!-- Bode Plot -->
                    <div id="bodeGraph" class="graph-container">
                        <h3>Bode Plot (Frequency Response)</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>Process Gain (K):</label>
                                <input type="number" id="bodeK" value="2" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Time Constant (Ï„, s):</label>
                                <input type="number" id="bodeTau" value="5" step="0.5">
                            </div>
                            <div class="input-group">
                                <label>Dead Time (Î¸, s):</label>
                                <input type="number" id="bodeTheta" value="1" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Order:</label>
                                <select id="bodeOrder">
                                    <option value="1">First Order</option>
                                    <option value="2">Second Order</option>
                                </select>
                            </div>
                            <button class="calculate-btn" onclick="plotBode()">Plot</button>
                        </div>
                        <div class="chart-wrapper" style="display: flex; gap: 20px;">
                            <div style="flex: 1;"><canvas id="bodeMagChart"></canvas></div>
                            <div style="flex: 1;"><canvas id="bodePhaseChart"></canvas></div>
                        </div>
                    </div>

                    <!-- Heat Curves -->
                    <div id="heatGraph" class="graph-container">
                        <h3>Heat Curves (Pinch Analysis)</h3>
                        <div class="graph-controls">
                            <div class="input-group">
                                <label>Hot Stream Inlet (Â°C):</label>
                                <input type="number" id="heatThi" value="200" step="10">
                            </div>
                            <div class="input-group">
                                <label>Hot Stream Outlet (Â°C):</label>
                                <input type="number" id="heatTho" value="80" step="10">
                            </div>
                            <div class="input-group">
                                <label>Cold Stream Inlet (Â°C):</label>
                                <input type="number" id="heatTci" value="30" step="10">
                            </div>
                            <div class="input-group">
                                <label>Cold Stream Outlet (Â°C):</label>
                                <input type="number" id="heatTco" value="150" step="10">
                            </div>
                            <div class="input-group">
                                <label>Heat Duty (kW):</label>
                                <input type="number" id="heatQ" value="500" step="50">
                            </div>
                            <button class="calculate-btn" onclick="plotHeatCurves()">Plot</button>
                        </div>
                        <div class="moody-result" id="heatResult"></div>
                        <div class="chart-wrapper">
                            <canvas id="heatChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unit Practice Tab -->
            <div id="practiceTab" class="tab-content">
                <div class="practice-panel">
                    <h2
                        style="color: var(--accent-light); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                        <span>ðŸŽ¯</span> Unit Conversion Practice
                    </h2>
                    <p style="color: var(--text-secondary); margin-bottom: 30px;">
                        Test your unit conversion skills! Practice common engineering unit conversions with instant
                        feedback.
                    </p>
                    <div id="practiceContent">
                        <div class="empty-state">
                            <p>Loading practice problems...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Results Panel -->
        <aside class="results-panel">
            <h3 class="results-header">Results</h3>
            <label class="comparison-toggle">
                <input type="checkbox" onchange="toggleComparison(this)">
                Compare with previous
            </label>
            <div id="resultsContent">
                <div class="empty-state">
                    <p>Run a calculation to see results</p>
                </div>
            </div>
    </div>

    <div id="chartSection" style="display:none; margin-top: 20px;">
        <h4 style="font-size: 0.9rem; color: var(--accent); margin-bottom: 10px;">Sensitivity Analysis</h4>
        <canvas id="sensitivityChart" style="max-height: 250px;"></canvas>
    </div>
    <div id="chartActions" style="display:none; margin-top: 15px;">
        <button class="calculate-btn" style="padding: 10px; font-size: 0.85rem;" onclick="runSensitivity()">
            ðŸ“Š Run Sensitivity Analysis
        </button>
    </div>
    </aside>
    </div>

    <!-- ChemE Fact - Fixed to viewport bottom right -->
    <div class="tips-carousel" id="tipsCarousel">
        <div class="tip-label">ðŸ’¡ Science Fact</div>
        <!-- Chemical Engineering Facts (1-20) -->
        <div class="tip active">
            <div class="tip-text">The Haber process for ammonia synthesis operates at 400-500Â°C and 150-300 atm,
                producing 150 million tons annually.</div>
        </div>
        <div class="tip">
            <div class="tip-text">A typical oil refinery can process up to 600,000 barrels of crude oil per day into
                gasoline, diesel, and jet fuel.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The Reynolds number (Re > 4000) determines turbulent flow - discovered by Osborne
                Reynolds in 1883.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Distillation accounts for ~40% of all energy used in chemical processing. Heat
                integration can cut this in half.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Bioreactors can produce 200+ grams of monoclonal antibodies per liter - up from
                milligrams in the 1980s.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The CSTR (Continuous Stirred Tank Reactor) achieves perfect mixing - exit stream
                composition equals tank composition.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Catalytic cracking was invented in 1942 and revolutionized gasoline production,
                doubling yields from crude oil.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Heat exchangers can achieve effectiveness >95% using counterflow design vs ~60% for
                parallel flow.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The Fischer-Tropsch process converts syngas (CO + Hâ‚‚) into liquid fuels - developed in
                1920s Germany.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Membrane separation uses 90% less energy than thermal desalination for seawater
                purification.</div>
        </div>
        <div class="tip">
            <div class="tip-text">PID controllers (Proportional-Integral-Derivative) control over 95% of industrial
                control loops.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The Clausius-Clapeyron equation relates vapor pressure to temperature - essential for
                distillation design.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Fluidized beds provide 100x better heat transfer than packed beds due to particle
                motion.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The Arrhenius equation shows reaction rates double roughly every 10Â°C temperature
                increase.</div>
        </div>
        <div class="tip">
            <div class="tip-text">NPSH (Net Positive Suction Head) must exceed vapor pressure to prevent pump cavitation
                damage.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Polyethylene is the world's most produced plastic at 100+ million tons per year.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The ideal gas law PV=nRT was formulated in 1834, combining Boyle's, Charles's, and
                Avogadro's laws.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Steam reforming of natural gas produces 95% of the world's hydrogen supply.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The McCabe-Thiele method graphically designs distillation columns using equilibrium
                and operating lines.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Industrial crystallizers can produce 99.99% pure products through controlled
                nucleation and growth.</div>
        </div>
        <!-- Chemistry Facts (21-35) -->
        <div class="tip">
            <div class="tip-text">Water has an unusually high heat capacity (4.18 kJ/kgÂ·K), making it excellent for
                industrial cooling.</div>
        </div>
        <div class="tip">
            <div class="tip-text">A single mole contains 6.022 Ã— 10Â²Â³ particles - Avogadro's number, determined in 1909.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">Diamond and graphite are both pure carbon - only their crystal structure differs.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">The pH scale is logarithmic: pH 4 is 10 times more acidic than pH 5, and 100x more
                than pH 6.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Helium was discovered in the Sun's spectrum (1868) before being found on Earth (1895).
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">The triple point of water (273.16 K) is used to define the Kelvin temperature scale.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">Fluorine is the most electronegative element - it will react with almost everything,
                including glass.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The human body contains about 7Ã—10Â¹â¸ atoms of gold - about 0.2 milligrams total.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Gallium melts at 29.76Â°C - it will literally melt in your hand.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The lightest element (hydrogen) comprises 75% of all normal matter in the universe.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">Sulfuric acid is the most-produced chemical worldwide at 200+ million tons per year.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">A hydrogen bond is ~20x weaker than a covalent bond, but strong enough to make water
                liquid at room temperature.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Buckminsterfullerene (Câ‚†â‚€) resembles a soccer ball and was discovered in 1985, earning
                a Nobel Prize.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Noble gases were called "inert" until 1962 when Neil Bartlett made the first xenon
                compound.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The periodic table was independently proposed by Mendeleev and Meyer in 1869.</div>
        </div>
        <!-- Physics Facts (36-50) -->
        <div class="tip">
            <div class="tip-text">The Navier-Stokes equations governing fluid flow remain one of the Millennium Prize
                Problems in mathematics.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Absolute zero (0 K = -273.15Â°C) is impossible to reach due to the third law of
                thermodynamics.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The speed of light (299,792,458 m/s) is now used to define the meter itself.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Entropy always increases in an isolated system - the second law of thermodynamics.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">The Stefan-Boltzmann law: radiative heat transfer scales with Tâ´, making high
                temperatures extreme.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Bernoulli's principle explains why airplane wings generate lift and venturi meters
                measure flow.</div>
        </div>
        <div class="tip">
            <div class="tip-text">Supercritical COâ‚‚ (>31Â°C, >7.4 MPa) is used for decaffeinating coffee and dry
                cleaning.</div>
        </div>
        <div class="tip">
            <div class="tip-text">One atmosphere of pressure (101.325 kPa) equals the weight of a 10.3 meter column of
                water.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The Carnot efficiency sets the theoretical maximum for heat engines: Î· = 1 - Tâ‚—/Tâ‚•.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">Sound travels faster in solids (~5000 m/s in steel) than in air (~343 m/s) or water
                (~1500 m/s).</div>
        </div>
        <div class="tip">
            <div class="tip-text">Viscosity of honey is about 10,000x higher than water - both are Newtonian fluids.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">Surface tension allows water striders to walk on water - caused by hydrogen bonding.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">The Joule-Thomson effect cools most gases when expanded - the basis of refrigeration.
            </div>
        </div>
        <div class="tip">
            <div class="tip-text">Fourier's law of heat conduction: Q = -kA(dT/dx), proposed in 1822.</div>
        </div>
        <div class="tip">
            <div class="tip-text">The Boltzmann constant k = 1.38Ã—10â»Â²Â³ J/K links temperature to molecular kinetic
                energy.</div>
        </div>
    </div>


    <script>
        const API_BASE = '';
        let currentCategory = null;
        let currentEquation = null;
        let equationParams = [];
        let previousResult = null;
        let comparisonMode = false;
        let equationCache = {};

        // ===== Wikipedia URL Mapping =====
        const wikipediaUrls = {
            // Process Control
            'ziegler_nichols_pid': 'Ziegler%E2%80%93Nichols_method',
            'cohen_coon_pid': 'PID_controller#Loop_tuning',
            'imc_pid': 'Internal_model_control',
            'tyreus_luyben_pid': 'PID_controller#Tyreus%E2%80%93Luyben_tuning',
            'cv_liquid': 'Control_valve#Valve_coefficient',
            'cv_gas': 'Control_valve#Valve_coefficient',
            'gain_margin': 'Gain_margin',
            'phase_margin': 'Phase_margin',
            'fopdt_model': 'PID_controller#FOPDT_model',
            'cascade_control': 'Cascade_control',
            'feedforward_control': 'Feed-forward_(control)',
            // Fluid Dynamics
            'reynolds_number': 'Reynolds_number',
            'bernoulli': 'Bernoulli%27s_principle',
            'orifice_flow': 'Orifice_plate',
            'friction_factor': 'Darcy_friction_factor',
            'darcy_weisbach': 'Darcy%E2%80%93Weisbach_equation',
            'hazen_williams': 'Hazen%E2%80%93Williams_equation',
            'pump_power': 'Pump#Pump_power',
            'npsh': 'Net_positive_suction_head',
            'cavitation': 'Cavitation',
            // Heat Transfer
            'lmtd': 'Log_mean_temperature_difference',
            'hx_area': 'Heat_exchanger#Design',
            'heat_duty': 'Heat_transfer',
            'ntu_eff': 'NTU_method',
            'overall_u': 'Thermal_contact_conductance',
            'convection_coeff': 'Convective_heat_transfer#Dittus%E2%80%93Boelter_correlation',
            // Thermodynamics
            'antoine': 'Antoine_equation',
            'clausius_clapeyron': 'Clausius%E2%80%93Clapeyron_relation',
            'ideal_gas': 'Ideal_gas_law',
            'compressibility': 'Compressibility_factor',
            'raoults_law': 'Raoult%27s_law',
            'henrys_law': 'Henry%27s_law',
            // Mass Transfer
            'ficks_law': 'Fick%27s_laws_of_diffusion',
            'mass_transfer_coeff': 'Mass_transfer_coefficient',
            'sherwood': 'Sherwood_number',
            'schmidt': 'Schmidt_number',
            // Reaction Kinetics
            'arrhenius': 'Arrhenius_equation',
            'first_order': 'First-order_reaction',
            'second_order': 'Second-order_reaction',
            'half_life': 'Half-life',
            // Distillation
            'mccabe_thiele': 'McCabe%E2%80%93Thiele_method',
            'fenske_equation': 'Fenske_equation',
            'underwood_equation': 'Underwood_equation',
            'relative_volatility': 'Relative_volatility',
            // Safety
            'relief_valve': 'Relief_valve',
            'fire_case': 'Process_safety#Fire_scenarios',
            'tnteq': 'TNT_equivalent',
            // Economics
            'npv': 'Net_present_value',
            'irr': 'Internal_rate_of_return',
            'payback': 'Payback_period',
            'cepci': 'Chemical_Engineering_Plant_Cost_Index',
            // Default fallback
            'default': null
        };

        function getWikipediaUrl(equationId, equationName) {
            if (wikipediaUrls[equationId]) {
                return `https://en.wikipedia.org/wiki/${wikipediaUrls[equationId]}`;
            }
            // Fallback to search if no mapping exists
            return `https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(equationName + ' chemical engineering')}`;
        }

        // ===== Chemical Engineering Tips =====
        const chemEngTips = [
            { icon: "ðŸ§ª", text: "The Haber process for ammonia synthesis operates at 400-500Â°C and 150-300 atm, producing 150 million tons annually worldwide." },
            { icon: "âš—ï¸", text: "A typical oil refinery can process up to 600,000 barrels of crude oil per day into gasoline, diesel, and jet fuel." },
            { icon: "ðŸ”¬", text: "The Reynolds number (Re > 4000) determines turbulent flow - discovered by Osborne Reynolds in 1883." },
            { icon: "ðŸ’§", text: "Water has an unusually high heat capacity (4.18 kJ/kgÂ·K), making it excellent for industrial cooling." },
            { icon: "ðŸ­", text: "The first commercial petrochemical plant opened in 1920 in the US, producing isopropyl alcohol." },
            { icon: "âš¡", text: "Electrolysis of water requires 237 kJ/mol, but fuel cells can recover up to 83% of this energy." },
            { icon: "ðŸŒ¡ï¸", text: "Absolute zero (-273.15Â°C) is theoretically unreachable - the closest achieved is 100 picoKelvin." },
            { icon: "ðŸ”„", text: "Distillation accounts for ~40% of all energy used in chemical processing. Heat integration can cut this in half." },
            { icon: "ðŸ“Š", text: "The Navier-Stokes equations governing fluid flow remain one of the Millennium Prize Problems in mathematics." },
            { icon: "ðŸŽ¯", text: "Six Sigma quality (3.4 defects per million) was pioneered by Motorola and adopted industry-wide." },
            { icon: "ðŸ’¨", text: "Supersonic wind tunnels can simulate speeds up to Mach 10 (12,350 km/h) for aerospace testing." },
            { icon: "ðŸ§¬", text: "Bioreactors can produce 200+ grams of monoclonal antibodies per liter - up from milligrams in the 1980s." },
        ];
        let currentTipIndex = 0;

        // ===== Theme Toggle =====
        function toggleTheme() {
            const body = document.body;
            const btn = document.querySelector('.theme-toggle');
            body.classList.toggle('light-mode');
            btn.textContent = body.classList.contains('light-mode') ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('theme', body.classList.contains('light-mode') ? 'light' : 'dark');
        }

        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.body.classList.add('light-mode');
                document.querySelector('.theme-toggle').textContent = 'â˜€ï¸';
            }
        }

        // ===== Calculation Counter =====
        function updateCalcCounter() {
            const today = new Date().toDateString();
            let data = JSON.parse(localStorage.getItem('calcStats') || '{}');
            if (data.date !== today) {
                data = { date: today, count: 0 };
            }
            data.count++;
            localStorage.setItem('calcStats', JSON.stringify(data));
            document.getElementById('calcCount').textContent = data.count;
        }

        function loadCalcCounter() {
            const today = new Date().toDateString();
            let data = JSON.parse(localStorage.getItem('calcStats') || '{}');
            if (data.date !== today) {
                data = { date: today, count: 0 };
            }
            document.getElementById('calcCount').textContent = data.count;
        }

        // ===== Mobile Menu Toggle =====
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');

            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            menuBtn.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');

            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            menuBtn.classList.remove('active');
        }

        // Close mobile menu when selecting an equation
        document.addEventListener('click', function (e) {
            if (e.target.closest('.equation-item')) {
                closeMobileMenu();
            }
        });

        // ===== Calculation History =====
        function saveToHistory(equationId, inputs, outputs) {
            const key = `history_${equationId}`;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            history.unshift({
                timestamp: new Date().toISOString(),
                inputs: inputs,
                outputs: outputs
            });
            history = history.slice(0, 10); // Keep last 10
            localStorage.setItem(key, JSON.stringify(history));
        }

        function loadFromHistory(equationId, index) {
            const key = `history_${equationId}`;
            const history = JSON.parse(localStorage.getItem(key) || '[]');
            if (history[index]) {
                const entry = history[index];
                for (const [name, data] of Object.entries(entry.inputs)) {
                    const input = document.getElementById(`input_${name}`);
                    const unit = document.getElementById(`unit_${name}`);
                    if (input) input.value = data.value;
                    if (unit && data.unit) unit.value = data.unit;
                }
            }
        }

        function getHistory(equationId) {
            const key = `history_${equationId}`;
            return JSON.parse(localStorage.getItem(key) || '[]');
        }

        // ===== Copy to Clipboard =====
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('copyToast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }

        // ===== Input Validation =====
        function validateInput(inputEl, param) {
            const value = parseFloat(inputEl.value);
            inputEl.classList.remove('valid', 'warning', 'invalid');

            if (isNaN(value)) return;

            if (param.typical_range && param.typical_range.length === 2) {
                const [min, max] = param.typical_range;
                const range = max - min;
                const edgeBuffer = range * 0.1;

                if (value < min || value > max) {
                    inputEl.classList.add('invalid');
                } else if (value < min + edgeBuffer || value > max - edgeBuffer) {
                    inputEl.classList.add('warning');
                } else {
                    inputEl.classList.add('valid');
                }
            }
        }

        function setupInputValidation() {
            for (const param of equationParams) {
                const inputEl = document.getElementById(`input_${param.name}`);
                if (inputEl && param.typical_range) {
                    inputEl.addEventListener('input', () => validateInput(inputEl, param));
                }
            }
        }

        // ===== Tips Carousel =====
        function rotateTip() {
            const tips = document.querySelectorAll('.tips-carousel .tip');
            if (tips.length === 0) return;

            tips.forEach(t => t.classList.remove('active'));
            currentTipIndex = (currentTipIndex + 1) % tips.length;
            tips[currentTipIndex].classList.add('active');
        }

        function initTipsCarousel() {
            setInterval(rotateTip, 20000);
        }

        // ===== Comparison Mode Toggle =====
        function toggleComparison(checkbox) {
            comparisonMode = checkbox.checked;
            if (lastResult) {
                displayResultsEnhanced(lastResult);
            }
        }


        // Load categories on page load
        let equationsWithLearning = new Set();
        let learningDifficulties = {};

        async function loadCategories() {
            // Fetch categories
            const response = await fetch(`${API_BASE}/api/categories`);
            const categories = await response.json();

            // Fetch equations with learning content
            try {
                const learningResponse = await fetch(`${API_BASE}/api/learning/equations-with-content`);
                const learningEquations = await learningResponse.json();
                equationsWithLearning = new Set(learningEquations.map(e => e.id));
                learningEquations.forEach(e => {
                    learningDifficulties[e.id] = e.difficulty;
                });
            } catch (e) {
                console.log('Learning content API not available');
            }

            // Get learning progress for category completion indicators
            const progress = getLearningProgress ? getLearningProgress() : { completed: [] };
            const completedSet = new Set(progress.completed || []);

            const container = document.getElementById('categoryList');
            container.innerHTML = categories.map((cat, index) => {
                const catId = cat.name.toLowerCase().replace(/ /g, '_');

                // Calculate category learning progress
                const catEquations = cat.equations.map(eq => eq.id);
                const completedInCat = catEquations.filter(id => completedSet.has(id)).length;
                const withLearningInCat = catEquations.filter(id => equationsWithLearning.has(id)).length;
                const progressPct = withLearningInCat > 0 ? (completedInCat / withLearningInCat) * 100 : 0;

                return `
                <div class="category ${index === 0 ? 'expanded' : ''}" data-category="${catId}">
                    <div class="category-header" onclick="toggleCategory(this)">
                        ${cat.name}
                        <span class="category-count">${cat.equation_count}</span>
                    </div>
                    ${withLearningInCat > 0 ? `
                        <div class="category-progress">
                            <div class="category-progress-fill" style="width: ${progressPct}%"></div>
                        </div>
                    ` : ''}
                    <div class="equations">
                        ${cat.equations.map(eq => {
                    const hasLearning = equationsWithLearning.has(eq.id);
                    const difficulty = learningDifficulties[eq.id];
                    const difficultyBadge = hasLearning && difficulty ?
                        `<span class="difficulty-badge ${difficulty}">${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}</span>` : '';
                    const learningBadge = hasLearning ?
                        '<span class="learning-badge">ðŸ“š Learn</span>' : '';

                    return `
                            <div class="equation-item ${completedSet.has(eq.id) ? 'completed' : ''}" 
                                 data-equation-id="${eq.id}"
                                 onclick="selectEquation('${catId}', '${eq.id}')"
                                 onmouseenter="showEquationPreview(this, '${catId}', '${eq.id}')">
                                ${eq.name}
                                ${learningBadge}
                                ${difficultyBadge}
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `}).join('');
        }

        function toggleCategory(header) {
            const category = header.parentElement;
            category.classList.toggle('expanded');
        }

        async function selectEquation(category, equationId) {
            currentCategory = category;
            currentEquation = equationId;

            // Switch to equations tab if not already there
            switchTab('equations');

            // Update active state
            document.querySelectorAll('.equation-item').forEach(el => el.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');

            // Fetch equation details
            const response = await fetch(`${API_BASE}/api/equations/${category}/${equationId}`);
            const eq = await response.json();

            document.getElementById('welcomeState').style.display = 'none';
            document.getElementById('equationView').style.display = 'block';

            document.getElementById('eqTitle').textContent = eq.name;
            document.getElementById('eqDescription').textContent = eq.description;
            document.getElementById('eqReference').textContent = `Reference: ${eq.reference}`;

            // Add external resource links
            const searchQuery = encodeURIComponent(`${eq.name} chemical engineering`);
            document.getElementById('externalLinks').innerHTML = `
                <a href="https://www.google.com/search?q=${searchQuery}" target="_blank" class="reference-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    Search Google
                </a>
                <a href="${getWikipediaUrl(equationId, eq.name)}" target="_blank" class="reference-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="m2 17 10 5 10-5"/><path d="m2 12 10 5 10-5"/>
                    </svg>
                    Wikipedia
                </a>
                <a href="https://scholar.google.com/scholar?q=${searchQuery}" target="_blank" class="reference-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    Google Scholar
                </a>
            `;

            // Build input form
            equationParams = eq.parameters.filter(p => p.param_type === 'input');
            const inputGrid = document.getElementById('inputGrid');
            inputGrid.innerHTML = equationParams.map(param => {
                // Build unit options - use unit_options array if available, otherwise just default
                const unitOptions = (param.unit_options && param.unit_options.length > 0)
                    ? param.unit_options
                    : (param.unit ? [param.unit] : ['']);
                const optionsHtml = unitOptions.map(u =>
                    `<option value="${u}" ${u === param.unit ? 'selected' : ''}>${u || 'â€”'}</option>`
                ).join('');

                return `
                <div class="input-group">
                    <label class="input-label ${param.tooltip ? 'tooltip' : ''}" ${param.tooltip ? `data-tooltip="${param.tooltip}"` : ''}>
                        <span class="symbol">${param.symbol}</span>
                    </label>
                    <input type="number" class="input-field" id="input_${param.name}" 
                           placeholder="${param.description}" step="any">
                    <select class="unit-select" id="unit_${param.name}">
                        ${optionsHtml}
                    </select>
                </div>
            `}).join('');

            // Clear results
            document.getElementById('resultsContent').innerHTML = `
                <div class="empty-state">
                    <p>Enter values and click Calculate</p>
                </div>
            `;

            // Render history dropdown if there's history for this equation
            setTimeout(() => renderHistoryDropdown(), 100);

            // Setup input validation
            setupInputValidation();

            // Render derivation and examples if available
            document.getElementById('derivationSection').style.display = 'none';
            document.getElementById('examplesSection').style.display = 'none';
            document.getElementById('derivationContent').style.display = 'none';
            document.getElementById('examplesContent').style.display = 'none';
            document.getElementById('derivationIcon').classList.remove('rotated');
            document.getElementById('examplesIcon').classList.remove('rotated');

            if (eq.derivation) {
                renderDerivation(eq.derivation);
            }
            if (eq.examples && eq.examples.length > 0) {
                currentExamples = eq.examples;
                renderExamples(eq.examples);
            }
        }

        async function calculate() {
            const btn = document.getElementById('calculateBtn');
            btn.disabled = true;
            btn.textContent = 'Calculating...';

            // Gather inputs
            const inputs = {};
            for (const param of equationParams) {
                const valueEl = document.getElementById(`input_${param.name}`);
                const unitEl = document.getElementById(`unit_${param.name}`);
                const value = parseFloat(valueEl.value);

                if (!isNaN(value)) {
                    inputs[param.name] = {
                        value: value,
                        unit: unitEl.value || ''
                    };
                }
            }

            try {
                const response = await fetch(`${API_BASE}/api/calculate/${currentCategory}/${currentEquation}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputs })
                });
                const result = await response.json();
                displayResults(result);
            } catch (error) {
                displayResults({ success: false, error: error.message });
            }

            btn.disabled = false;
            btn.textContent = 'Calculate';
        }

        // Store current calculation results for unit conversion
        let lastCalculationResult = null;
        let lastCalculationOutputs = {};

        function displayResults(result) {
            const container = document.getElementById('resultsContent');

            if (!result.success) {
                container.innerHTML = `
                    <div class="validation-badge fail">âŒ Error</div>
                    <p>${result.error || 'Calculation failed'}</p>
                `;
                return;
            }

            lastCalculationResult = result;
            lastCalculationOutputs = JSON.parse(JSON.stringify(result.outputs));

            let html = '';

            // Validation badge
            if (result.validation_status) {
                const status = result.validation_status.toLowerCase();
                const icon = status === 'pass' ? 'âœ“' : status === 'warning' ? 'âš ' : 'âœ—';
                html += `<div class="validation-badge ${status}">${icon} ${result.validation_status}</div>`;
            }

            // Output cards with unit conversion dropdown
            for (const [name, data] of Object.entries(result.outputs)) {
                const value = formatResultValue(data.value);
                const unitOptions = getUnitOptionsForUnit(data.unit);

                html += `
                    <div class="result-card" data-output-name="${name}" data-base-value="${data.value}" data-base-unit="${data.unit || ''}">
                        <div class="result-name">${name}</div>
                        <div class="result-value">
                            <span class="result-number" id="val_${name}">${value}</span>
                            ${unitOptions.length > 1 ? `
                                <select class="result-unit-select" onchange="convertResultUnit('${name}', this.value)">
                                    ${unitOptions.map(u => `<option value="${u}" ${u === data.unit ? 'selected' : ''}>${u || 'â€”'}</option>`).join('')}
                                </select>
                            ` : `<span class="result-unit">${data.unit || ''}</span>`}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Save to localStorage for persistence
            saveResultsToStorage(result);
        }

        function formatResultValue(value) {
            if (typeof value === 'number') {
                if (Math.abs(value) < 0.001 && value !== 0) return value.toExponential(4);
                if (Math.abs(value) > 10000) return value.toExponential(4);
                return value.toFixed(4);
            }
            return value;
        }

        // Unit conversion mapping for result outputs
        const resultUnitConversions = {
            // Pressure
            'psi': { group: 'pressure', toBase: 6.89476 },
            'kPa': { group: 'pressure', toBase: 1 },
            'bar': { group: 'pressure', toBase: 100 },
            'atm': { group: 'pressure', toBase: 101.325 },
            'Pa': { group: 'pressure', toBase: 0.001 },
            'MPa': { group: 'pressure', toBase: 1000 },
            // Length/Distance
            'ft': { group: 'length', toBase: 0.3048 },
            'm': { group: 'length', toBase: 1 },
            'in': { group: 'length', toBase: 0.0254 },
            'cm': { group: 'length', toBase: 0.01 },
            'mm': { group: 'length', toBase: 0.001 },
            // Velocity
            'ft/s': { group: 'velocity', toBase: 0.3048 },
            'm/s': { group: 'velocity', toBase: 1 },
            'm/min': { group: 'velocity', toBase: 0.01667 },
            // Flow
            'gpm': { group: 'flow', toBase: 0.227125 },
            'm3/h': { group: 'flow', toBase: 1 },
            'mÂ³/h': { group: 'flow', toBase: 1 },
            'L/s': { group: 'flow', toBase: 3.6 },
            'L/min': { group: 'flow', toBase: 0.06 },
            // Power
            'hp': { group: 'power', toBase: 0.7457 },
            'kW': { group: 'power', toBase: 1 },
            'W': { group: 'power', toBase: 0.001 },
            'BTU/hr': { group: 'power', toBase: 0.000293071 },
            // Dimensionless
            '': { group: 'dimensionless', toBase: 1 },
        };

        function getUnitOptionsForUnit(unit) {
            if (!unit || unit === '') return [''];
            const conv = resultUnitConversions[unit];
            if (!conv) return [unit];
            const group = conv.group;
            return Object.entries(resultUnitConversions)
                .filter(([u, c]) => c.group === group && u !== '')
                .map(([u]) => u);
        }

        function convertResultUnit(outputName, newUnit) {
            const card = document.querySelector(`[data-output-name="${outputName}"]`);
            if (!card) return;

            const baseValue = parseFloat(card.dataset.baseValue);
            const baseUnit = card.dataset.baseUnit;

            if (isNaN(baseValue) || !baseUnit || !newUnit) return;

            const fromConv = resultUnitConversions[baseUnit];
            const toConv = resultUnitConversions[newUnit];

            if (!fromConv || !toConv || fromConv.group !== toConv.group) {
                console.warn('Unit conversion not possible:', baseUnit, newUnit);
                return;
            }

            // Convert: value_in_base_SI = original * fromConv.toBase
            // Then: new_value = value_in_base_SI / toConv.toBase
            const valueInBase = baseValue * fromConv.toBase;
            const newValue = valueInBase / toConv.toBase;

            const valueEl = document.getElementById(`val_${outputName}`);
            if (valueEl) {
                valueEl.textContent = formatResultValue(newValue);
            }
        }

        // ===== Persistent Results Storage =====
        const RESULTS_STORAGE_KEY = 'websterSolverLastResults';
        const HISTORY_STORAGE_KEY = 'websterSolverHistory';

        function saveResultsToStorage(result) {
            try {
                const data = {
                    timestamp: new Date().toISOString(),
                    equation: currentEquation,
                    category: currentCategory,
                    outputs: result.outputs,
                    validation: result.validation_status
                };
                localStorage.setItem(RESULTS_STORAGE_KEY, JSON.stringify(data));

                // Also add to history
                let history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
                history.unshift(data);
                if (history.length > 10) history = history.slice(0, 10);
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            } catch (e) {
                console.warn('Failed to save results to localStorage:', e);
            }
        }

        function loadResultsFromStorage() {
            try {
                const data = JSON.parse(localStorage.getItem(RESULTS_STORAGE_KEY));
                if (data && data.outputs) {
                    displayStoredResults(data);
                }
            } catch (e) {
                console.warn('Failed to load results from localStorage:', e);
            }
        }

        function displayStoredResults(data) {
            const container = document.getElementById('resultsContent');
            if (!container) return;

            let html = `<div class="stored-results-header">
                <span>ðŸ“‹ Last Calculation</span>
                <span class="stored-time">${new Date(data.timestamp).toLocaleTimeString()}</span>
            </div>`;

            for (const [name, outputData] of Object.entries(data.outputs)) {
                const value = formatResultValue(outputData.value);
                html += `
                    <div class="result-card stored">
                        <div class="result-name">${name}</div>
                        <div class="result-value">
                            ${value}
                            <span class="result-unit">${outputData.unit || ''}</span>
                        </div>
                    </div>
                `;
            }

            html += `<p class="stored-equation">From: ${data.equation}</p>`;
            container.innerHTML = html;
        }

        // Load stored results on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadResultsFromStorage();
        });

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', async (e) => {
            const query = e.target.value;
            if (query.length < 2) {
                loadCategories();
                return;
            }

            const response = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(query)}`);
            const results = await response.json();

            const container = document.getElementById('categoryList');
            if (results.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); padding: 10px;">No results found</p>';
                return;
            }

            container.innerHTML = results.map(eq => `
                <div class="equation-item" onclick="selectEquation('${eq.category}', '${eq.id}')">
                    ${eq.name}
                </div>
            `).join('');
        });

        // Charting variables
        let sensitivityChart = null;
        let lastResult = null;

        // Show chart actions after successful calculation
        function showChartActions() {
            document.getElementById('chartActions').style.display = 'block';
        }

        // Run sensitivity analysis on first input parameter
        async function runSensitivity() {
            if (!currentEquation || equationParams.length === 0) return;

            const baseParam = equationParams[0];
            const baseInput = document.getElementById(`input_${baseParam.name}`);
            const baseValue = parseFloat(baseInput.value);
            if (isNaN(baseValue) || baseValue === 0) {
                alert('Enter a valid base value for the first parameter');
                return;
            }

            // Run calculations at Â±50% in 10 steps
            const variations = [];
            const outputs = {};

            for (let pct = -50; pct <= 50; pct += 10) {
                const testValue = baseValue * (1 + pct / 100);
                variations.push({ pct, value: testValue });

                // Build inputs
                const inputs = {};
                for (const param of equationParams) {
                    const valueEl = document.getElementById(`input_${param.name}`);
                    const unitEl = document.getElementById(`unit_${param.name}`);
                    let value = parseFloat(valueEl.value);

                    if (param.name === baseParam.name) {
                        value = testValue;
                    }

                    if (!isNaN(value)) {
                        inputs[param.name] = { value, unit: unitEl.value || '' };
                    }
                }

                try {
                    const response = await fetch(`${API_BASE}/api/calculate/${currentCategory}/${currentEquation}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ inputs })
                    });
                    const result = await response.json();

                    if (result.success) {
                        for (const [name, data] of Object.entries(result.outputs)) {
                            if (!outputs[name]) outputs[name] = [];
                            outputs[name].push(data.value);
                        }
                    }
                } catch (e) {
                    console.error('Sensitivity calc error:', e);
                }
            }

            // Create chart
            const labels = variations.map(v => `${v.pct > 0 ? '+' : ''}${v.pct}%`);
            const datasets = [];
            const colors = ['#89b4fa', '#a6e3a1', '#f9e2af', '#f38ba8', '#cba6f7', '#94e2d5'];

            let i = 0;
            for (const [name, values] of Object.entries(outputs)) {
                datasets.push({
                    label: name,
                    data: values,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '33',
                    tension: 0.3,
                    fill: false
                });
                i++;
            }

            // Show chart section
            document.getElementById('chartSection').style.display = 'block';

            // Destroy old chart
            if (sensitivityChart) {
                sensitivityChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('sensitivityChart').getContext('2d');
            sensitivityChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#cdd6f4', font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: `Effect of ${baseParam.name} variation`,
                            color: '#cdd6f4'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a6adc8' },
                            grid: { color: '#45475a' }
                        },
                        y: {
                            ticks: { color: '#a6adc8' },
                            grid: { color: '#45475a' }
                        }
                    }
                }
            });
        }

        // Update displayResults to show chart button
        const originalDisplayResults = displayResults;
        displayResults = function (result) {
            const container = document.getElementById('resultsContent');

            if (!result.success) {
                container.innerHTML = `
                    <div class="validation-badge fail">âŒ Error</div>
                    <p>${result.error || 'Calculation failed'}</p>
                `;
                document.getElementById('chartActions').style.display = 'none';
                document.getElementById('chartSection').style.display = 'none';
                return;
            }

            let html = '';

            // Validation badge
            if (result.validation_status) {
                const status = result.validation_status.toLowerCase();
                const icon = status === 'pass' ? 'âœ“' : status === 'warning' ? 'âš ' : 'âœ—';
                html += `<div class="validation-badge ${status}">${icon} ${result.validation_status}</div>`;
            }

            // Check for comparison mode
            if (comparisonMode && previousResult && previousResult.outputs) {
                html += '<div class="result-comparison">';
                for (const [name, data] of Object.entries(result.outputs)) {
                    const value = typeof data.value === 'number' ?
                        (Math.abs(data.value) < 0.001 || Math.abs(data.value) > 10000 ?
                            data.value.toExponential(4) : data.value.toFixed(4)) : data.value;

                    // Current result
                    const copyText = `${value} ${data.unit || ''}`.trim();
                    html += `
                        <div class="result-card" onclick="copyToClipboard('${copyText}')">
                            <div class="result-name">${name} (Current)</div>
                            <div class="result-value">
                                ${value}
                                <span class="result-unit">${data.unit || ''}</span>
                            </div>
                        </div>
                    `;

                    // Previous result
                    const prevData = previousResult.outputs[name];
                    if (prevData) {
                        const prevValue = typeof prevData.value === 'number' ?
                            (Math.abs(prevData.value) < 0.001 || Math.abs(prevData.value) > 10000 ?
                                prevData.value.toExponential(4) : prevData.value.toFixed(4)) : prevData.value;

                        // Calculate delta
                        let delta = '';
                        if (typeof data.value === 'number' && typeof prevData.value === 'number') {
                            const pctChange = ((data.value - prevData.value) / prevData.value * 100).toFixed(1);
                            const deltaClass = parseFloat(pctChange) >= 0 ? 'positive' : 'negative';
                            delta = `<span class="delta-indicator ${deltaClass}">${pctChange > 0 ? '+' : ''}${pctChange}%</span>`;
                        }

                        html += `
                            <div class="result-card previous">
                                <div class="result-name">${name} (Previous) ${delta}</div>
                                <div class="result-value">
                                    ${prevValue}
                                    <span class="result-unit">${prevData.unit || ''}</span>
                                </div>
                            </div>
                        `;
                    }
                }
                html += '</div>';
            } else {
                // Normal output cards with copy functionality
                for (const [name, data] of Object.entries(result.outputs)) {
                    const value = typeof data.value === 'number' ?
                        (Math.abs(data.value) < 0.001 || Math.abs(data.value) > 10000 ?
                            data.value.toExponential(4) : data.value.toFixed(4)) : data.value;
                    const copyText = `${value} ${data.unit || ''}`.trim();
                    html += `
                        <div class="result-card" onclick="copyToClipboard('${copyText}')">
                            <div class="result-name">${name}</div>
                            <div class="result-value">
                                ${value}
                                <span class="result-unit">${data.unit || ''}</span>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
            previousResult = lastResult;
            lastResult = result;
            showChartActions();

            // Update calculation counter
            updateCalcCounter();

            // Save to history
            const inputs = {};
            for (const param of equationParams) {
                const valueEl = document.getElementById(`input_${param.name}`);
                const unitEl = document.getElementById(`unit_${param.name}`);
                if (valueEl && valueEl.value) {
                    inputs[param.name] = {
                        value: parseFloat(valueEl.value),
                        unit: unitEl ? unitEl.value : ''
                    };
                }
            }
            saveToHistory(currentEquation, inputs, result.outputs);

            // Show input linking suggestions
            showLinkSuggestions(result.outputs);
        };

        // ===== Particle System (Brownian Motion) =====
        const particleCanvas = document.getElementById('particleCanvas');
        const ctx = particleCanvas ? particleCanvas.getContext('2d') : null;
        let particles = [];

        function initParticles() {
            if (!particleCanvas || !ctx) return;

            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;

            particles = [];
            const numParticles = 25;

            for (let i = 0; i < numParticles; i++) {
                particles.push({
                    x: Math.random() * particleCanvas.width,
                    y: Math.random() * particleCanvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    radius: Math.random() * 2 + 1,
                    opacity: Math.random() * 0.3 + 0.1
                });
            }
        }

        function drawParticles() {
            if (!ctx || !particleCanvas) return;

            ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);

            // Draw connecting lines (polymer chains)
            ctx.strokeStyle = 'rgba(91, 110, 174, 0.06)';
            ctx.lineWidth = 1;
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 150) {
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.globalAlpha = 0.1 * (1 - dist / 150);
                        ctx.stroke();
                    }
                }
            }

            // Draw particles
            for (const p of particles) {
                // Brownian motion - random velocity changes
                p.vx += (Math.random() - 0.5) * 0.1;
                p.vy += (Math.random() - 0.5) * 0.1;

                // Damping
                p.vx *= 0.99;
                p.vy *= 0.99;

                // Update position
                p.x += p.vx;
                p.y += p.vy;

                // Wrap around edges
                if (p.x < 0) p.x = particleCanvas.width;
                if (p.x > particleCanvas.width) p.x = 0;
                if (p.y < 0) p.y = particleCanvas.height;
                if (p.y > particleCanvas.height) p.y = 0;

                // Draw particle
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(91, 110, 174, ${p.opacity})`;
                ctx.globalAlpha = 1;
                ctx.fill();
            }

            requestAnimationFrame(drawParticles);
        }

        // ===== Ripple Effect on Calculate Button =====
        function createRipple(event) {
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            const ripple = document.createElement('span');
            ripple.classList.add('ripple-effect');
            ripple.style.left = `${event.clientX - rect.left}px`;
            ripple.style.top = `${event.clientY - rect.top}px`;
            ripple.style.width = ripple.style.height = '20px';
            button.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        // ===== Equation Preview on Hover =====
        async function showEquationPreview(element, category, eqId) {
            const cacheKey = `${category}/${eqId}`;

            // Check cache
            if (!equationCache[cacheKey]) {
                try {
                    const response = await fetch(`${API_BASE}/api/equations/${category}/${eqId}`);
                    equationCache[cacheKey] = await response.json();
                } catch (e) {
                    return;
                }
            }

            const eq = equationCache[cacheKey];

            // Create or update preview
            let preview = element.querySelector('.equation-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.className = 'equation-preview';
                element.appendChild(preview);
            }

            const inputsList = eq.parameters.map(p => `${p.symbol}`).join(', ');
            preview.innerHTML = `
                <h4>${eq.name}</h4>
                ${eq.formula ? `<div class="formula">${eq.formula}</div>` : ''}
                <p>${eq.description.substring(0, 100)}${eq.description.length > 100 ? '...' : ''}</p>
                <div class="preview-inputs">Inputs: ${inputsList}</div>
            `;
        }

        // ===== History Dropdown UI =====
        function renderHistoryDropdown() {
            if (!currentEquation) return;

            const history = getHistory(currentEquation);
            if (history.length === 0) return;

            // Check if dropdown already exists
            let dropdown = document.querySelector('.history-dropdown');
            if (!dropdown) {
                const inputSection = document.querySelector('.input-section');
                if (!inputSection) return;

                const header = inputSection.querySelector('.section-title');
                if (!header) return;

                dropdown = document.createElement('div');
                dropdown.className = 'history-dropdown';
                dropdown.innerHTML = `
                    <button class="history-btn" onclick="toggleHistoryMenu(event)">
                        ðŸ“œ History <span class="history-count">(${history.length})</span>
                    </button>
                    <div class="history-menu" id="historyMenu"></div>
                `;
                header.parentNode.insertBefore(dropdown, header.nextSibling);
            }

            // Update count
            const countSpan = dropdown.querySelector('.history-count');
            if (countSpan) countSpan.textContent = `(${history.length})`;

            // Populate menu
            const menu = dropdown.querySelector('.history-menu');
            if (!menu) return;

            menu.innerHTML = history.map((entry, idx) => {
                const time = new Date(entry.timestamp);
                const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = time.toLocaleDateString();
                const values = Object.entries(entry.inputs).slice(0, 2).map(([k, v]) => `${k}=${v.value}`).join(', ');
                return `
                    <div class="history-item" onclick="loadHistoryEntry(${idx})">
                        <div class="time">${dateStr} ${timeStr}</div>
                        <div class="values">${values}${Object.keys(entry.inputs).length > 2 ? '...' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        function toggleHistoryMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('historyMenu');
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        function loadHistoryEntry(index) {
            loadFromHistory(currentEquation, index);
            const menu = document.getElementById('historyMenu');
            if (menu) menu.classList.remove('show');
        }

        // Close history menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.history-dropdown')) {
                const menu = document.getElementById('historyMenu');
                if (menu) menu.classList.remove('show');
            }
        });

        // ===== Input Linking Suggestions =====
        const linkableParams = {
            'pressure': ['pressure', 'P', 'pressure_drop', 'delta_P'],
            'temperature': ['temperature', 'T', 'temp', 'T_hot', 'T_cold'],
            'flow_rate': ['flow_rate', 'Q', 'volumetric_flow', 'mass_flow'],
            'velocity': ['velocity', 'v', 'fluid_velocity'],
            'heat_duty': ['heat_duty', 'Q_heat', 'heat_transfer'],
            'area': ['area', 'A', 'surface_area']
        };

        function showLinkSuggestions(outputs) {
            // Remove existing suggestions
            const existing = document.querySelector('.link-suggestions');
            if (existing) existing.remove();

            // Find matchable output types
            const suggestions = [];
            for (const [outputName, outputData] of Object.entries(outputs)) {
                for (const [category, params] of Object.entries(linkableParams)) {
                    if (params.some(p => outputName.toLowerCase().includes(p.toLowerCase()))) {
                        suggestions.push({
                            outputName,
                            outputValue: outputData.value,
                            outputUnit: outputData.unit,
                            category
                        });
                    }
                }
            }

            if (suggestions.length === 0) return;

            // Create suggestions container
            const container = document.getElementById('resultsContent');
            if (!container) return;

            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'link-suggestions';
            suggestionsDiv.innerHTML = `
                <h4>ðŸ”— Link to Other Equations</h4>
                ${suggestions.slice(0, 3).map(s => `
                    <div class="link-suggestion-item" onclick="copyToClipboard('${s.outputValue}')">
                        <div>
                            <div class="eq-name">${s.outputName}</div>
                            <div class="param-match">${typeof s.outputValue === 'number' ? s.outputValue.toFixed(4) : s.outputValue} ${s.outputUnit || ''}</div>
                        </div>
                        <span class="link-arrow">â†’</span>
                    </div>
                `).join('')}
            `;

            container.appendChild(suggestionsDiv);
        }

        // ===== Window Resize Handler =====
        window.addEventListener('resize', () => {
            if (particleCanvas) {
                particleCanvas.width = window.innerWidth;
                particleCanvas.height = window.innerHeight;
            }
        });

        // Initialize
        loadCategories();
        loadTheme();
        loadCalcCounter();
        initTipsCarousel();
        initParticles();
        drawParticles();

        // Add ripple effect to calculate button
        const calcBtn = document.getElementById('calculateBtn');
        if (calcBtn) {
            calcBtn.addEventListener('click', createRipple);
        }

        // ===== Tab Switching =====
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Map all tab names to their element IDs
            const tabIds = {
                'equations': 'equationsTab',
                'scientific': 'scientificTab',
                'steam': 'steamTab',
                'fluids': 'fluidsTab',
                'converter': 'converterTab',
                'chemicals': 'chemicalsTab',
                'graphing': 'graphingTab'
            };

            const tabEl = document.getElementById(tabIds[tabName]);
            if (tabEl) tabEl.classList.add('active');

            // Initialize tab content if needed
            if (tabName === 'steam') updateSteamTable();
            if (tabName === 'fluids') filterFluids();
            if (tabName === 'chemicals') populateChemicalsTable();
        }

        // ===== Scientific Calculator =====
        let calcExpression = '';
        let calcMemoryValue = 0;
        let calcLastAnswer = 0;
        let calcDegrees = true;

        function updateCalcDisplay() {
            document.getElementById('calcDisplay').value = calcExpression || '0';
        }

        function calcDigit(d) {
            if (calcExpression === '0' && d !== '.') calcExpression = '';
            calcExpression += d;
            updateCalcDisplay();
        }

        function calcOperator(op) {
            calcExpression += op;
            updateCalcDisplay();
        }

        function calcFunction(fn) {
            const val = parseFloat(calcExpression) || 0;
            let result;
            const toRad = calcDegrees ? Math.PI / 180 : 1;
            const toDeg = calcDegrees ? 180 / Math.PI : 1;

            switch (fn) {
                case 'sin': result = Math.sin(val * toRad); break;
                case 'cos': result = Math.cos(val * toRad); break;
                case 'tan': result = Math.tan(val * toRad); break;
                case 'asin': result = Math.asin(val) * toDeg; break;
                case 'acos': result = Math.acos(val) * toDeg; break;
                case 'atan': result = Math.atan(val) * toDeg; break;
                case 'log': result = Math.log10(val); break;
                case 'ln': result = Math.log(val); break;
                case 'sqrt': result = Math.sqrt(val); break;
                case 'exp': result = Math.exp(val); break;
                case 'pow10': result = Math.pow(10, val); break;
                case 'square': result = val * val; break;
                case 'abs': result = Math.abs(val); break;
                case 'inv': result = 1 / val; break;
                case 'negate': result = -val; break;
                default: return;
            }
            calcExpression = result.toString();
            updateCalcDisplay();
        }

        function calcConst(c) {
            if (c === 'pi') calcExpression += Math.PI.toString();
            else if (c === 'e') calcExpression += Math.E.toString();
            updateCalcDisplay();
        }

        function factorial(n) {
            if (n < 0) return NaN;
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        function calcEquals() {
            try {
                // Replace operators for eval
                let expr = calcExpression
                    .replace(/Ã—/g, '*')
                    .replace(/Ã·/g, '/')
                    .replace(/âˆ’/g, '-')
                    .replace(/\^/g, '**');

                // Handle factorial
                expr = expr.replace(/(\d+)!/g, (m, n) => factorial(parseInt(n)));

                const result = Function('"use strict"; return (' + expr + ')')();
                document.getElementById('calcHistory').textContent = calcExpression + ' =';
                calcLastAnswer = result;
                calcExpression = result.toString();
                updateCalcDisplay();
            } catch (e) {
                calcExpression = 'Error';
                updateCalcDisplay();
            }
        }

        function calcClear() {
            calcExpression = '';
            document.getElementById('calcHistory').textContent = '';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcExpression = calcExpression.slice(0, -1);
            updateCalcDisplay();
        }

        function calcMemory(action) {
            const val = parseFloat(calcExpression) || 0;
            switch (action) {
                case 'MC': calcMemoryValue = 0; break;
                case 'MR': calcExpression = calcMemoryValue.toString(); updateCalcDisplay(); break;
                case 'M+': calcMemoryValue += val; break;
                case 'M-': calcMemoryValue -= val; break;
            }
            document.getElementById('calcMemoryIndicator').textContent = calcMemoryValue !== 0 ? 'M' : '';
        }

        function calcToggleDegRad() {
            calcDegrees = !calcDegrees;
            document.getElementById('calcMode').textContent = calcDegrees ? 'DEG' : 'RAD';
            // Update button text
            document.querySelectorAll('.calc-btn.function').forEach(btn => {
                if (btn.textContent === 'DEG' || btn.textContent === 'RAD') {
                    btn.textContent = calcDegrees ? 'DEG' : 'RAD';
                }
            });
        }

        function calcAns() {
            calcExpression += calcLastAnswer.toString();
            updateCalcDisplay();
        }

        // ===== Steam Tables Data (Saturated Steam) =====
        const steamData = [
            // Temperature-based data (0-374Â°C)
            { T: 0.01, P: 0.6113, vf: 0.001000, vg: 206.14, hf: 0.00, hfg: 2501.4, hg: 2501.4, sf: 0.0000, sg: 9.1562 },
            { T: 5, P: 0.8721, vf: 0.001000, vg: 147.12, hf: 20.98, hfg: 2489.6, hg: 2510.6, sf: 0.0761, sg: 9.0257 },
            { T: 10, P: 1.2276, vf: 0.001000, vg: 106.38, hf: 42.01, hfg: 2477.7, hg: 2519.8, sf: 0.1510, sg: 8.9008 },
            { T: 15, P: 1.7051, vf: 0.001001, vg: 77.93, hf: 62.99, hfg: 2465.9, hg: 2528.9, sf: 0.2245, sg: 8.7814 },
            { T: 20, P: 2.339, vf: 0.001002, vg: 57.79, hf: 83.96, hfg: 2454.1, hg: 2538.1, sf: 0.2966, sg: 8.6672 },
            { T: 25, P: 3.169, vf: 0.001003, vg: 43.36, hf: 104.89, hfg: 2442.3, hg: 2547.2, sf: 0.3674, sg: 8.5580 },
            { T: 30, P: 4.246, vf: 0.001004, vg: 32.89, hf: 125.79, hfg: 2430.5, hg: 2556.3, sf: 0.4369, sg: 8.4533 },
            { T: 35, P: 5.628, vf: 0.001006, vg: 25.22, hf: 146.68, hfg: 2418.6, hg: 2565.3, sf: 0.5053, sg: 8.3531 },
            { T: 40, P: 7.384, vf: 0.001008, vg: 19.52, hf: 167.57, hfg: 2406.7, hg: 2574.3, sf: 0.5725, sg: 8.2570 },
            { T: 45, P: 9.593, vf: 0.001010, vg: 15.26, hf: 188.45, hfg: 2394.8, hg: 2583.2, sf: 0.6387, sg: 8.1648 },
            { T: 50, P: 12.35, vf: 0.001012, vg: 12.03, hf: 209.33, hfg: 2382.7, hg: 2592.1, sf: 0.7038, sg: 8.0763 },
            { T: 55, P: 15.76, vf: 0.001015, vg: 9.568, hf: 230.23, hfg: 2370.7, hg: 2600.9, sf: 0.7679, sg: 7.9913 },
            { T: 60, P: 19.94, vf: 0.001017, vg: 7.671, hf: 251.13, hfg: 2358.5, hg: 2609.6, sf: 0.8312, sg: 7.9096 },
            { T: 65, P: 25.03, vf: 0.001020, vg: 6.197, hf: 272.06, hfg: 2346.2, hg: 2618.3, sf: 0.8935, sg: 7.8310 },
            { T: 70, P: 31.19, vf: 0.001023, vg: 5.042, hf: 292.98, hfg: 2333.8, hg: 2626.8, sf: 0.9549, sg: 7.7553 },
            { T: 75, P: 38.58, vf: 0.001026, vg: 4.131, hf: 313.93, hfg: 2321.4, hg: 2635.3, sf: 1.0155, sg: 7.6824 },
            { T: 80, P: 47.39, vf: 0.001029, vg: 3.407, hf: 334.91, hfg: 2308.8, hg: 2643.7, sf: 1.0753, sg: 7.6122 },
            { T: 85, P: 57.83, vf: 0.001032, vg: 2.828, hf: 355.90, hfg: 2296.0, hg: 2651.9, sf: 1.1343, sg: 7.5445 },
            { T: 90, P: 70.14, vf: 0.001036, vg: 2.361, hf: 376.92, hfg: 2283.2, hg: 2660.1, sf: 1.1925, sg: 7.4791 },
            { T: 95, P: 84.55, vf: 0.001040, vg: 1.982, hf: 397.96, hfg: 2270.2, hg: 2668.1, sf: 1.2500, sg: 7.4159 },
            { T: 100, P: 101.35, vf: 0.001044, vg: 1.6729, hf: 419.04, hfg: 2257.0, hg: 2676.1, sf: 1.3069, sg: 7.3549 },
            { T: 105, P: 120.82, vf: 0.001048, vg: 1.4194, hf: 440.15, hfg: 2243.7, hg: 2683.8, sf: 1.3630, sg: 7.2958 },
            { T: 110, P: 143.27, vf: 0.001052, vg: 1.2102, hf: 461.30, hfg: 2230.2, hg: 2691.5, sf: 1.4185, sg: 7.2387 },
            { T: 115, P: 169.06, vf: 0.001056, vg: 1.0366, hf: 482.48, hfg: 2216.5, hg: 2699.0, sf: 1.4734, sg: 7.1833 },
            { T: 120, P: 198.53, vf: 0.001060, vg: 0.8919, hf: 503.71, hfg: 2202.6, hg: 2706.3, sf: 1.5276, sg: 7.1296 },
            { T: 130, P: 270.1, vf: 0.001070, vg: 0.6685, hf: 546.31, hfg: 2174.2, hg: 2720.5, sf: 1.6344, sg: 7.0269 },
            { T: 140, P: 361.3, vf: 0.001080, vg: 0.5089, hf: 589.13, hfg: 2144.7, hg: 2733.9, sf: 1.7391, sg: 6.9299 },
            { T: 150, P: 475.8, vf: 0.001091, vg: 0.3928, hf: 632.20, hfg: 2114.3, hg: 2746.5, sf: 1.8418, sg: 6.8379 },
            { T: 160, P: 617.8, vf: 0.001102, vg: 0.3071, hf: 675.55, hfg: 2082.6, hg: 2758.1, sf: 1.9427, sg: 6.7502 },
            { T: 170, P: 791.7, vf: 0.001114, vg: 0.2428, hf: 719.21, hfg: 2049.5, hg: 2768.7, sf: 2.0419, sg: 6.6663 },
            { T: 180, P: 1002.1, vf: 0.001127, vg: 0.1941, hf: 763.22, hfg: 2015.0, hg: 2778.2, sf: 2.1396, sg: 6.5857 },
            { T: 190, P: 1254.4, vf: 0.001141, vg: 0.1565, hf: 807.62, hfg: 1978.8, hg: 2786.4, sf: 2.2359, sg: 6.5079 },
            { T: 200, P: 1553.8, vf: 0.001157, vg: 0.1274, hf: 852.45, hfg: 1940.7, hg: 2793.2, sf: 2.3309, sg: 6.4323 },
            { T: 220, P: 2318.0, vf: 0.001190, vg: 0.08620, hf: 943.62, hfg: 1858.5, hg: 2802.1, sf: 2.5178, sg: 6.2861 },
            { T: 240, P: 3344.0, vf: 0.001229, vg: 0.05976, hf: 1037.32, hfg: 1766.5, hg: 2803.8, sf: 2.7015, sg: 6.1437 },
            { T: 260, P: 4688.0, vf: 0.001276, vg: 0.04221, hf: 1134.37, hfg: 1662.5, hg: 2796.9, sf: 2.8838, sg: 6.0016 },
            { T: 280, P: 6412.0, vf: 0.001332, vg: 0.03017, hf: 1236.04, hfg: 1543.6, hg: 2779.6, sf: 3.0668, sg: 5.8565 },
            { T: 300, P: 8581.0, vf: 0.001404, vg: 0.02167, hf: 1344.0, hfg: 1404.9, hg: 2749.0, sf: 3.2534, sg: 5.7045 },
            { T: 320, P: 11274.0, vf: 0.001499, vg: 0.01549, hf: 1461.5, hfg: 1238.6, hg: 2700.1, sf: 3.4480, sg: 5.5362 },
            { T: 340, P: 14586.0, vf: 0.001638, vg: 0.01080, hf: 1594.2, hfg: 1027.9, hg: 2622.0, sf: 3.6594, sg: 5.3357 },
            { T: 360, P: 18651.0, vf: 0.001893, vg: 0.006945, hf: 1760.5, hfg: 720.3, hg: 2481.0, sf: 3.9147, sg: 5.0526 },
            { T: 374.14, P: 22090.0, vf: 0.003155, vg: 0.003155, hf: 2099.3, hfg: 0.0, hg: 2099.3, sf: 4.4298, sg: 4.4298 }
        ];

        // Pressure-based data for common industrial pressures
        const steamDataByPressure = [
            { P: 1, T: 6.98, vf: 0.001000, vg: 129.21, hf: 29.30, hfg: 2485.0, hg: 2514.3, sf: 0.1059, sg: 8.9756 },
            { P: 5, T: 32.88, vf: 0.001005, vg: 28.19, hf: 137.82, hfg: 2423.7, hg: 2561.5, sf: 0.4764, sg: 8.3951 },
            { P: 10, T: 45.81, vf: 0.001010, vg: 14.67, hf: 191.83, hfg: 2392.8, hg: 2584.7, sf: 0.6493, sg: 8.1502 },
            { P: 20, T: 60.06, vf: 0.001017, vg: 7.649, hf: 251.38, hfg: 2358.3, hg: 2609.7, sf: 0.8320, sg: 7.9085 },
            { P: 50, T: 81.33, vf: 0.001030, vg: 3.240, hf: 340.49, hfg: 2305.4, hg: 2645.9, sf: 1.0910, sg: 7.5939 },
            { P: 75, T: 91.78, vf: 0.001037, vg: 2.217, hf: 384.39, hfg: 2278.6, hg: 2663.0, sf: 1.2130, sg: 7.4564 },
            { P: 100, T: 99.63, vf: 0.001043, vg: 1.694, hf: 417.46, hfg: 2258.0, hg: 2675.5, sf: 1.3026, sg: 7.3594 },
            { P: 101.325, T: 100.00, vf: 0.001044, vg: 1.673, hf: 419.04, hfg: 2257.0, hg: 2676.1, sf: 1.3069, sg: 7.3549 },
            { P: 150, T: 111.37, vf: 0.001053, vg: 1.159, hf: 467.11, hfg: 2226.5, hg: 2693.6, sf: 1.4336, sg: 7.2233 },
            { P: 200, T: 120.23, vf: 0.001061, vg: 0.8857, hf: 504.70, hfg: 2201.9, hg: 2706.7, sf: 1.5301, sg: 7.1271 },
            { P: 300, T: 133.55, vf: 0.001073, vg: 0.6058, hf: 561.47, hfg: 2163.8, hg: 2725.3, sf: 1.6718, sg: 6.9919 },
            { P: 400, T: 143.63, vf: 0.001084, vg: 0.4625, hf: 604.74, hfg: 2133.8, hg: 2738.6, sf: 1.7766, sg: 6.8959 },
            { P: 500, T: 151.86, vf: 0.001093, vg: 0.3749, hf: 640.23, hfg: 2108.5, hg: 2748.7, sf: 1.8607, sg: 6.8213 },
            { P: 600, T: 158.85, vf: 0.001101, vg: 0.3157, hf: 670.56, hfg: 2086.3, hg: 2756.8, sf: 1.9312, sg: 6.7600 },
            { P: 700, T: 164.97, vf: 0.001108, vg: 0.2729, hf: 697.22, hfg: 2066.3, hg: 2763.5, sf: 1.9922, sg: 6.7080 },
            { P: 800, T: 170.43, vf: 0.001115, vg: 0.2404, hf: 721.11, hfg: 2048.0, hg: 2769.1, sf: 2.0462, sg: 6.6628 },
            { P: 1000, T: 179.91, vf: 0.001127, vg: 0.1944, hf: 762.81, hfg: 2015.3, hg: 2778.1, sf: 2.1387, sg: 6.5865 },
            { P: 1500, T: 198.32, vf: 0.001154, vg: 0.1318, hf: 844.89, hfg: 1947.3, hg: 2792.2, sf: 2.3150, sg: 6.4448 },
            { P: 2000, T: 212.42, vf: 0.001177, vg: 0.09963, hf: 908.79, hfg: 1890.7, hg: 2799.5, sf: 2.4474, sg: 6.3409 },
            { P: 3000, T: 233.90, vf: 0.001217, vg: 0.06668, hf: 1008.42, hfg: 1795.7, hg: 2804.2, sf: 2.6457, sg: 6.1869 },
            { P: 4000, T: 250.40, vf: 0.001252, vg: 0.04978, hf: 1087.31, hfg: 1714.1, hg: 2801.4, sf: 2.7964, sg: 6.0701 },
            { P: 5000, T: 263.99, vf: 0.001286, vg: 0.03944, hf: 1154.23, hfg: 1640.1, hg: 2794.3, sf: 2.9202, sg: 5.9734 },
            { P: 7500, T: 290.59, vf: 0.001368, vg: 0.02556, hf: 1292.68, hfg: 1479.0, hg: 2771.7, sf: 3.1649, sg: 5.7705 },
            { P: 10000, T: 311.06, vf: 0.001452, vg: 0.01803, hf: 1407.56, hfg: 1317.1, hg: 2724.7, sf: 3.3596, sg: 5.6141 },
            { P: 15000, T: 342.24, vf: 0.001658, vg: 0.01034, hf: 1610.45, hfg: 1000.0, hg: 2610.5, sf: 3.6848, sg: 5.3098 },
            { P: 20000, T: 365.81, vf: 0.002036, vg: 0.005834, hf: 1826.30, hfg: 583.4, hg: 2409.7, sf: 4.0139, sg: 4.9269 },
            { P: 22090, T: 374.14, vf: 0.003155, vg: 0.003155, hf: 2099.30, hfg: 0.0, hg: 2099.3, sf: 4.4298, sg: 4.4298 }
        ];

        function updateSteamTable() {
            const tbody = document.getElementById('steamTableBody');
            const viewType = document.getElementById('steamViewType')?.value || 'temp';
            if (!tbody) return;

            // Select appropriate data based on view type
            const data = viewType === 'pressure' ? steamDataByPressure : steamData;

            // Sort data
            const sortedData = [...data].sort((a, b) =>
                viewType === 'pressure' ? a.P - b.P : a.T - b.T
            );

            tbody.innerHTML = sortedData.map(row => `
                <tr>
                    <td>${typeof row.T === 'number' ? row.T.toFixed(2) : row.T}</td>
                    <td>${row.P.toFixed(2)}</td>
                    <td>${row.vf.toFixed(6)}</td>
                    <td>${row.vg.toFixed(4)}</td>
                    <td>${row.hf.toFixed(2)}</td>
                    <td>${row.hfg.toFixed(1)}</td>
                    <td>${row.hg.toFixed(1)}</td>
                    <td>${row.sf.toFixed(4)}</td>
                    <td>${row.sg.toFixed(4)}</td>
                </tr>
            `).join('');
        }


        // ===== Fluid Properties Data =====
        const fluidData = [
            { name: 'Water', rho: 997, mu: 0.890, Cp: 4.18, k: 0.607, Tb: 100, Tc: 374, Pc: 22.06 },
            { name: 'Ethanol', rho: 789, mu: 1.074, Cp: 2.44, k: 0.171, Tb: 78.4, Tc: 241, Pc: 6.14 },
            { name: 'Methanol', rho: 792, mu: 0.544, Cp: 2.53, k: 0.203, Tb: 64.7, Tc: 240, Pc: 8.09 },
            { name: 'Acetone', rho: 784, mu: 0.306, Cp: 2.15, k: 0.161, Tb: 56.2, Tc: 235, Pc: 4.70 },
            { name: 'Benzene', rho: 876, mu: 0.604, Cp: 1.74, k: 0.144, Tb: 80.1, Tc: 289, Pc: 4.89 },
            { name: 'Toluene', rho: 867, mu: 0.560, Cp: 1.70, k: 0.131, Tb: 110.6, Tc: 319, Pc: 4.11 },
            { name: 'n-Hexane', rho: 659, mu: 0.294, Cp: 2.27, k: 0.124, Tb: 68.7, Tc: 234, Pc: 3.03 },
            { name: 'n-Heptane', rho: 684, mu: 0.386, Cp: 2.24, k: 0.127, Tb: 98.4, Tc: 267, Pc: 2.74 },
            { name: 'Chloroform', rho: 1483, mu: 0.537, Cp: 0.96, k: 0.117, Tb: 61.2, Tc: 263, Pc: 5.47 },
            { name: 'Carbon tetrachloride', rho: 1594, mu: 0.908, Cp: 0.86, k: 0.103, Tb: 76.7, Tc: 283, Pc: 4.56 },
            { name: 'Sulfuric acid (98%)', rho: 1840, mu: 24.0, Cp: 1.38, k: 0.35, Tb: 337, Tc: 654, Pc: 6.40 },
            { name: 'Glycerol', rho: 1261, mu: 934, Cp: 2.43, k: 0.285, Tb: 290, Tc: 453, Pc: 6.69 },
            { name: 'Acetic acid', rho: 1049, mu: 1.056, Cp: 2.05, k: 0.158, Tb: 118, Tc: 319, Pc: 5.79 },
            { name: 'Ammonia (liq)', rho: 682, mu: 0.255, Cp: 4.70, k: 0.507, Tb: -33, Tc: 132, Pc: 11.33 },
            { name: 'Ethylene glycol', rho: 1113, mu: 16.1, Cp: 2.35, k: 0.258, Tb: 197, Tc: 372, Pc: 7.70 }
        ];

        function filterFluids() {
            const search = (document.getElementById('fluidSearch')?.value || '').toLowerCase();
            const tbody = document.getElementById('fluidsTableBody');
            if (!tbody) return;

            const filtered = fluidData.filter(f => f.name.toLowerCase().includes(search));
            tbody.innerHTML = filtered.map(row => `
                <tr>
                    <td>${row.name}</td>
                    <td>${row.rho}</td>
                    <td>${row.mu}</td>
                    <td>${row.Cp.toFixed(2)}</td>
                    <td>${row.k.toFixed(3)}</td>
                    <td>${row.Tb}</td>
                    <td>${row.Tc}</td>
                    <td>${row.Pc.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // Initialize reference tables
        updateSteamTable();
        filterFluids();

        // ===== Tab Switching =====
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Initialize graphs if switching to graphing tab
            if (tabName === 'graphing') {
                setTimeout(() => plotPIDResponse(), 100);
            }
        }

        // ===== Graph Selection =====
        function selectGraph(graphType) {
            // Update buttons
            document.querySelectorAll('.graph-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show selected graph container
            document.querySelectorAll('.graph-container').forEach(container => {
                container.classList.remove('active');
            });
            document.getElementById(graphType + 'Graph').classList.add('active');

            // Plot the selected graph
            switch (graphType) {
                case 'pid': plotPIDResponse(); break;
                case 'pump': plotPumpCurves(); break;
                case 'txy': plotTxy(); break;
                case 'moody': plotMoody(); break;
                case 'phase': plotPhase(); break;
                case 'arrhenius': plotArrhenius(); break;
                case 'ntu': plotNTU(); break;
                case 'bode': plotBode(); break;
                case 'heat': plotHeatCurves(); break;
            }
        }

        // ===== Chart Instances =====
        let pidChartInstance = null;
        let pumpChartInstance = null;
        let txyChartInstance = null;
        let moodyChartInstance = null;

        // ===== PID Step Response =====
        // Simulates closed-loop step response for P, PI, or PID controller with FOPTD process
        function plotPIDResponse() {
            const controllerType = document.getElementById('pidType')?.value || 'PID';
            const Kp = parseFloat(document.getElementById('pidK')?.value || 1);         // Process gain
            const taup = parseFloat(document.getElementById('pidTau')?.value || 5);     // Process time constant
            const Kc = parseFloat(document.getElementById('pidKc')?.value || 2);        // Controller gain
            const tauI = parseFloat(document.getElementById('pidTauI')?.value || 10);   // Integral time
            const tauD = parseFloat(document.getElementById('pidTauD')?.value || 1);    // Derivative time
            const tMax = parseFloat(document.getElementById('pidTmax')?.value || 50);   // Time scale
            const stepSize = parseFloat(document.getElementById('pidStep')?.value || 1);

            const ctx = document.getElementById('pidChart');
            if (!ctx) return;

            // Simulation parameters
            const dt = tMax / 500;  // Time step
            const times = [];
            const processOutput = [];
            const controllerOutput = [];
            const setpointData = [];
            const errorData = [];

            // State variables
            let y = 0;          // Process output
            let yPrev = 0;      // Previous output
            let integral = 0;   // Integral of error
            let errorPrev = 0;  // Previous error

            // Simulate closed-loop response
            for (let t = 0; t <= tMax; t += dt) {
                times.push(t.toFixed(2));

                // Setpoint (step change at t=0)
                const sp = stepSize;
                setpointData.push(sp);

                // Error
                const error = sp - y;
                errorData.push(error);

                // Controller output based on type
                let u = 0;
                if (controllerType === 'P') {
                    // P-only: u = Kc * e
                    u = Kc * error;
                } else if (controllerType === 'PI') {
                    // PI: u = Kc * (e + 1/tauI * integral(e))
                    integral += error * dt;
                    u = Kc * (error + integral / tauI);
                } else {
                    // PID: u = Kc * (e + 1/tauI * integral(e) + tauD * de/dt)
                    integral += error * dt;
                    const derivative = (error - errorPrev) / dt;
                    u = Kc * (error + integral / tauI + tauD * derivative);
                }
                controllerOutput.push(u);

                // First-order process: tau * dy/dt + y = Kp * u
                // Euler method: y_new = y + dt * (Kp * u - y) / tau
                const dydt = (Kp * u - y) / taup;
                y = y + dydt * dt;
                processOutput.push(y);

                errorPrev = error;
                yPrev = y;
            }

            // Calculate performance metrics
            const finalValue = processOutput[processOutput.length - 1];
            const peakValue = Math.max(...processOutput);
            const overshoot = ((peakValue - stepSize) / stepSize) * 100;
            const steadyStateError = Math.abs(stepSize - finalValue);

            // Settling time (Â±2% of setpoint)
            const tolerance = 0.02 * stepSize;
            let settlingTime = tMax;
            for (let i = processOutput.length - 1; i >= 0; i--) {
                if (Math.abs(processOutput[i] - stepSize) > tolerance) {
                    settlingTime = parseFloat(times[i]);
                    break;
                }
            }

            // Display metrics
            const metricsDiv = document.getElementById('pidMetrics');
            if (metricsDiv) {
                metricsDiv.innerHTML = `
                    <div class="metric-grid">
                        <div class="metric"><span class="metric-label">Controller:</span> <strong>${controllerType}</strong></div>
                        <div class="metric"><span class="metric-label">Overshoot:</span> <strong>${overshoot.toFixed(1)}%</strong></div>
                        <div class="metric"><span class="metric-label">Settling Time (2%):</span> <strong>${settlingTime.toFixed(1)}s</strong></div>
                        <div class="metric"><span class="metric-label">Steady-State Error:</span> <strong>${steadyStateError.toFixed(4)}</strong></div>
                    </div>
                `;
            }

            if (pidChartInstance) pidChartInstance.destroy();

            pidChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: times,
                    datasets: [
                        {
                            label: 'Process Output (y)',
                            data: processOutput,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'Setpoint (SP)',
                            data: setpointData,
                            borderColor: '#3fb950',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'Controller Output (u)',
                            data: controllerOutput,
                            borderColor: '#f85149',
                            borderDash: [2, 2],
                            pointRadius: 0,
                            borderWidth: 1.5,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${controllerType} Controller Response (Kc=${Kc}, Ï„p=${taup}s${controllerType !== 'P' ? ', Ï„I=' + tauI + 's' : ''}${controllerType === 'PID' ? ', Ï„D=' + tauD + 's' : ''})`,
                            color: '#f0f6fc',
                            font: { size: 13 }
                        },
                        legend: { labels: { color: '#8b949e' }, position: 'bottom' }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (s)', color: '#8b949e' },
                            ticks: { color: '#8b949e', maxTicksLimit: 10 },
                            grid: { color: 'rgba(48, 54, 61, 0.5)' }
                        },
                        y: {
                            title: { display: true, text: 'Value', color: '#8b949e' },
                            ticks: { color: '#8b949e' },
                            grid: { color: 'rgba(48, 54, 61, 0.5)' }
                        }
                    }
                }
            });
        }

        // ===== Pump System Curves =====
        function plotPumpCurves() {
            const H0 = parseFloat(document.getElementById('pumpH0')?.value || 50);
            const Qmax = parseFloat(document.getElementById('pumpQmax')?.value || 100);
            const staticHead = parseFloat(document.getElementById('sysStatic')?.value || 20);
            const K = parseFloat(document.getElementById('sysK')?.value || 0.002);

            const ctx = document.getElementById('pumpChart');
            if (!ctx) return;

            const flows = [];
            const pumpHead = [];
            const systemHead = [];
            let operatingQ = 0, operatingH = 0;

            for (let Q = 0; Q <= Qmax * 1.2; Q += Qmax / 50) {
                flows.push(Q.toFixed(1));
                // Pump curve: H = H0 * (1 - (Q/Qmax)^2)
                const Hp = H0 * (1 - Math.pow(Q / Qmax, 2));
                pumpHead.push(Math.max(0, Hp));
                // System curve: H = staticHead + K * Q^2
                const Hs = staticHead + K * Q * Q;
                systemHead.push(Hs);

                // Find operating point
                if (Math.abs(Hp - Hs) < 0.5 && operatingQ === 0) {
                    operatingQ = Q;
                    operatingH = Hp;
                }
            }

            if (pumpChartInstance) pumpChartInstance.destroy();

            pumpChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: flows,
                    datasets: [
                        {
                            label: 'Pump Curve',
                            data: pumpHead,
                            borderColor: '#5b6eae',
                            backgroundColor: 'rgba(91, 110, 174, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'System Curve',
                            data: systemHead,
                            borderColor: '#f59e0b',
                            tension: 0.4,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: `Operating Point: Q=${operatingQ.toFixed(1)} mÂ³/h, H=${operatingH.toFixed(1)} m`, color: '#22c55e' },
                        legend: { labels: { color: '#8a8a9a' } }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Flow Rate (mÂ³/h)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { title: { display: true, text: 'Head (m)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' }, min: 0 }
                    }
                }
            });
        }

        // ===== T-xy Diagram (VLE) =====
        // Antoine coefficients for log10(P_mmHg) = A - B/(T+C), T in Â°C
        // Data from NIST Chemistry WebBook
        const vleData = {
            'benzene-toluene': {
                Tb1: 80.1, Tb2: 110.6,
                A1: 6.90565, B1: 1211.033, C1: 220.79,
                A2: 6.95464, B2: 1344.8, C2: 219.48,
                name1: 'Benzene', name2: 'Toluene'
            },
            'methanol-water': {
                Tb1: 64.7, Tb2: 100,
                A1: 7.89750, B1: 1474.08, C1: 229.13,
                A2: 7.96681, B2: 1668.21, C2: 228.0,
                name1: 'Methanol', name2: 'Water'
            },
            'ethanol-water': {
                Tb1: 78.4, Tb2: 100,
                A1: 8.11220, B1: 1592.864, C1: 226.184,
                A2: 7.96681, B2: 1668.21, C2: 228.0,
                name1: 'Ethanol', name2: 'Water'
            },
            'acetone-water': {
                Tb1: 56.1, Tb2: 100,
                A1: 7.11714, B1: 1210.595, C1: 229.664,
                A2: 7.96681, B2: 1668.21, C2: 228.0,
                name1: 'Acetone', name2: 'Water'
            },
            'hexane-ethanol': {
                Tb1: 68.7, Tb2: 78.4,
                A1: 6.87601, B1: 1171.17, C1: 224.41,
                A2: 8.11220, B2: 1592.864, C2: 226.184,
                name1: 'n-Hexane', name2: 'Ethanol'
            },
            'propanol-water': {
                Tb1: 97.2, Tb2: 100,
                A1: 7.74416, B1: 1437.686, C1: 198.463,
                A2: 7.96681, B2: 1668.21, C2: 228.0,
                name1: 'n-Propanol', name2: 'Water'
            },
            'acetone-chloroform': {
                Tb1: 56.1, Tb2: 61.2,
                A1: 7.11714, B1: 1210.595, C1: 229.664,
                A2: 6.95465, B2: 1170.966, C2: 226.232,
                name1: 'Acetone', name2: 'Chloroform'
            },
            'pentane-hexane': {
                Tb1: 36.1, Tb2: 68.7,
                A1: 6.85221, B1: 1064.63, C1: 232.00,
                A2: 6.87601, B2: 1171.17, C2: 224.41,
                name1: 'n-Pentane', name2: 'n-Hexane'
            }
        };

        // Called when system dropdown changes
        function updateTxyParams() {
            // Automatically re-plot when system changes
            plotTxy();
        }

        function plotTxy() {
            const system = document.getElementById('txySystem')?.value || 'benzene-toluene';
            const P_kPa = parseFloat(document.getElementById('txyP')?.value || 101.325);

            // Convert kPa to mmHg for Antoine equation (1 kPa = 7.50062 mmHg)
            const P = P_kPa * 7.50062;

            const ctx = document.getElementById('txyChart');
            if (!ctx) return;

            const data = vleData[system];
            const compositions = [];
            const bubbleT = [];  // Temperature at bubble point (liquid composition x)
            const dewT = [];     // Temperature at dew point (vapor composition y)

            // Calculate bubble point temperatures (T vs x)
            for (let x = 0; x <= 1.001; x += 0.02) {
                compositions.push(x.toFixed(2));

                // Bubble point: find T where x1*P1sat + x2*P2sat = P
                let T = data.Tb1 * x + data.Tb2 * (1 - x);
                for (let iter = 0; iter < 30; iter++) {
                    const P1sat = Math.pow(10, data.A1 - data.B1 / (T + data.C1));
                    const P2sat = Math.pow(10, data.A2 - data.B2 / (T + data.C2));
                    const Pcalc = x * P1sat + (1 - x) * P2sat;
                    const dT = (P - Pcalc) * 0.02;
                    T = T + dT;
                    if (Math.abs(dT) < 0.001) break;
                }
                bubbleT.push(T);
            }

            // Calculate dew point temperatures (T vs y)
            // For a given vapor composition y, find T where y = x*P1sat/P and x1+x2=1
            for (let y = 0; y <= 1.001; y += 0.02) {
                // Dew point: find T where y1/P1sat + y2/P2sat = 1/P
                let T = data.Tb1 * y + data.Tb2 * (1 - y);
                for (let iter = 0; iter < 30; iter++) {
                    const P1sat = Math.pow(10, data.A1 - data.B1 / (T + data.C1));
                    const P2sat = Math.pow(10, data.A2 - data.B2 / (T + data.C2));
                    // For ideal mixture: sum(yi/Pisat) = 1/P
                    const sumYP = y / P1sat + (1 - y) / P2sat;
                    const Pcalc = 1 / sumYP;
                    const dT = (P - Pcalc) * 0.02;
                    T = T + dT;
                    if (Math.abs(dT) < 0.001) break;
                }
                dewT.push(T);
            }

            // Get user's feed point
            const zF = parseFloat(document.getElementById('txyXf')?.value || 0.5);
            const Tf = parseFloat(document.getElementById('txyTf')?.value || 90);

            // Create feed point dataset (single point)
            const feedPointData = compositions.map((comp, i) => {
                const compNum = parseFloat(comp);
                // Only plot at the user's feed composition
                if (Math.abs(compNum - zF) < 0.02) {
                    return Tf;
                }
                return null;
            });

            // Determine which phase the feed point is in
            const zIdx = Math.round(zF / 0.02);
            const bubbleAtZ = bubbleT[zIdx] || bubbleT[0];
            const dewAtZ = dewT[zIdx] || dewT[0];
            let phaseLabel = '';
            if (Tf <= bubbleAtZ) {
                phaseLabel = 'Subcooled Liquid';
            } else if (Tf >= dewAtZ) {
                phaseLabel = 'Superheated Vapor';
            } else {
                phaseLabel = 'Two-Phase (V+L)';
            }

            if (txyChartInstance) txyChartInstance.destroy();

            // Custom plugin for phase region labels
            const phaseLabelsPlugin = {
                id: 'phaseLabels',
                afterDraw: (chart) => {
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;

                    ctx.save();
                    ctx.font = '12px Inter, sans-serif';
                    ctx.textAlign = 'center';

                    // Calculate Y positions for labels
                    const yMin = yAxis.min;
                    const yMax = yAxis.max;
                    const midY = (yMax + yMin) / 2;

                    // Liquid region label (below bubble line)
                    ctx.fillStyle = 'rgba(88, 166, 255, 0.8)';
                    const liquidY = yAxis.getPixelForValue(yMin + (bubbleT[25] - yMin) * 0.3);
                    ctx.fillText('LIQUID', xAxis.getPixelForValue(0.5), liquidY);

                    // Two-phase region label (between lines)
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    const twoPhaseY = yAxis.getPixelForValue((bubbleT[25] + dewT[25]) / 2);
                    ctx.fillText('VAPOR + LIQUID', xAxis.getPixelForValue(0.5), twoPhaseY);

                    // Vapor region label (above dew line)
                    ctx.fillStyle = 'rgba(248, 81, 73, 0.8)';
                    const vaporY = yAxis.getPixelForValue(dewT[25] + (yMax - dewT[25]) * 0.5);
                    ctx.fillText('VAPOR', xAxis.getPixelForValue(0.5), vaporY);

                    ctx.restore();
                }
            };

            txyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: compositions,
                    datasets: [
                        {
                            label: 'Bubble Line (Saturated Liquid)',
                            data: bubbleT,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2.5
                        },
                        {
                            label: 'Dew Line (Saturated Vapor)',
                            data: dewT,
                            borderColor: '#f85149',
                            backgroundColor: 'rgba(248, 81, 73, 0.1)',
                            fill: '-1',
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2.5
                        },
                        {
                            label: `Feed Point (z=${zF}, T=${Tf}Â°C) - ${phaseLabel}`,
                            data: feedPointData,
                            borderColor: '#3fb950',
                            backgroundColor: '#3fb950',
                            pointRadius: 10,
                            pointStyle: 'star',
                            showLine: false,
                            pointBorderWidth: 2,
                            pointBorderColor: '#ffffff'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${data.name1}-${data.name2} T-xy Diagram at ${P_kPa} kPa`,
                            color: '#f0f6fc',
                            font: { size: 14, weight: 'bold' }
                        },
                        legend: {
                            labels: { color: '#8b949e' },
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    if (context.dataset.label.includes('Feed')) {
                                        return `Feed: z=${zF}, T=${Tf}Â°C (${phaseLabel})`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}Â°C`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: `Mole Fraction ${data.name1} (x, y)`, color: '#8b949e' },
                            ticks: { color: '#8b949e' },
                            grid: { color: 'rgba(48, 54, 61, 0.5)' },
                            min: 0,
                            max: 1
                        },
                        y: {
                            title: { display: true, text: 'Temperature (Â°C)', color: '#8b949e' },
                            ticks: { color: '#8b949e' },
                            grid: { color: 'rgba(48, 54, 61, 0.5)' }
                        }
                    }
                },
                plugins: [phaseLabelsPlugin]
            });
        }

        // ===== Moody Diagram =====
        function plotMoody() {
            const Re = parseFloat(document.getElementById('moodyRe')?.value || 100000);
            const eD = parseFloat(document.getElementById('moodyED')?.value || 0.001);

            const ctx = document.getElementById('moodyChart');
            if (!ctx) return;

            // Swamee-Jain equation for friction factor
            function swameeJain(Re, eD) {
                if (Re < 2300) return 64 / Re;  // Laminar
                return 0.25 / Math.pow(Math.log10(eD / 3.7 + 5.74 / Math.pow(Re, 0.9)), 2);
            }

            // Calculate user's friction factor
            const userF = swameeJain(Re, eD);
            const resultDiv = document.getElementById('moodyResult');
            if (resultDiv) {
                const flowRegime = Re < 2300 ? 'Laminar' : Re < 4000 ? 'Transitional' : 'Turbulent';
                resultDiv.innerHTML = `
                    <strong>Results:</strong><br>
                    Reynolds Number: <strong>${Re.toExponential(2)}</strong><br>
                    Relative Roughness (Îµ/D): <strong>${eD}</strong><br>
                    Friction Factor (f): <strong>${userF.toFixed(6)}</strong><br>
                    Flow Regime: <strong>${flowRegime}</strong>
                `;
            }

            // Generate Moody diagram data
            const reValues = [];
            const datasets = [];
            const roughnesses = [0, 0.00001, 0.0001, 0.0005, 0.001, 0.005, 0.01, 0.05];
            const colors = ['#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#ef4444', '#14b8a6', '#6366f1'];

            for (let logRe = 3; logRe <= 7; logRe += 0.1) {
                reValues.push(Math.pow(10, logRe));
            }

            roughnesses.forEach((ed, idx) => {
                const fValues = reValues.map(re => swameeJain(re, ed));
                datasets.push({
                    label: ed === 0 ? 'Smooth' : `Îµ/D = ${ed}`,
                    data: fValues,
                    borderColor: colors[idx],
                    pointRadius: 0,
                    tension: 0.3
                });
            });

            // Add user point
            datasets.push({
                label: 'Your Point',
                data: reValues.map(re => Math.abs(re - Re) < Re * 0.1 ? userF : null),
                borderColor: '#fff',
                backgroundColor: '#fff',
                pointRadius: 8,
                pointStyle: 'star',
                showLine: false
            });

            if (moodyChartInstance) moodyChartInstance.destroy();

            moodyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: reValues.map(r => r.toExponential(0)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Moody Diagram - Friction Factor vs Reynolds Number', color: '#e0e0e6' },
                        legend: { labels: { color: '#8a8a9a', font: { size: 10 } }, position: 'right' }
                    },
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Reynolds Number (Re)', color: '#8a8a9a' },
                            ticks: { color: '#8a8a9a' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Friction Factor (f)', color: '#8a8a9a' },
                            ticks: { color: '#8a8a9a' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            min: 0.005,
                            max: 0.1
                        }
                    }
                }
            });
        }

        // ===== Additional Chart Instances =====
        let phaseChartInstance = null;
        let arrheniusChartInstance = null;
        let ntuChartInstance = null;
        let bodeMagChartInstance = null;
        let bodePhaseChartInstance = null;
        let heatChartInstance = null;

        // ===== Phase Diagram =====
        const phaseData = {
            'water': { Tt: 273.16, Pt: 0.611, Tc: 647.1, Pc: 22064, name: 'Water' },
            'co2': { Tt: 216.55, Pt: 517, Tc: 304.2, Pc: 7380, name: 'COâ‚‚' },
            'ammonia': { Tt: 195.5, Pt: 6.1, Tc: 405.5, Pc: 11280, name: 'Ammonia' }
        };

        function plotPhase() {
            const substance = document.getElementById('phaseSubstance')?.value || 'water';
            const userT = parseFloat(document.getElementById('phaseT')?.value || 300);
            const userP = parseFloat(document.getElementById('phaseP')?.value || 101.325);

            const ctx = document.getElementById('phaseChart');
            if (!ctx) return;

            const data = phaseData[substance];

            // Determine phase
            let phase = 'Supercritical';
            if (userT < data.Tc && userP < data.Pc) {
                // Simplified Antoine-like vapor pressure curve
                const Psat = data.Pt * Math.exp((data.Tc / data.Tt - data.Tc / userT) * Math.log(data.Pc / data.Pt));
                if (userP > Psat) phase = 'Liquid';
                else phase = 'Vapor';
                if (userT < data.Tt) phase = 'Solid';
            }

            document.getElementById('phaseResult').innerHTML = `
                <strong>State Point:</strong> T = ${userT} K, P = ${userP} kPa<br>
                <strong>Phase:</strong> <span style="color: var(--accent-light)">${phase}</span><br>
                <strong>Critical Point:</strong> Tc = ${data.Tc} K, Pc = ${data.Pc} kPa
            `;

            // Generate phase boundary curves
            const temps = [];
            const vaporPressure = [];
            const sublimationP = [];

            for (let T = data.Tt * 0.6; T <= data.Tc * 1.1; T += 5) {
                temps.push(T.toFixed(0));
                if (T >= data.Tt && T <= data.Tc) {
                    const P = data.Pt * Math.exp((data.Tc / data.Tt - data.Tc / T) * Math.log(data.Pc / data.Pt));
                    vaporPressure.push(Math.min(P, data.Pc));
                } else {
                    vaporPressure.push(null);
                }
                if (T <= data.Tt) {
                    sublimationP.push(data.Pt * Math.pow(T / data.Tt, 3));
                } else {
                    sublimationP.push(null);
                }
            }

            if (phaseChartInstance) phaseChartInstance.destroy();

            phaseChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: temps,
                    datasets: [
                        { label: 'Vapor-Liquid', data: vaporPressure, borderColor: '#5b6eae', tension: 0.4, pointRadius: 0 },
                        { label: 'Solid-Vapor', data: sublimationP, borderColor: '#22c55e', tension: 0.4, pointRadius: 0 },
                        { label: 'Your Point', data: temps.map(t => Math.abs(parseFloat(t) - userT) < 10 ? userP : null), borderColor: '#ef4444', backgroundColor: '#ef4444', pointRadius: 10, pointStyle: 'star', showLine: false }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: `${data.name} Phase Diagram`, color: '#e0e0e6' }, legend: { labels: { color: '#8a8a9a' } } },
                    scales: {
                        x: { title: { display: true, text: 'Temperature (K)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { type: 'logarithmic', title: { display: true, text: 'Pressure (kPa)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }

        // ===== Arrhenius Plot =====
        function plotArrhenius() {
            const A = parseFloat(document.getElementById('arrA')?.value || 1e13);
            const Ea = parseFloat(document.getElementById('arrEa')?.value || 80) * 1000; // Convert to J/mol
            const Tmin = parseFloat(document.getElementById('arrTmin')?.value || 300);
            const Tmax = parseFloat(document.getElementById('arrTmax')?.value || 600);
            const R = 8.314; // J/(molÂ·K)

            const ctx = document.getElementById('arrheniusChart');
            if (!ctx) return;

            const invT = [];
            const lnk = [];

            for (let T = Tmax; T >= Tmin; T -= 10) {
                invT.push((1000 / T).toFixed(3));
                const k = A * Math.exp(-Ea / (R * T));
                lnk.push(Math.log(k));
            }

            if (arrheniusChartInstance) arrheniusChartInstance.destroy();

            arrheniusChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: invT,
                    datasets: [{
                        label: 'ln(k)',
                        data: lnk,
                        borderColor: '#5b6eae',
                        backgroundColor: 'rgba(91, 110, 174, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: `Arrhenius Plot: Ea = ${(Ea / 1000).toFixed(1)} kJ/mol, A = ${A.toExponential(2)} sâ»Â¹`, color: '#e0e0e6' },
                        legend: { labels: { color: '#8a8a9a' } }
                    },
                    scales: {
                        x: { title: { display: true, text: '1000/T (Kâ»Â¹)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { title: { display: true, text: 'ln(k)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }

        // ===== Effectiveness-NTU =====
        function calcEffectiveness(NTU, Cr, type) {
            if (Cr === 0) return 1 - Math.exp(-NTU);
            switch (type) {
                case 'counterflow':
                    if (Cr === 1) return NTU / (1 + NTU);
                    return (1 - Math.exp(-NTU * (1 - Cr))) / (1 - Cr * Math.exp(-NTU * (1 - Cr)));
                case 'parallelflow':
                    return (1 - Math.exp(-NTU * (1 + Cr))) / (1 + Cr);
                case 'shell1':
                    const E = Math.exp(-NTU * Math.sqrt(1 + Cr * Cr));
                    return 2 / (1 + Cr + Math.sqrt(1 + Cr * Cr) * (1 + E) / (1 - E));
                case 'crossflow':
                    return 1 - Math.exp((Math.pow(NTU, 0.78) / Cr) * (Math.exp(-Cr * Math.pow(NTU, 0.22)) - 1));
                default:
                    return (1 - Math.exp(-NTU * (1 - Cr))) / (1 - Cr * Math.exp(-NTU * (1 - Cr)));
            }
        }

        function plotNTU() {
            const type = document.getElementById('ntuType')?.value || 'counterflow';
            const Cr = parseFloat(document.getElementById('ntuCr')?.value || 0.5);
            const userNTU = parseFloat(document.getElementById('ntuValue')?.value || 2);

            const ctx = document.getElementById('ntuChart');
            if (!ctx) return;

            const userEff = calcEffectiveness(userNTU, Cr, type);
            document.getElementById('ntuResult').innerHTML = `
                <strong>Results:</strong> NTU = ${userNTU}, Cr = ${Cr}<br>
                <strong>Effectiveness (Îµ):</strong> <span style="color: var(--accent-light)">${(userEff * 100).toFixed(1)}%</span>
            `;

            const ntuValues = [];
            const datasets = [];
            const crValues = [0, 0.25, 0.5, 0.75, 1.0];
            const colors = ['#22c55e', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'];

            for (let n = 0; n <= 6; n += 0.2) ntuValues.push(n.toFixed(1));

            crValues.forEach((cr, idx) => {
                datasets.push({
                    label: `Cr = ${cr}`,
                    data: ntuValues.map(n => calcEffectiveness(parseFloat(n), cr, type) * 100),
                    borderColor: colors[idx],
                    pointRadius: 0,
                    tension: 0.4
                });
            });

            if (ntuChartInstance) ntuChartInstance.destroy();

            ntuChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: ntuValues, datasets: datasets },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: `Effectiveness-NTU (${type})`, color: '#e0e0e6' },
                        legend: { labels: { color: '#8a8a9a' } }
                    },
                    scales: {
                        x: { title: { display: true, text: 'NTU', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { title: { display: true, text: 'Effectiveness (%)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' }, min: 0, max: 100 }
                    }
                }
            });
        }

        // ===== Bode Plot =====
        function plotBode() {
            const K = parseFloat(document.getElementById('bodeK')?.value || 2);
            const tau = parseFloat(document.getElementById('bodeTau')?.value || 5);
            const theta = parseFloat(document.getElementById('bodeTheta')?.value || 1);
            const order = parseInt(document.getElementById('bodeOrder')?.value || 1);

            const ctxMag = document.getElementById('bodeMagChart');
            const ctxPhase = document.getElementById('bodePhaseChart');
            if (!ctxMag || !ctxPhase) return;

            const frequencies = [];
            const magnitude = [];
            const phase = [];

            for (let logW = -2; logW <= 2; logW += 0.1) {
                const w = Math.pow(10, logW);
                frequencies.push(w.toFixed(3));

                // Magnitude: 20*log10(|G(jw)|)
                let mag, ph;
                if (order === 1) {
                    mag = 20 * Math.log10(K / Math.sqrt(1 + Math.pow(w * tau, 2)));
                    ph = -Math.atan(w * tau) * 180 / Math.PI - w * theta * 180 / Math.PI;
                } else {
                    const denom = Math.sqrt(Math.pow(1 - Math.pow(w * tau, 2), 2) + Math.pow(2 * 0.5 * w * tau, 2));
                    mag = 20 * Math.log10(K / denom);
                    ph = -Math.atan2(2 * 0.5 * w * tau, 1 - Math.pow(w * tau, 2)) * 180 / Math.PI - w * theta * 180 / Math.PI;
                }
                magnitude.push(mag);
                phase.push(ph);
            }

            if (bodeMagChartInstance) bodeMagChartInstance.destroy();
            if (bodePhaseChartInstance) bodePhaseChartInstance.destroy();

            bodeMagChartInstance = new Chart(ctxMag, {
                type: 'line',
                data: { labels: frequencies, datasets: [{ label: 'Magnitude (dB)', data: magnitude, borderColor: '#5b6eae', pointRadius: 0, tension: 0.3 }] },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'Magnitude Plot', color: '#e0e0e6' }, legend: { display: false } },
                    scales: {
                        x: { type: 'logarithmic', title: { display: true, text: 'Frequency (rad/s)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { title: { display: true, text: 'Magnitude (dB)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });

            bodePhaseChartInstance = new Chart(ctxPhase, {
                type: 'line',
                data: { labels: frequencies, datasets: [{ label: 'Phase (Â°)', data: phase, borderColor: '#f59e0b', pointRadius: 0, tension: 0.3 }] },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'Phase Plot', color: '#e0e0e6' }, legend: { display: false } },
                    scales: {
                        x: { type: 'logarithmic', title: { display: true, text: 'Frequency (rad/s)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { title: { display: true, text: 'Phase (Â°)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }

        // ===== Heat Curves (Pinch Analysis) =====
        function plotHeatCurves() {
            const Thi = parseFloat(document.getElementById('heatThi')?.value || 200);
            const Tho = parseFloat(document.getElementById('heatTho')?.value || 80);
            const Tci = parseFloat(document.getElementById('heatTci')?.value || 30);
            const Tco = parseFloat(document.getElementById('heatTco')?.value || 150);
            const Q = parseFloat(document.getElementById('heatQ')?.value || 500);

            const ctx = document.getElementById('heatChart');
            if (!ctx) return;

            // Calculate pinch point
            const dTmin = Math.min(Thi - Tco, Tho - Tci);
            const pinchT = Tho;

            document.getElementById('heatResult').innerHTML = `
                <strong>Heat Duty:</strong> ${Q} kW<br>
                <strong>Minimum Î”T:</strong> <span style="color: var(--accent-light)">${dTmin.toFixed(1)} Â°C</span><br>
                <strong>Approach Temperature:</strong> Hot out = ${Tho}Â°C, Cold in = ${Tci}Â°C
            `;

            // Hot composite curve (Temperature vs Enthalpy)
            const enthalpy = [0, Q * 0.5, Q];
            const hotT = [Thi, (Thi + Tho) / 2, Tho];
            const coldT = [Tci, (Tci + Tco) / 2, Tco];

            if (heatChartInstance) heatChartInstance.destroy();

            heatChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: enthalpy.map(h => h.toFixed(0)),
                    datasets: [
                        { label: 'Hot Stream', data: hotT, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.1, pointRadius: 4 },
                        { label: 'Cold Stream', data: coldT, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.1, pointRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Temperature-Enthalpy (T-H) Diagram', color: '#e0e0e6' },
                        legend: { labels: { color: '#8a8a9a' } }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Enthalpy (kW)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { title: { display: true, text: 'Temperature (Â°C)', color: '#8a8a9a' }, ticks: { color: '#8a8a9a' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }


        // ===== Unit Converter =====
        const conversionHistory = [];

        const unitConversions = {
            length: {
                units: ['m', 'ft', 'in', 'cm', 'mm', 'km', 'mi', 'yd'],
                toBase: { 'm': 1, 'ft': 0.3048, 'in': 0.0254, 'cm': 0.01, 'mm': 0.001, 'km': 1000, 'mi': 1609.34, 'yd': 0.9144 }
            },
            mass: {
                units: ['kg', 'lb', 'g', 'oz', 'ton', 'tonne'],
                toBase: { 'kg': 1, 'lb': 0.453592, 'g': 0.001, 'oz': 0.0283495, 'ton': 907.185, 'tonne': 1000 }
            },
            temperature: {
                units: ['Â°C', 'Â°F', 'K', 'Â°R'],
                special: true
            },
            pressure: {
                units: ['kPa', 'bar', 'psi', 'atm', 'mmHg', 'Pa', 'MPa', 'inHg', 'inH2O'],
                toBase: { 'kPa': 1, 'bar': 100, 'psi': 6.89476, 'atm': 101.325, 'mmHg': 0.133322, 'Pa': 0.001, 'MPa': 1000, 'inHg': 3.38639, 'inH2O': 0.249089 }
            },
            flow: {
                units: ['m3/h', 'gpm', 'L/s', 'L/min', 'ft3/min', 'bbl/day', 'm3/s'],
                toBase: { 'm3/h': 1, 'gpm': 0.227125, 'L/s': 3.6, 'L/min': 0.06, 'ft3/min': 1.69901, 'bbl/day': 0.00663, 'm3/s': 3600 }
            },
            volume: {
                units: ['L', 'gal', 'm3', 'ft3', 'mL', 'bbl', 'in3'],
                toBase: { 'L': 1, 'gal': 3.78541, 'm3': 1000, 'ft3': 28.3168, 'mL': 0.001, 'bbl': 158.987, 'in3': 0.0163871 }
            },
            energy: {
                units: ['kJ', 'BTU', 'cal', 'kcal', 'J', 'kWh', 'MJ'],
                toBase: { 'kJ': 1, 'BTU': 1.05506, 'cal': 0.004184, 'kcal': 4.184, 'J': 0.001, 'kWh': 3600, 'MJ': 1000 }
            },
            power: {
                units: ['kW', 'hp', 'W', 'BTU/hr', 'MW', 'kcal/hr'],
                toBase: { 'kW': 1, 'hp': 0.7457, 'W': 0.001, 'BTU/hr': 0.000293071, 'MW': 1000, 'kcal/hr': 0.001163 }
            },
            density: {
                units: ['kg/m3', 'lb/ft3', 'g/cm3', 'g/mL', 'lb/gal'],
                toBase: { 'kg/m3': 1, 'lb/ft3': 16.0185, 'g/cm3': 1000, 'g/mL': 1000, 'lb/gal': 119.826 }
            },
            viscosity: {
                units: ['PaÂ·s', 'cP', 'mPaÂ·s', 'lb/(ftÂ·s)', 'poise'],
                toBase: { 'PaÂ·s': 1, 'cP': 0.001, 'mPaÂ·s': 0.001, 'lb/(ftÂ·s)': 1.48816, 'poise': 0.1 }
            },
            velocity: {
                units: ['m/s', 'ft/s', 'km/h', 'mph', 'knot'],
                toBase: { 'm/s': 1, 'ft/s': 0.3048, 'km/h': 0.277778, 'mph': 0.44704, 'knot': 0.514444 }
            },
            area: {
                units: ['m2', 'ft2', 'cm2', 'in2', 'acre', 'ha'],
                toBase: { 'm2': 1, 'ft2': 0.092903, 'cm2': 0.0001, 'in2': 0.00064516, 'acre': 4046.86, 'ha': 10000 }
            }
        };

        function updateConversionUnits() {
            const category = document.getElementById('convCategory').value;
            const fromSelect = document.getElementById('convFromUnit');
            const toSelect = document.getElementById('convToUnit');
            const data = unitConversions[category];

            fromSelect.innerHTML = data.units.map((u, i) => `<option value="${u}" ${i === 0 ? 'selected' : ''}>${u}</option>`).join('');
            toSelect.innerHTML = data.units.map((u, i) => `<option value="${u}" ${i === 1 ? 'selected' : ''}>${u}</option>`).join('');

            convertUnits();
        }

        function convertUnits() {
            const category = document.getElementById('convCategory').value;
            const fromValue = parseFloat(document.getElementById('convFromValue').value) || 0;
            const fromUnit = document.getElementById('convFromUnit').value;
            const toUnit = document.getElementById('convToUnit').value;

            let result;
            const data = unitConversions[category];

            if (category === 'temperature') {
                // Special handling for temperature
                let celsius;
                switch (fromUnit) {
                    case 'Â°C': celsius = fromValue; break;
                    case 'Â°F': celsius = (fromValue - 32) * 5 / 9; break;
                    case 'K': celsius = fromValue - 273.15; break;
                    case 'Â°R': celsius = (fromValue - 491.67) * 5 / 9; break;
                }
                switch (toUnit) {
                    case 'Â°C': result = celsius; break;
                    case 'Â°F': result = celsius * 9 / 5 + 32; break;
                    case 'K': result = celsius + 273.15; break;
                    case 'Â°R': result = (celsius + 273.15) * 9 / 5; break;
                }
            } else {
                // Standard conversion through base unit
                const baseValue = fromValue * data.toBase[fromUnit];
                result = baseValue / data.toBase[toUnit];
            }

            document.getElementById('convToValue').value = result.toPrecision(6);

            // Update formula display
            const factor = result / fromValue;
            document.getElementById('convFormula').innerHTML =
                `${fromValue} ${fromUnit} = <strong>${result.toPrecision(6)}</strong> ${toUnit}<br>` +
                `<small>Factor: 1 ${fromUnit} = ${(factor || 0).toPrecision(6)} ${toUnit}</small>`;

            // Add to history
            addToHistory(fromValue, fromUnit, result, toUnit);
        }

        function swapUnits() {
            const fromSelect = document.getElementById('convFromUnit');
            const toSelect = document.getElementById('convToUnit');
            const fromValue = document.getElementById('convFromValue');
            const toValue = document.getElementById('convToValue');

            const tempUnit = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = tempUnit;

            fromValue.value = toValue.value;

            convertUnits();
        }

        function addToHistory(fromVal, fromUnit, toVal, toUnit) {
            const entry = `${fromVal} ${fromUnit} â†’ ${parseFloat(toVal).toPrecision(6)} ${toUnit}`;

            // Don't add duplicates
            if (conversionHistory[0] === entry) return;

            conversionHistory.unshift(entry);
            if (conversionHistory.length > 8) conversionHistory.pop();

            const historyDiv = document.getElementById('convHistoryList');
            historyDiv.innerHTML = conversionHistory.map(h =>
                `<div class="history-item">${h}</div>`
            ).join('');
        }

        function quickConvert(category, value, fromUnit, toUnit) {
            document.getElementById('convCategory').value = category;
            updateConversionUnits();
            document.getElementById('convFromValue').value = value;
            document.getElementById('convFromUnit').value = fromUnit;
            document.getElementById('convToUnit').value = toUnit;
            convertUnits();
        }

        // Initialize converter on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('convCategory')) {
                updateConversionUnits();
            }
        });

        // ===== Chemical Database =====
        const chemicalDatabase = [
            // Alkanes
            { name: 'Methane', formula: 'CHâ‚„', mw: 16.04, tb: -161.5, tc: 190.6, pc: 4.60, omega: 0.011, rho: 0.657, cat: 'alkane', antoineA: 6.61184, antoineB: 389.93, antoineC: 266.0 },
            { name: 'Ethane', formula: 'Câ‚‚Hâ‚†', mw: 30.07, tb: -88.6, tc: 305.3, pc: 4.87, omega: 0.099, rho: 0.546, cat: 'alkane', antoineA: 6.80266, antoineB: 656.40, antoineC: 256.0 },
            { name: 'Propane', formula: 'Câ‚ƒHâ‚ˆ', mw: 44.10, tb: -42.1, tc: 369.8, pc: 4.25, omega: 0.152, rho: 0.493, cat: 'alkane', antoineA: 6.82973, antoineB: 803.81, antoineC: 247.04 },
            { name: 'n-Butane', formula: 'Câ‚„Hâ‚â‚€', mw: 58.12, tb: -0.5, tc: 425.1, pc: 3.80, omega: 0.200, rho: 0.573, cat: 'alkane', antoineA: 6.82485, antoineB: 943.453, antoineC: 239.711 },
            { name: 'n-Pentane', formula: 'Câ‚…Hâ‚â‚‚', mw: 72.15, tb: 36.1, tc: 469.7, pc: 3.37, omega: 0.252, rho: 0.626, cat: 'alkane', antoineA: 6.87632, antoineB: 1075.78, antoineC: 233.205 },
            { name: 'n-Hexane', formula: 'Câ‚†Hâ‚â‚„', mw: 86.18, tb: 68.7, tc: 507.6, pc: 3.03, omega: 0.301, rho: 0.659, cat: 'alkane', antoineA: 6.87601, antoineB: 1171.17, antoineC: 224.41 },
            { name: 'n-Heptane', formula: 'Câ‚‡Hâ‚â‚†', mw: 100.20, tb: 98.4, tc: 540.2, pc: 2.74, omega: 0.350, rho: 0.684, cat: 'alkane', antoineA: 6.89386, antoineB: 1264.37, antoineC: 216.64 },
            { name: 'n-Octane', formula: 'Câ‚ˆHâ‚â‚ˆ', mw: 114.23, tb: 125.7, tc: 568.7, pc: 2.49, omega: 0.399, rho: 0.703, cat: 'alkane', antoineA: 6.91868, antoineB: 1351.99, antoineC: 209.155 },
            { name: 'n-Decane', formula: 'Câ‚â‚€Hâ‚‚â‚‚', mw: 142.28, tb: 174.1, tc: 617.7, pc: 2.11, omega: 0.492, rho: 0.730, cat: 'alkane', antoineA: 6.94365, antoineB: 1495.17, antoineC: 193.86 },
            { name: 'Isobutane', formula: 'Câ‚„Hâ‚â‚€', mw: 58.12, tb: -11.7, tc: 408.1, pc: 3.64, omega: 0.181, rho: 0.551, cat: 'alkane', antoineA: 6.74808, antoineB: 882.80, antoineC: 240.0 },
            { name: 'Cyclohexane', formula: 'Câ‚†Hâ‚â‚‚', mw: 84.16, tb: 80.7, tc: 553.5, pc: 4.07, omega: 0.210, rho: 0.779, cat: 'alkane', antoineA: 6.84498, antoineB: 1203.526, antoineC: 222.863 },

            // Aromatics
            { name: 'Benzene', formula: 'Câ‚†Hâ‚†', mw: 78.11, tb: 80.1, tc: 562.2, pc: 4.89, omega: 0.210, rho: 0.879, cat: 'aromatic', antoineA: 6.90565, antoineB: 1211.033, antoineC: 220.79 },
            { name: 'Toluene', formula: 'Câ‚‡Hâ‚ˆ', mw: 92.14, tb: 110.6, tc: 591.8, pc: 4.11, omega: 0.262, rho: 0.867, cat: 'aromatic', antoineA: 6.95464, antoineB: 1344.8, antoineC: 219.48 },
            { name: 'Ethylbenzene', formula: 'Câ‚ˆHâ‚â‚€', mw: 106.17, tb: 136.2, tc: 617.2, pc: 3.61, omega: 0.304, rho: 0.867, cat: 'aromatic', antoineA: 6.95719, antoineB: 1424.255, antoineC: 213.21 },
            { name: 'o-Xylene', formula: 'Câ‚ˆHâ‚â‚€', mw: 106.17, tb: 144.4, tc: 630.3, pc: 3.73, omega: 0.310, rho: 0.880, cat: 'aromatic', antoineA: 6.99891, antoineB: 1474.679, antoineC: 213.69 },
            { name: 'p-Xylene', formula: 'Câ‚ˆHâ‚â‚€', mw: 106.17, tb: 138.4, tc: 616.2, pc: 3.51, omega: 0.321, rho: 0.861, cat: 'aromatic', antoineA: 6.99052, antoineB: 1453.43, antoineC: 215.31 },
            { name: 'Styrene', formula: 'Câ‚ˆHâ‚ˆ', mw: 104.15, tb: 145.2, tc: 636.0, pc: 3.81, omega: 0.297, rho: 0.909, cat: 'aromatic', antoineA: 7.14016, antoineB: 1574.51, antoineC: 224.09 },
            { name: 'Naphthalene', formula: 'Câ‚â‚€Hâ‚ˆ', mw: 128.17, tb: 218.0, tc: 748.4, pc: 4.05, omega: 0.302, rho: 0.962, cat: 'aromatic', antoineA: 7.01065, antoineB: 1733.71, antoineC: 201.86 },

            // Alcohols
            { name: 'Methanol', formula: 'CHâ‚ƒOH', mw: 32.04, tb: 64.7, tc: 512.6, pc: 8.09, omega: 0.565, rho: 0.791, cat: 'alcohol', antoineA: 7.89750, antoineB: 1474.08, antoineC: 229.13 },
            { name: 'Ethanol', formula: 'Câ‚‚Hâ‚…OH', mw: 46.07, tb: 78.4, tc: 513.9, pc: 6.14, omega: 0.644, rho: 0.789, cat: 'alcohol', antoineA: 8.11220, antoineB: 1592.864, antoineC: 226.184 },
            { name: 'n-Propanol', formula: 'Câ‚ƒHâ‚‡OH', mw: 60.10, tb: 97.2, tc: 536.8, pc: 5.17, omega: 0.623, rho: 0.804, cat: 'alcohol', antoineA: 7.99733, antoineB: 1569.70, antoineC: 209.50 },
            { name: 'Isopropanol', formula: 'Câ‚ƒHâ‚‡OH', mw: 60.10, tb: 82.3, tc: 508.3, pc: 4.76, omega: 0.665, rho: 0.786, cat: 'alcohol', antoineA: 8.11778, antoineB: 1580.92, antoineC: 219.61 },
            { name: 'n-Butanol', formula: 'Câ‚„Hâ‚‰OH', mw: 74.12, tb: 117.7, tc: 563.1, pc: 4.42, omega: 0.593, rho: 0.810, cat: 'alcohol', antoineA: 7.36366, antoineB: 1305.198, antoineC: 173.427 },
            { name: 'Ethylene Glycol', formula: 'Câ‚‚Hâ‚†Oâ‚‚', mw: 62.07, tb: 197.3, tc: 720.0, pc: 8.20, omega: 0.487, rho: 1.113, cat: 'alcohol', antoineA: 8.0908, antoineB: 2088.94, antoineC: 203.454 },

            // Inorganics
            { name: 'Water', formula: 'Hâ‚‚O', mw: 18.02, tb: 100.0, tc: 647.1, pc: 22.06, omega: 0.344, rho: 0.997, cat: 'inorganic', antoineA: 7.96681, antoineB: 1668.21, antoineC: 228.0 },
            { name: 'Ammonia', formula: 'NHâ‚ƒ', mw: 17.03, tb: -33.3, tc: 405.5, pc: 11.28, omega: 0.253, rho: 0.682, cat: 'inorganic', antoineA: 7.55466, antoineB: 1002.711, antoineC: 247.885 },
            { name: 'Carbon Dioxide', formula: 'COâ‚‚', mw: 44.01, tb: -78.5, tc: 304.2, pc: 7.38, omega: 0.224, rho: 1.98, cat: 'inorganic', antoineA: 6.81228, antoineB: 1301.679, antoineC: 266.0 },
            { name: 'Hydrogen Sulfide', formula: 'Hâ‚‚S', mw: 34.08, tb: -60.3, tc: 373.5, pc: 9.01, omega: 0.094, rho: 1.19, cat: 'inorganic', antoineA: 6.99358, antoineB: 768.129, antoineC: 248.13 },
            { name: 'Sulfur Dioxide', formula: 'SOâ‚‚', mw: 64.07, tb: -10.0, tc: 430.8, pc: 7.88, omega: 0.245, rho: 1.46, cat: 'inorganic', antoineA: 7.28316, antoineB: 999.90, antoineC: 237.19 },
            { name: 'Nitrogen', formula: 'Nâ‚‚', mw: 28.01, tb: -195.8, tc: 126.2, pc: 3.40, omega: 0.037, rho: 0.808, cat: 'inorganic', antoineA: 6.49457, antoineB: 255.68, antoineC: 266.55 },
            { name: 'Oxygen', formula: 'Oâ‚‚', mw: 32.00, tb: -183.0, tc: 154.6, pc: 5.04, omega: 0.022, rho: 1.14, cat: 'inorganic', antoineA: 6.69144, antoineB: 319.01, antoineC: 266.70 },
            { name: 'Hydrogen', formula: 'Hâ‚‚', mw: 2.02, tb: -252.9, tc: 33.2, pc: 1.30, omega: -0.216, rho: 0.071, cat: 'inorganic', antoineA: 5.93324, antoineB: 71.55, antoineC: 276.34 },
            { name: 'Carbon Monoxide', formula: 'CO', mw: 28.01, tb: -191.5, tc: 132.9, pc: 3.50, omega: 0.048, rho: 0.789, cat: 'inorganic', antoineA: 6.24021, antoineB: 230.27, antoineC: 260.0 },
            { name: 'Chlorine', formula: 'Clâ‚‚', mw: 70.91, tb: -34.0, tc: 417.2, pc: 7.98, omega: 0.069, rho: 1.56, cat: 'inorganic', antoineA: 6.9318, antoineB: 861.34, antoineC: 246.33 },

            // Other Organics
            { name: 'Acetone', formula: 'Câ‚ƒHâ‚†O', mw: 58.08, tb: 56.1, tc: 508.2, pc: 4.70, omega: 0.307, rho: 0.790, cat: 'organic', antoineA: 7.11714, antoineB: 1210.595, antoineC: 229.664 },
            { name: 'Acetic Acid', formula: 'Câ‚‚Hâ‚„Oâ‚‚', mw: 60.05, tb: 117.9, tc: 591.9, pc: 5.79, omega: 0.467, rho: 1.049, cat: 'organic', antoineA: 7.38782, antoineB: 1533.313, antoineC: 222.309 },
            { name: 'Acetaldehyde', formula: 'Câ‚‚Hâ‚„O', mw: 44.05, tb: 20.2, tc: 466.0, pc: 5.57, omega: 0.291, rho: 0.788, cat: 'organic', antoineA: 7.05648, antoineB: 1070.60, antoineC: 236.0 },
            { name: 'Formaldehyde', formula: 'CHâ‚‚O', mw: 30.03, tb: -19.1, tc: 408.0, pc: 6.59, omega: 0.282, rho: 0.815, cat: 'organic', antoineA: 7.1960, antoineB: 970.0, antoineC: 244.0 },
            { name: 'Diethyl Ether', formula: 'Câ‚„Hâ‚â‚€O', mw: 74.12, tb: 34.6, tc: 466.7, pc: 3.64, omega: 0.281, rho: 0.713, cat: 'organic', antoineA: 6.92032, antoineB: 1064.07, antoineC: 228.80 },
            { name: 'Tetrahydrofuran', formula: 'Câ‚„Hâ‚ˆO', mw: 72.11, tb: 65.0, tc: 540.1, pc: 5.19, omega: 0.225, rho: 0.889, cat: 'organic', antoineA: 6.99515, antoineB: 1202.29, antoineC: 226.254 },
            { name: 'Chloroform', formula: 'CHClâ‚ƒ', mw: 119.38, tb: 61.2, tc: 536.4, pc: 5.47, omega: 0.222, rho: 1.489, cat: 'organic', antoineA: 6.95465, antoineB: 1170.966, antoineC: 226.232 },
            { name: 'Carbon Tetrachloride', formula: 'CClâ‚„', mw: 153.82, tb: 76.7, tc: 556.4, pc: 4.56, omega: 0.193, rho: 1.594, cat: 'organic', antoineA: 6.93390, antoineB: 1242.43, antoineC: 230.0 },
            { name: 'Dichloromethane', formula: 'CHâ‚‚Clâ‚‚', mw: 84.93, tb: 39.6, tc: 510.0, pc: 6.08, omega: 0.199, rho: 1.326, cat: 'organic', antoineA: 7.08030, antoineB: 1138.91, antoineC: 231.45 },
            { name: 'Ethyl Acetate', formula: 'Câ‚„Hâ‚ˆOâ‚‚', mw: 88.11, tb: 77.1, tc: 523.3, pc: 3.88, omega: 0.366, rho: 0.902, cat: 'organic', antoineA: 7.10179, antoineB: 1244.95, antoineC: 217.88 },
            { name: 'Dimethyl Sulfoxide', formula: 'Câ‚‚Hâ‚†OS', mw: 78.13, tb: 189.0, tc: 729.0, pc: 5.65, omega: 0.281, rho: 1.100, cat: 'organic', antoineA: 6.75790, antoineB: 1518.61, antoineC: 179.81 },
            { name: 'N,N-Dimethylformamide', formula: 'Câ‚ƒHâ‚‡NO', mw: 73.09, tb: 153.0, tc: 649.6, pc: 4.42, omega: 0.317, rho: 0.948, cat: 'organic', antoineA: 6.92817, antoineB: 1400.87, antoineC: 196.43 },
            { name: 'Acetonitrile', formula: 'Câ‚‚Hâ‚ƒN', mw: 41.05, tb: 81.6, tc: 545.5, pc: 4.83, omega: 0.338, rho: 0.786, cat: 'organic', antoineA: 7.11988, antoineB: 1314.4, antoineC: 230.0 },
            { name: 'Pyridine', formula: 'Câ‚…Hâ‚…N', mw: 79.10, tb: 115.2, tc: 620.0, pc: 5.63, omega: 0.239, rho: 0.982, cat: 'organic', antoineA: 6.99752, antoineB: 1373.8, antoineC: 214.98 }
        ];

        function populateChemicalsTable() {
            const tbody = document.getElementById('chemicalsTableBody');
            if (!tbody) return;
            tbody.innerHTML = chemicalDatabase.map(chem => `
                <tr onclick="showChemDetail('${chem.name}')" style="cursor: pointer;">
                    <td><strong>${chem.name}</strong></td>
                    <td>${chem.formula}</td>
                    <td>${chem.mw.toFixed(2)}</td>
                    <td>${chem.tb.toFixed(1)}</td>
                    <td>${chem.tc.toFixed(1)}</td>
                    <td>${chem.pc.toFixed(2)}</td>
                    <td>${chem.omega.toFixed(3)}</td>
                    <td>${chem.rho.toFixed(3)} g/mL</td>
                </tr>
            `).join('');
        }

        function filterChemicals() {
            const search = document.getElementById('chemSearch')?.value.toLowerCase() || '';
            const category = document.getElementById('chemCategory')?.value || 'all';
            const tbody = document.getElementById('chemicalsTableBody');
            if (!tbody) return;

            const filtered = chemicalDatabase.filter(chem => {
                const matchSearch = chem.name.toLowerCase().includes(search) ||
                    chem.formula.toLowerCase().includes(search);
                const matchCat = category === 'all' || chem.cat === category;
                return matchSearch && matchCat;
            });

            tbody.innerHTML = filtered.map(chem => `
                <tr onclick="showChemDetail('${chem.name}')" style="cursor: pointer;">
                    <td><strong>${chem.name}</strong></td>
                    <td>${chem.formula}</td>
                    <td>${chem.mw.toFixed(2)}</td>
                    <td>${chem.tb.toFixed(1)}</td>
                    <td>${chem.tc.toFixed(1)}</td>
                    <td>${chem.pc.toFixed(2)}</td>
                    <td>${chem.omega.toFixed(3)}</td>
                    <td>${chem.rho.toFixed(3)} g/mL</td>
                </tr>
            `).join('');
        }

        function showChemDetail(name) {
            const chem = chemicalDatabase.find(c => c.name === name);
            if (!chem) return;

            const panel = document.getElementById('chemDetailPanel');
            const nameEl = document.getElementById('chemDetailName');
            const grid = document.getElementById('chemDetailGrid');

            nameEl.textContent = `${chem.name} (${chem.formula})`;
            grid.innerHTML = `
                <div class="chem-prop"><span>Molecular Weight</span><strong>${chem.mw.toFixed(2)} g/mol</strong></div>
                <div class="chem-prop"><span>Boiling Point</span><strong>${chem.tb.toFixed(1)} Â°C</strong></div>
                <div class="chem-prop"><span>Critical Temperature</span><strong>${chem.tc.toFixed(1)} K</strong></div>
                <div class="chem-prop"><span>Critical Pressure</span><strong>${chem.pc.toFixed(2)} MPa</strong></div>
                <div class="chem-prop"><span>Acentric Factor (Ï‰)</span><strong>${chem.omega.toFixed(3)}</strong></div>
                <div class="chem-prop"><span>Density @ 25Â°C</span><strong>${chem.rho.toFixed(3)} g/mL</strong></div>
                <div class="chem-prop"><span>Antoine A</span><strong>${chem.antoineA.toFixed(5)}</strong></div>
                <div class="chem-prop"><span>Antoine B</span><strong>${chem.antoineB.toFixed(3)}</strong></div>
                <div class="chem-prop"><span>Antoine C</span><strong>${chem.antoineC.toFixed(2)}</strong></div>
                <div class="chem-prop"><span>Vapor Pressure at 25Â°C</span><strong>${calcVaporPressure(chem, 25).toFixed(2)} kPa</strong></div>
            `;
            panel.style.display = 'block';
        }

        function calcVaporPressure(chem, tempC) {
            // Antoine equation: log10(P) = A - B/(T+C), P in mmHg, T in Â°C
            const logP = chem.antoineA - chem.antoineB / (tempC + chem.antoineC);
            return Math.pow(10, logP) * 0.133322; // Convert mmHg to kPa
        }

        // Initialize chemicals table
        document.addEventListener('DOMContentLoaded', () => {
            populateChemicalsTable();
        });

        // ===== Derivation & Examples Toggle =====
        function toggleSection(section) {
            const content = document.getElementById(section + 'Content');
            const icon = document.getElementById(section + 'Icon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.add('rotated');
            } else {
                content.style.display = 'none';
                icon.classList.remove('rotated');
            }
        }

        function renderDerivation(derivation) {
            if (!derivation) return;

            const section = document.getElementById('derivationSection');
            const content = document.getElementById('derivationContent');

            // Simple markdown-like rendering
            let html = derivation
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\$\$(.*?)\$\$/g, '<code class="equation">$1</code>')
                .replace(/^- (.*)/gm, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            html = '<p>' + html + '</p>';
            html = html.replace(/<p><li>/g, '<ul><li>').replace(/<\/li><\/p>/g, '</li></ul>');

            content.innerHTML = html;
            section.style.display = 'block';
        }

        function renderExamples(examples) {
            if (!examples || examples.length === 0) return;

            const section = document.getElementById('examplesSection');
            const content = document.getElementById('examplesContent');

            let html = examples.map((ex, idx) => `
                <div class="example-card">
                    <h5>${ex.title}</h5>
                    <p style="color: var(--text-secondary); margin-bottom: 10px;">${ex.description}</p>
                    
                    <strong style="font-size: 0.85rem;">Inputs:</strong>
                    <div class="example-inputs">
                        ${Object.entries(ex.inputs).map(([k, v]) => `
                            <div class="example-input">
                                <span>${k}:</span> <strong>${v}</strong>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${ex.steps ? `
                        <strong style="font-size: 0.85rem;">Step-by-Step Solution:</strong>
                        <ol class="example-steps">
                            ${ex.steps.map(s => `<li>${s}</li>`).join('')}
                        </ol>
                    ` : ''}
                    
                    ${ex.expected ? `
                        <strong style="font-size: 0.85rem;">Expected Result:</strong>
                        <div class="example-inputs">
                            ${Object.entries(ex.expected).map(([k, v]) => `
                                <div class="example-input">
                                    <span>${k}:</span> <strong>${v}</strong>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${ex.conclusion ? `
                        <div class="example-conclusion">
                            <strong>Conclusion:</strong> ${ex.conclusion}
                        </div>
                    ` : ''}
                    
                    <button class="load-example-btn" onclick="loadExample(${idx})">
                        Load This Example
                    </button>
                </div>
            `).join('');

            content.innerHTML = html;
            section.style.display = 'block';
        }

        let currentExamples = [];

        function loadExample(idx) {
            if (currentExamples[idx]) {
                const ex = currentExamples[idx];
                for (const [key, value] of Object.entries(ex.inputs)) {
                    const input = document.querySelector(`input[data-param="${key}"]`);
                    if (input) {
                        input.value = value;
                    }
                }
            }
        }

        // ================================
        // LEARNING MODE FUNCTIONALITY
        // ================================

        let learningModeActive = false;
        let currentLearningContent = null;
        let currentLearningStep = 0;
        let quizAnswers = {};
        let currentQuizIndex = 0;

        // Learning stats stored in localStorage
        const LEARNING_STORAGE_KEY = 'websterLearningProgress';

        function getLearningProgress() {
            try {
                return JSON.parse(localStorage.getItem(LEARNING_STORAGE_KEY)) || {
                    totalXp: 0,
                    streak: 0,
                    lastDate: null,
                    completed: [],
                    quizScores: {}
                };
            } catch (e) {
                return { totalXp: 0, streak: 0, lastDate: null, completed: [], quizScores: {} };
            }
        }

        function saveLearningProgress(progress) {
            try {
                localStorage.setItem(LEARNING_STORAGE_KEY, JSON.stringify(progress));
            } catch (e) {
                console.warn('Failed to save learning progress:', e);
            }
        }

        function toggleLearningMode() {
            learningModeActive = !learningModeActive;
            const toggle = document.getElementById('learningToggle');
            const xpDisplay = document.getElementById('xpDisplay');

            if (learningModeActive) {
                toggle.classList.add('active');
                toggle.querySelector('.toggle-text').textContent = 'Learning ON';
                xpDisplay.classList.add('show');
                updateXpDisplay();
            } else {
                toggle.classList.remove('active');
                toggle.querySelector('.toggle-text').textContent = 'Learning Mode';
                xpDisplay.classList.remove('show');
            }

            // Refresh current equation view if one is selected
            if (currentEquation) {
                selectEquation(currentCategory, currentEquation);
            }
        }

        function updateXpDisplay() {
            const progress = getLearningProgress();
            document.getElementById('totalXp').textContent = progress.totalXp;

            const streakBadge = document.getElementById('streakBadge');
            if (progress.streak > 0) {
                streakBadge.style.display = 'inline-flex';
                document.getElementById('streakCount').textContent = progress.streak;
            } else {
                streakBadge.style.display = 'none';
            }
        }

        function showXpPopup(amount) {
            const popup = document.getElementById('xpPopup');
            popup.textContent = `+${amount} XP`;
            popup.style.display = 'block';

            // Update XP
            const progress = getLearningProgress();
            progress.totalXp += amount;
            saveLearningProgress(progress);
            updateXpDisplay();

            // Hide popup after animation
            setTimeout(() => {
                popup.style.display = 'none';
            }, 1000);
        }

        async function loadLearningContent(category, equationId) {
            try {
                const response = await fetch(`${API_BASE}/api/learning/${category}/${equationId}`);
                const data = await response.json();

                if (data.available) {
                    currentLearningContent = data.content;
                    currentLearningStep = 0;
                    currentQuizIndex = 0;
                    quizAnswers = {};
                    return true;
                }
                return false;
            } catch (e) {
                console.error('Failed to load learning content:', e);
                return false;
            }
        }

        function renderLearningPanel() {
            if (!currentLearningContent) return;

            const lc = currentLearningContent;
            const steps = ['Introduction', 'Variables', 'Input', 'Quiz', 'Solution'];

            let html = `
                <div class="learning-panel active" id="learningPanel">
                    <!-- Progress Stepper -->
                    <div class="learning-stepper">
                        ${steps.map((step, idx) => `
                            <div class="stepper-step ${idx === currentLearningStep ? 'active' : ''} ${idx < currentLearningStep ? 'completed' : ''}">
                                <div class="stepper-circle">${idx < currentLearningStep ? 'âœ“' : idx + 1}</div>
                                <div class="stepper-label">${step}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Step 1: Introduction -->
                    <div class="learning-step-content ${currentLearningStep === 0 ? 'active' : ''}" data-step="0">
                        <div class="step-header">
                            <span class="step-icon">ðŸ“–</span>
                            Background Theory
                        </div>
                        <div class="theory-content">
                            ${lc.background_theory.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}
                        </div>
                        
                        ${lc.key_concepts && lc.key_concepts.length > 0 ? `
                            <div class="key-concepts">
                                ${lc.key_concepts.map(c => `<span class="concept-tag">${c}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        ${lc.real_world_applications && lc.real_world_applications.length > 0 ? `
                            <h4 style="margin-top: 20px; color: var(--text-primary);">Real-World Applications</h4>
                            <div class="applications-grid">
                                ${lc.real_world_applications.map(app => `
                                    <div class="application-card">ðŸ“ ${app}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Step 2: Variables -->
                    <div class="learning-step-content ${currentLearningStep === 1 ? 'active' : ''}" data-step="1">
                        <div class="step-header">
                            <span class="step-icon">ðŸ“</span>
                            Understanding the Variables
                        </div>
                        
                        <div class="variable-sources">
                            ${Object.entries(lc.variable_sources || {}).map(([varName, source]) => `
                                <div class="variable-card">
                                    <div class="variable-symbol">${varName}</div>
                                    <div class="variable-info">
                                        <h4>${varName}</h4>
                                        <p>${source}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${lc.common_mistakes && lc.common_mistakes.length > 0 ? `
                            <div class="mistakes-box">
                                <h4>âš ï¸ Common Mistakes to Avoid</h4>
                                <ul>
                                    ${lc.common_mistakes.map(m => `<li>${m}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${lc.pro_tips && lc.pro_tips.length > 0 ? `
                            <div class="tips-box">
                                <h4>ðŸ’¡ Pro Tips</h4>
                                <ul>
                                    ${lc.pro_tips.map(t => `<li>${t}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Step 3: Input (uses existing input form) -->
                    <div class="learning-step-content ${currentLearningStep === 2 ? 'active' : ''}" data-step="2">
                        <div class="step-header">
                            <span class="step-icon">âœï¸</span>
                            Enter Your Values
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Apply what you've learned! Enter the values for your calculation.
                        </p>
                        <div id="learningInputGrid"></div>
                    </div>
                    
                    <!-- Step 4: Quiz -->
                    <div class="learning-step-content ${currentLearningStep === 3 ? 'active' : ''}" data-step="3">
                        <div class="step-header">
                            <span class="step-icon">â“</span>
                            Knowledge Check
                        </div>
                        <div id="quizContainer"></div>
                    </div>
                    
                    <!-- Step 5: Solution -->
                    <div class="learning-step-content ${currentLearningStep === 4 ? 'active' : ''}" data-step="4">
                        <div class="step-header">
                            <span class="step-icon">ðŸŽ‰</span>
                            Your Results
                        </div>
                        <div id="learningResultsContainer"></div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="learning-nav">
                        <button class="learning-nav-btn prev" onclick="prevLearningStep()" ${currentLearningStep === 0 ? 'disabled' : ''}>
                            â† Previous
                        </button>
                        <button class="learning-nav-btn next" onclick="nextLearningStep()">
                            ${currentLearningStep === steps.length - 1 ? 'Complete âœ“' : 'Next â†’'}
                        </button>
                    </div>
                </div>
            `;

            return html;
        }

        function renderQuiz() {
            if (!currentLearningContent || !currentLearningContent.quiz_questions) return;

            const questions = currentLearningContent.quiz_questions;
            if (currentQuizIndex >= questions.length) {
                // All questions answered, show summary
                showQuizSummary();
                return;
            }

            const q = questions[currentQuizIndex];
            const container = document.getElementById('quizContainer');

            let html = `
                <div class="quiz-progress">
                    Question ${currentQuizIndex + 1} of ${questions.length}
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" style="width: ${((currentQuizIndex) / questions.length) * 100}%"></div>
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">${q.question}</div>
                    
                    <div class="quiz-options" id="quizOptions">
                        ${q.question_type === 'multiple_choice' ?
                    q.options.map((opt, idx) => `
                                <div class="quiz-option" data-answer="${opt}" onclick="selectQuizOption(this, '${opt.replace(/'/g, "\\'")}')">
                                    ${opt}
                                </div>
                            `).join('') : `
                            <input type="text" class="input-field" id="quizNumericInput" style="max-width: 200px;" placeholder="Enter your answer...">
                        `}
                    </div>
                    
                    <button class="quiz-hint-btn" onclick="showQuizHint()">ðŸ’¡ Need a hint?</button>
                    <div class="quiz-hint" id="quizHint">${q.hint || 'Think about the key concepts covered earlier.'}</div>
                    
                    <div class="quiz-feedback" id="quizFeedback"></div>
                    
                    <button class="calculate-btn" style="margin-top: 20px; max-width: 200px;" onclick="submitQuizAnswer()">
                        Submit Answer
                    </button>
                </div>
            `;

            container.innerHTML = html;
        }

        function selectQuizOption(element, answer) {
            document.querySelectorAll('.quiz-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            quizAnswers[currentQuizIndex] = answer;
        }

        function showQuizHint() {
            document.getElementById('quizHint').classList.add('show');
        }

        function submitQuizAnswer() {
            const questions = currentLearningContent.quiz_questions;
            const q = questions[currentQuizIndex];

            let userAnswer;
            if (q.question_type === 'multiple_choice') {
                userAnswer = quizAnswers[currentQuizIndex];
            } else {
                userAnswer = document.getElementById('quizNumericInput')?.value;
            }

            if (!userAnswer) {
                alert('Please select or enter an answer');
                return;
            }

            // Validate answer (simple client-side check)
            let isCorrect = false;
            if (q.question_type === 'numeric') {
                const userVal = parseFloat(userAnswer);
                const correctVal = parseFloat(q.correct_answer);
                isCorrect = Math.abs(userVal - correctVal) / Math.max(Math.abs(correctVal), 0.0001) < 0.01;
            } else {
                isCorrect = userAnswer.toLowerCase().trim() === q.correct_answer.toLowerCase().trim();
            }

            // Show feedback
            const feedback = document.getElementById('quizFeedback');
            feedback.className = `quiz-feedback show ${isCorrect ? 'correct' : 'incorrect'}`;
            feedback.innerHTML = `
                <strong>${isCorrect ? 'âœ“ Correct!' : 'âœ— Not quite...'}</strong><br>
                ${q.explanation}
            `;

            // Mark options
            if (q.question_type === 'multiple_choice') {
                document.querySelectorAll('.quiz-option').forEach(el => {
                    if (el.dataset.answer === q.correct_answer) {
                        el.classList.add('correct');
                    } else if (el.classList.contains('selected') && !isCorrect) {
                        el.classList.add('incorrect');
                    }
                });
            }

            // Award XP if correct
            if (isCorrect) {
                showXpPopup(q.points || 10);
            }

            // Move to next question after delay
            setTimeout(() => {
                currentQuizIndex++;
                renderQuiz();
            }, 2000);
        }

        function showQuizSummary() {
            const container = document.getElementById('quizContainer');
            const questions = currentLearningContent.quiz_questions;
            const totalPoints = questions.reduce((sum, q) => sum + (q.points || 10), 0);

            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ðŸŽ“</div>
                    <h3 style="color: var(--success); margin-bottom: 10px;">Quiz Complete!</h3>
                    <p style="color: var(--text-secondary);">
                        You've completed the knowledge check. Click Next to see your calculation results!
                    </p>
                </div>
            `;
        }

        function nextLearningStep() {
            const steps = 5;

            if (currentLearningStep === 2) {
                // Step 3: Copy inputs to learning input grid
                // Values should already be captured
            }

            if (currentLearningStep === 3) {
                // Moving from quiz to results - perform calculation
                calculateLearningMode();
            }

            if (currentLearningStep < steps - 1) {
                currentLearningStep++;
                updateLearningStepUI();

                if (currentLearningStep === 3) {
                    renderQuiz();
                }
            } else {
                // Complete!
                showXpPopup(100);
                const progress = getLearningProgress();
                if (!progress.completed.includes(currentEquation)) {
                    progress.completed.push(currentEquation);
                }
                saveLearningProgress(progress);
            }
        }

        function prevLearningStep() {
            if (currentLearningStep > 0) {
                currentLearningStep--;
                updateLearningStepUI();
            }
        }

        function updateLearningStepUI() {
            // Update stepper
            document.querySelectorAll('.stepper-step').forEach((step, idx) => {
                step.classList.remove('active', 'completed');
                if (idx === currentLearningStep) step.classList.add('active');
                if (idx < currentLearningStep) step.classList.add('completed');
            });

            // Update content visibility
            document.querySelectorAll('.learning-step-content').forEach((content, idx) => {
                content.classList.toggle('active', idx === currentLearningStep);
            });

            // Update nav buttons
            document.querySelector('.learning-nav-btn.prev').disabled = currentLearningStep === 0;
            document.querySelector('.learning-nav-btn.next').textContent =
                currentLearningStep === 4 ? 'Complete âœ“' : 'Next â†’';
        }

        async function calculateLearningMode() {
            // Gather inputs from the learning mode input form
            const inputs = {};
            for (const param of equationParams) {
                // Try learning-specific inputs first, fall back to regular inputs
                let valueEl = document.getElementById(`learning_input_${param.name}`);
                let unitEl = document.getElementById(`learning_unit_${param.name}`);

                // Fallback to regular inputs if learning inputs not found
                if (!valueEl) {
                    valueEl = document.getElementById(`input_${param.name}`);
                    unitEl = document.getElementById(`unit_${param.name}`);
                }

                const value = parseFloat(valueEl?.value);

                if (!isNaN(value)) {
                    inputs[param.name] = {
                        value: value,
                        unit: unitEl?.value || ''
                    };
                }
            }

            try {
                // Get both calculation and explanation
                const calcResponse = await fetch(`${API_BASE}/api/calculate/${currentCategory}/${currentEquation}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputs })
                });
                const calcResult = await calcResponse.json();

                const explainResponse = await fetch(`${API_BASE}/api/learning/${currentCategory}/${currentEquation}/explain`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputs })
                });
                const explainResult = await explainResponse.json();

                renderLearningResults(calcResult, explainResult);
            } catch (e) {
                console.error('Learning mode calculation failed:', e);
                document.getElementById('learningResultsContainer').innerHTML = `
                    <div class="validation-badge fail">âŒ Error</div>
                    <p>Calculation failed. Please check your inputs.</p>
                `;
            }
        }

        function renderLearningResults(calcResult, explainResult) {
            const container = document.getElementById('learningResultsContainer');

            if (!calcResult.success) {
                container.innerHTML = `
                    <div class="validation-badge fail">âŒ Error</div>
                    <p>${calcResult.error || 'Calculation failed'}</p>
                `;
                return;
            }

            let html = `
                <div class="validation-badge pass">âœ“ Calculation Complete</div>
                
                <h4 style="color: var(--text-primary); margin: 20px 0 10px;">Results:</h4>
            `;

            // Output values
            for (const [name, data] of Object.entries(calcResult.outputs)) {
                const value = typeof data.value === 'number' ?
                    data.value.toFixed(4) : data.value;
                html += `
                    <div class="result-card">
                        <div class="result-name">${name}</div>
                        <div class="result-value">
                            ${value}
                            <span class="result-unit">${data.unit || ''}</span>
                        </div>
                    </div>
                `;
            }

            // Explanation steps
            if (explainResult.success && explainResult.steps) {
                html += `
                    <h4 style="color: var(--text-primary); margin: 30px 0 10px;">Step-by-Step Explanation:</h4>
                    <div class="explanation-panel show">
                        ${explainResult.steps.map(step => `
                            <div class="explanation-step">
                                <h4>Step ${step.step_number}: ${step.title}</h4>
                                <p>${step.description}</p>
                                ${step.content && step.content.length > 0 ? `
                                    <ul style="margin-top: 10px; padding-left: 20px;">
                                        ${step.content.map(c => `<li style="color: var(--text-secondary); font-size: 0.9rem;">${c}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Modify selectEquation to handle learning mode
        const originalSelectEquation = selectEquation;
        selectEquation = async function (category, equationId) {
            await originalSelectEquation(category, equationId);

            if (learningModeActive) {
                // Remove any existing learning panels first to prevent stacking
                document.querySelectorAll('.learning-panel').forEach(el => el.remove());

                // Reset input section visibility before proceeding
                const inputSection = document.querySelector('.input-section');
                if (inputSection) {
                    inputSection.style.display = '';
                }

                const hasContent = await loadLearningContent(category, equationId);

                if (hasContent) {
                    // Ensure currentLearningStep is reset (loadLearningContent should do this, but be explicit)
                    currentLearningStep = 0;
                    currentQuizIndex = 0;

                    // Hide regular input section, show learning panel
                    if (inputSection) {
                        inputSection.insertAdjacentHTML('beforebegin', renderLearningPanel());
                        inputSection.style.display = 'none';
                    }

                    // Build input form for learning step 3 directly from equationParams
                    // equationParams is set by originalSelectEquation, so it should be current
                    const learningInputGrid = document.getElementById('learningInputGrid');
                    if (learningInputGrid && equationParams && equationParams.length > 0) {
                        learningInputGrid.innerHTML = equationParams.map(param => {
                            const unitOptions = (param.unit_options && param.unit_options.length > 0)
                                ? param.unit_options
                                : (param.unit ? [param.unit] : ['']);
                            const optionsHtml = unitOptions.map(u =>
                                `<option value="${u}" ${u === param.unit ? 'selected' : ''}>${u || 'â€”'}</option>`
                            ).join('');

                            return `
                            <div class="input-group">
                                <label class="input-label ${param.tooltip ? 'tooltip' : ''}" ${param.tooltip ? `data-tooltip="${param.tooltip}"` : ''}>
                                    <span class="symbol">${param.symbol}</span>
                                </label>
                                <input type="number" class="input-field" id="learning_input_${param.name}" 
                                       placeholder="${param.description}" step="any">
                                <select class="unit-select" id="learning_unit_${param.name}">
                                    ${optionsHtml}
                                </select>
                            </div>
                        `}).join('');
                    } else {
                        console.warn('Learning mode: equationParams is empty or learningInputGrid not found');
                    }
                } else {
                    // No learning content - show message but keep input section visible
                    if (inputSection) {
                        inputSection.insertAdjacentHTML('beforebegin', `
                            <div class="learning-panel active" style="text-align: center; padding: 40px;">
                                <div style="font-size: 3rem; margin-bottom: 15px;">ðŸš§</div>
                                <h3 style="color: var(--text-secondary);">Learning content coming soon!</h3>
                                <p style="color: var(--text-muted);">This equation doesn't have learning content yet. Use the regular calculator below.</p>
                            </div>
                        `);
                        // Keep input section visible when no learning content
                        inputSection.style.display = '';
                    }
                }
            }
        };

        // Explain button for non-learning mode
        async function explainResult() {
            if (!currentEquation || !lastCalculationResult) {
                alert('Please perform a calculation first.');
                return;
            }

            // Gather inputs
            const inputs = {};
            for (const param of equationParams) {
                const valueEl = document.getElementById(`input_${param.name}`);
                const unitEl = document.getElementById(`unit_${param.name}`);
                const value = parseFloat(valueEl?.value);
                if (!isNaN(value)) {
                    inputs[param.name] = { value, unit: unitEl?.value || '' };
                }
            }

            try {
                const response = await fetch(`${API_BASE}/api/learning/${currentCategory}/${currentEquation}/explain`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputs })
                });
                const result = await response.json();

                if (result.success) {
                    let panelEl = document.getElementById('explanationPanel');
                    if (!panelEl) {
                        const container = document.getElementById('resultsContent');
                        container.insertAdjacentHTML('beforeend', '<div class="explanation-panel" id="explanationPanel"></div>');
                        panelEl = document.getElementById('explanationPanel');
                    }

                    panelEl.innerHTML = result.steps.map(step => `
                        <div class="explanation-step">
                            <h4>Step ${step.step_number}: ${step.title}</h4>
                            <p>${step.description}</p>
                            ${step.content && step.content.length > 0 ? `
                                <ul style="margin-top: 10px; padding-left: 20px;">
                                    ${step.content.map(c => `<li style="color: var(--text-secondary); font-size: 0.9rem;">${c}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `).join('');

                    panelEl.classList.add('show');
                }
            } catch (e) {
                console.error('Failed to get explanation:', e);
            }
        }

        // Initialize learning mode on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateXpDisplay();
        });

        // ================================
        // INTERACTIVE DIAGRAM GENERATOR
        // ================================

        const DIAGRAM_GENERATORS = {
            gas_tank: generateGasTankDiagram,
            heat_exchanger: generateHeatExchangerDiagram
        };

        function generateGasTankDiagram(values = {}) {
            const P = values.P || '?';
            const V = values.V || '?';
            const T = values.T || '?';
            const n = values.n || '?';

            return `
                <svg class="diagram-svg" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="tankGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#1e3a5f"/>
                            <stop offset="50%" style="stop-color:#2d5a87"/>
                            <stop offset="100%" style="stop-color:#1e3a5f"/>
                        </linearGradient>
                        <linearGradient id="gaugeGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#3b82f6"/>
                            <stop offset="100%" style="stop-color:#1d4ed8"/>
                        </linearGradient>
                    </defs>
                    
                    <!-- Tank Body -->
                    <g class="diagram-element" data-tooltip="Gas Storage Vessel - Volume V">
                        <rect x="80" y="60" width="180" height="180" rx="20" fill="url(#tankGrad)" stroke="#58a6ff" stroke-width="2"/>
                        <ellipse cx="170" cy="60" rx="90" ry="20" fill="#2d5a87" stroke="#58a6ff" stroke-width="2"/>
                        <ellipse cx="170" cy="240" rx="90" ry="20" fill="#1e3a5f" stroke="#58a6ff" stroke-width="2"/>
                    </g>
                    
                    <!-- Gas Molecules -->
                    <g fill="#79c0ff" opacity="0.6">
                        <circle cx="120" cy="100" r="4"><animate attributeName="cy" values="100;110;100" dur="2s" repeatCount="indefinite"/></circle>
                        <circle cx="180" cy="130" r="5"><animate attributeName="cx" values="180;190;180" dur="1.5s" repeatCount="indefinite"/></circle>
                        <circle cx="150" cy="170" r="4"><animate attributeName="cy" values="170;160;170" dur="1.8s" repeatCount="indefinite"/></circle>
                        <circle cx="200" cy="150" r="3"><animate attributeName="cx" values="200;195;200" dur="2.2s" repeatCount="indefinite"/></circle>
                        <circle cx="130" cy="200" r="5"><animate attributeName="cy" values="200;195;200" dur="1.6s" repeatCount="indefinite"/></circle>
                    </g>
                    
                    <!-- Pressure Gauge -->
                    <g class="diagram-element" data-tooltip="Pressure Gauge - Absolute pressure P" transform="translate(280, 80)">
                        <circle cx="30" cy="30" r="28" fill="url(#gaugeGrad)" stroke="#58a6ff" stroke-width="2"/>
                        <circle cx="30" cy="30" r="20" fill="#0d1117"/>
                        <text x="30" y="35" text-anchor="middle" fill="#58a6ff" font-size="12" font-weight="bold">P</text>
                        <line x1="30" y1="30" x2="30" y2="15" stroke="#ef4444" stroke-width="2"/>
                    </g>
                    
                    <!-- Thermometer -->
                    <g class="diagram-element" data-tooltip="Temperature Sensor - Absolute temperature T" transform="translate(320, 160)">
                        <rect x="15" y="0" width="10" height="60" rx="5" fill="#1e3a5f" stroke="#58a6ff"/>
                        <circle cx="20" cy="70" r="12" fill="#ef4444"/>
                        <rect x="17" y="30" width="6" height="35" fill="#ef4444"/>
                        <text x="20" y="95" text-anchor="middle" fill="#8b949e" font-size="10">T</text>
                    </g>
                    
                    <!-- Labels -->
                    <g fill="#f0f6fc" font-size="14" font-weight="500">
                        <text x="170" y="155" text-anchor="middle">n = ${n}</text>
                        <text x="310" y="75" text-anchor="start">P = ${P}</text>
                        <text x="355" y="185" text-anchor="start">T = ${T}</text>
                        <text x="170" y="275" text-anchor="middle" fill="#8b949e">V = ${V}</text>
                    </g>
                    
                    <!-- Equation -->
                    <text x="200" y="25" text-anchor="middle" fill="#58a6ff" font-size="16" font-weight="600">PV = nRT</text>
                </svg>
                <div class="diagram-tooltip" id="diagramTooltip"></div>
            `;
        }

        function generateHeatExchangerDiagram(values = {}) {
            return `
                <svg class="diagram-svg" viewBox="0 0 400 250" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="hotFlow" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ef4444"/>
                            <stop offset="100%" style="stop-color:#f97316"/>
                        </linearGradient>
                        <linearGradient id="coldFlow" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#3b82f6"/>
                            <stop offset="100%" style="stop-color:#06b6d4"/>
                        </linearGradient>
                    </defs>
                    
                    <!-- Shell -->
                    <rect x="50" y="50" width="300" height="100" rx="10" fill="#1e3a5f" stroke="#58a6ff" stroke-width="2"/>
                    
                    <!-- Tubes -->
                    <g stroke="#8b949e" stroke-width="1" fill="none">
                        <path d="M60 70 H340"/>
                        <path d="M60 90 H340"/>
                        <path d="M60 110 H340"/>
                        <path d="M60 130 H340"/>
                    </g>
                    
                    <!-- Hot Fluid Arrows -->
                    <g fill="url(#hotFlow)">
                        <polygon points="30,100 50,85 50,115" />
                        <polygon points="370,100 350,85 350,115" />
                    </g>
                    
                    <!-- Cold Fluid -->
                    <rect x="50" y="160" width="300" height="30" rx="5" fill="url(#coldFlow)" opacity="0.5"/>
                    <text x="200" y="180" text-anchor="middle" fill="#f0f6fc" font-size="12">Shell Side (Cold)</text>
                    
                    <!-- Labels -->
                    <text x="15" y="105" fill="#ef4444" font-size="11">Hot In</text>
                    <text x="355" y="105" fill="#f97316" font-size="11">Hot Out</text>
                    <text x="200" y="40" text-anchor="middle" fill="#58a6ff" font-size="14" font-weight="600">Shell & Tube Heat Exchanger</text>
                </svg>
            `;
        }

        function renderDiagram(diagramType, values) {
            const generator = DIAGRAM_GENERATORS[diagramType];
            if (!generator) return '';

            const container = document.createElement('div');
            container.className = 'diagram-container';
            container.innerHTML = `
                <h4 style="color: var(--text-primary); margin-bottom: 15px;">Interactive Diagram</h4>
                ${generator(values)}
            `;

            return container.outerHTML;
        }

        // Add diagram to learning mode step 1
        function addDiagramToLearning() {
            if (!currentLearningContent || !currentLearningContent.diagram_type) return;

            const step1 = document.querySelector('[data-step="0"]');
            if (step1 && !step1.querySelector('.diagram-container')) {
                const values = {};
                equationParams.forEach(p => {
                    const input = document.getElementById(`input_${p.name}`);
                    if (input && input.value) {
                        values[p.name] = input.value;
                    }
                });

                step1.insertAdjacentHTML('beforeend', renderDiagram(currentLearningContent.diagram_type, values));

                // Setup tooltips
                setupDiagramTooltips();
            }
        }

        function setupDiagramTooltips() {
            document.querySelectorAll('.diagram-element').forEach(el => {
                el.addEventListener('mouseenter', (e) => {
                    const tooltip = document.getElementById('diagramTooltip');
                    if (tooltip && el.dataset.tooltip) {
                        tooltip.textContent = el.dataset.tooltip;
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY - 30}px`;
                        tooltip.classList.add('show');
                    }
                });
                el.addEventListener('mouseleave', () => {
                    const tooltip = document.getElementById('diagramTooltip');
                    if (tooltip) tooltip.classList.remove('show');
                });
            });
        }

        // ================================
        // UNIT CONVERSION PRACTICE MODE
        // ================================

        const PRACTICE_UNITS = {
            pressure: [
                { unit: 'psia', factor: 1 },
                { unit: 'bar', factor: 0.0689476 },
                { unit: 'kPa', factor: 6.89476 },
                { unit: 'atm', factor: 0.068046 }
            ],
            temperature: [
                { unit: 'Â°C', toC: v => v },
                { unit: 'Â°F', toC: v => (v - 32) * 5 / 9 },
                { unit: 'K', toC: v => v - 273.15 },
                { unit: 'Â°R', toC: v => (v - 491.67) * 5 / 9 }
            ],
            flow: [
                { unit: 'gpm', factor: 1 },
                { unit: 'L/min', factor: 3.78541 },
                { unit: 'mÂ³/h', factor: 0.227125 },
                { unit: 'ftÂ³/min', factor: 0.133681 }
            ],
            length: [
                { unit: 'ft', factor: 1 },
                { unit: 'm', factor: 0.3048 },
                { unit: 'in', factor: 12 },
                { unit: 'cm', factor: 30.48 }
            ]
        };

        let practiceStats = { correct: 0, total: 0, streak: 0 };
        let currentPracticeProblem = null;

        function generatePracticeProblem() {
            const categories = Object.keys(PRACTICE_UNITS);
            const category = categories[Math.floor(Math.random() * categories.length)];
            const units = PRACTICE_UNITS[category];

            const fromIdx = Math.floor(Math.random() * units.length);
            let toIdx = Math.floor(Math.random() * units.length);
            while (toIdx === fromIdx) {
                toIdx = Math.floor(Math.random() * units.length);
            }

            const fromUnit = units[fromIdx];
            const toUnit = units[toIdx];

            // Generate reasonable values
            let value;
            switch (category) {
                case 'pressure': value = Math.round((Math.random() * 200 + 10) * 10) / 10; break;
                case 'temperature':
                    if (fromUnit.unit === 'Â°C') value = Math.round((Math.random() * 200 - 50) * 10) / 10;
                    else if (fromUnit.unit === 'Â°F') value = Math.round((Math.random() * 400 - 100) * 10) / 10;
                    else if (fromUnit.unit === 'K') value = Math.round((Math.random() * 300 + 200) * 10) / 10;
                    else value = Math.round((Math.random() * 500 + 400) * 10) / 10;
                    break;
                case 'flow': value = Math.round((Math.random() * 500 + 10) * 10) / 10; break;
                case 'length': value = Math.round((Math.random() * 100 + 1) * 10) / 10; break;
                default: value = Math.round(Math.random() * 100 + 1);
            }

            // Calculate answer
            let answer;
            if (category === 'temperature') {
                const celsius = fromUnit.toC(value);
                if (toUnit.unit === 'Â°C') answer = celsius;
                else if (toUnit.unit === 'Â°F') answer = celsius * 9 / 5 + 32;
                else if (toUnit.unit === 'K') answer = celsius + 273.15;
                else answer = (celsius + 273.15) * 9 / 5;
            } else {
                answer = (value / fromUnit.factor) * toUnit.factor;
            }

            currentPracticeProblem = {
                category,
                value,
                fromUnit: fromUnit.unit,
                toUnit: toUnit.unit,
                answer: Math.round(answer * 1000) / 1000
            };

            renderPracticeProblem();
        }

        function renderPracticeProblem() {
            const p = currentPracticeProblem;
            if (!p) return;

            const container = document.getElementById('practiceContent');
            if (!container) return;

            container.innerHTML = `
                <div class="practice-problem">
                    <div class="practice-question">
                        Convert <span class="from-value">${p.value} ${p.fromUnit}</span> 
                        to <span class="to-unit">${p.toUnit}</span>
                    </div>
                    
                    <div class="practice-input-row">
                        <input type="number" class="practice-input" id="practiceAnswer" 
                               placeholder="Your answer" step="any" onkeypress="if(event.key==='Enter')checkPracticeAnswer()">
                        <span class="practice-result-unit">${p.toUnit}</span>
                    </div>
                    
                    <button class="calculate-btn" onclick="checkPracticeAnswer()">Check Answer</button>
                    <button class="learning-nav-btn prev" onclick="generatePracticeProblem()" style="margin-left: 10px;">Skip â†’</button>
                    
                    <div class="practice-feedback" id="practiceFeedback"></div>
                    
                    <div class="practice-stats">
                        <div class="practice-stat">
                            <div class="practice-stat-value">${practiceStats.correct}</div>
                            <div class="practice-stat-label">Correct</div>
                        </div>
                        <div class="practice-stat">
                            <div class="practice-stat-value">${practiceStats.total}</div>
                            <div class="practice-stat-label">Attempted</div>
                        </div>
                        <div class="practice-stat">
                            <div class="practice-stat-value">${practiceStats.streak}ðŸ”¥</div>
                            <div class="practice-stat-label">Streak</div>
                        </div>
                        <div class="practice-stat">
                            <div class="practice-stat-value">${practiceStats.total > 0 ? Math.round(practiceStats.correct / practiceStats.total * 100) : 0}%</div>
                            <div class="practice-stat-label">Accuracy</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('practiceAnswer').focus();
        }

        function checkPracticeAnswer() {
            const input = document.getElementById('practiceAnswer');
            const userAnswer = parseFloat(input.value);

            if (isNaN(userAnswer)) {
                alert('Please enter a number');
                return;
            }

            const correctAnswer = currentPracticeProblem.answer;
            const tolerance = Math.abs(correctAnswer) * 0.02; // 2% tolerance
            const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;

            practiceStats.total++;

            const feedback = document.getElementById('practiceFeedback');
            if (isCorrect) {
                practiceStats.correct++;
                practiceStats.streak++;
                feedback.className = 'practice-feedback show correct';
                feedback.innerHTML = `âœ“ Correct! ${currentPracticeProblem.value} ${currentPracticeProblem.fromUnit} = ${correctAnswer.toFixed(3)} ${currentPracticeProblem.toUnit}`;

                if (learningModeActive) {
                    showXpPopup(15);
                }
            } else {
                practiceStats.streak = 0;
                feedback.className = 'practice-feedback show incorrect';
                feedback.innerHTML = `âœ— Not quite. The answer is ${correctAnswer.toFixed(3)} ${currentPracticeProblem.toUnit}`;
            }

            // Generate next problem after delay
            setTimeout(() => {
                generatePracticeProblem();
            }, 2000);
        }

        // Initialize practice mode when tab is clicked
        function initPracticeMode() {
            const container = document.getElementById('practiceContent');
            if (container && !currentPracticeProblem) {
                generatePracticeProblem();
            }
        }

        // ================================
        // EXPORT STUDY NOTES (PDF)
        // ================================

        async function exportStudyNotes() {
            if (!currentLearningContent && !currentEquation) {
                alert('Please select an equation with learning content first.');
                return;
            }

            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('PDF library not loaded. Please refresh the page.');
                return;
            }

            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = 20;

            // Helper functions
            const addTitle = (text, size = 16) => {
                doc.setFontSize(size);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(58, 100, 180);
                doc.text(text, margin, y);
                y += size * 0.5 + 3;
            };

            const addSubtitle = (text, size = 12) => {
                doc.setFontSize(size);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(60, 60, 60);
                doc.text(text, margin, y);
                y += size * 0.4 + 3;
            };

            const addText = (text, size = 10) => {
                doc.setFontSize(size);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(40, 40, 40);
                const lines = doc.splitTextToSize(text, pageWidth - 2 * margin);
                doc.text(lines, margin, y);
                y += lines.length * (size * 0.35) + 4;
            };

            const addBullet = (text, indent = 5) => {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(40, 40, 40);
                const lines = doc.splitTextToSize(text, pageWidth - 2 * margin - indent);
                doc.text('â€¢', margin + indent, y);
                doc.text(lines, margin + indent + 5, y);
                y += lines.length * 4 + 2;
            };

            const checkPage = (needed = 20) => {
                if (y + needed > doc.internal.pageSize.getHeight() - 20) {
                    doc.addPage();
                    y = 20;
                }
            };

            // Header
            doc.setFillColor(58, 100, 180);
            doc.rect(0, 0, pageWidth, 35, 'F');
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(255, 255, 255);
            doc.text('Webster Engineering Study Notes', margin, 22);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth - margin - 60, 22);

            y = 50;

            // Equation Title
            const eqTitle = document.getElementById('eqTitle')?.textContent || currentEquation;
            addTitle(eqTitle, 16);

            // Description
            const eqDesc = document.getElementById('eqDescription')?.textContent || '';
            if (eqDesc) {
                addText(eqDesc);
            }

            y += 8;

            // Learning Content
            if (currentLearningContent) {
                const lc = currentLearningContent;

                // Background Theory
                if (lc.background_theory) {
                    checkPage(30);
                    addSubtitle('ðŸ“– Background Theory');
                    addText(lc.background_theory.replace(/\*\*/g, ''));
                    y += 5;
                }

                // Key Concepts
                if (lc.key_concepts && lc.key_concepts.length > 0) {
                    checkPage(20);
                    addSubtitle('ðŸ”‘ Key Concepts');
                    lc.key_concepts.forEach(c => addBullet(c));
                    y += 5;
                }

                // Real-World Applications
                if (lc.real_world_applications && lc.real_world_applications.length > 0) {
                    checkPage(20);
                    addSubtitle('ðŸŒ Real-World Applications');
                    lc.real_world_applications.forEach(app => addBullet(app));
                    y += 5;
                }

                // Common Mistakes
                if (lc.common_mistakes && lc.common_mistakes.length > 0) {
                    checkPage(20);
                    addSubtitle('âš ï¸ Common Mistakes');
                    lc.common_mistakes.forEach(m => addBullet(m));
                    y += 5;
                }

                // Pro Tips
                if (lc.pro_tips && lc.pro_tips.length > 0) {
                    checkPage(20);
                    addSubtitle('ðŸ’¡ Pro Tips');
                    lc.pro_tips.forEach(t => addBullet(t));
                    y += 5;
                }

                // Worked Example
                if (lc.worked_example) {
                    const ex = lc.worked_example;
                    checkPage(40);
                    addSubtitle('ðŸ“ Worked Example: ' + (ex.title || ''));
                    if (ex.scenario) addText('Scenario: ' + ex.scenario);
                    if (ex.given && ex.given.length > 0) {
                        addText('Given: ' + ex.given.join(', '));
                    }
                    if (ex.find) addText('Find: ' + ex.find);

                    if (ex.steps && ex.steps.length > 0) {
                        checkPage(30);
                        addText('Solution Steps:');
                        ex.steps.forEach((step, i) => {
                            checkPage(15);
                            addBullet(`Step ${i + 1}: ${step.title || ''} - ${step.description || ''}`, 3);
                        });
                    }

                    if (ex.final_answer) {
                        addText('Final Answer: ' + ex.final_answer, 11);
                    }
                }
            }

            // Learning Progress
            checkPage(25);
            y += 10;
            addSubtitle('ðŸ“Š Your Progress');
            const progress = getLearningProgress();
            addText(`Total XP Earned: ${progress.totalXp}`);
            addText(`Current Streak: ${progress.streak} days`);
            addText(`Equations Completed: ${progress.completed?.length || 0}`);

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                doc.text('Webster Engineering Equation Solver', margin, doc.internal.pageSize.getHeight() - 10);
            }

            // Save
            const filename = `study_notes_${currentEquation || 'general'}_${Date.now()}.pdf`;
            doc.save(filename);
        }

        // Add export button to learning panel
        function addExportButton() {
            const learnPanel = document.getElementById('learningPanel');
            if (learnPanel && !learnPanel.querySelector('.export-btn')) {
                const nav = learnPanel.querySelector('.learning-nav');
                if (nav) {
                    const btn = document.createElement('button');
                    btn.className = 'learning-nav-btn prev export-btn';
                    btn.innerHTML = 'ðŸ“„ Export Notes';
                    btn.onclick = exportStudyNotes;
                    btn.style.marginLeft = 'auto';
                    nav.appendChild(btn);
                }
            }
        }

    </script>

</body>

</html>