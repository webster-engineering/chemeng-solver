<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webster Engineering Equation Solver</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #121218;
            --bg-secondary: #1a1a22;
            --bg-card: rgba(28, 28, 36, 0.6);
            --bg-glass: rgba(255, 255, 255, 0.025);
            --text-primary: #e0e0e6;
            --text-secondary: #8a8a9a;
            --accent: #5b6eae;
            --accent-light: #7a8bc4;
            --accent-glow: rgba(91, 110, 174, 0.15);
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: rgba(255, 255, 255, 0.06);
            --gradient-1: linear-gradient(135deg, #5b6eae 0%, #6b7db8 100%);
            --gradient-2: linear-gradient(135deg, #121218 0%, #1a1a24 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-2);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Enhanced Animated Background - Orbital Gradients */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(ellipse at 30% 30%, rgba(91, 110, 174, 0.18) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 70%, rgba(107, 125, 184, 0.15) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 50%, rgba(91, 110, 174, 0.10) 0%, transparent 50%);
            pointer-events: none;
            z-index: -2;
            animation: bgOrbit 60s linear infinite;
        }

        @keyframes bgOrbit {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Molecular Hexagonal Lattice Overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='52' viewBox='0 0 60 52'%3E%3Cpath d='M30 0 L60 15 L60 37 L30 52 L0 37 L0 15 Z' fill='none' stroke='rgba(91,110,174,0.025)' stroke-width='0.5'/%3E%3C/svg%3E");
            background-size: 60px 52px;
            pointer-events: none;
            z-index: -1;
            opacity: 0.8;
            animation: latticeShift 120s linear infinite;
        }

        @keyframes latticeShift {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 600px 520px;
            }
        }

        /* Volumetric Glow Pulse */
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(91, 110, 174, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
            animation: glowPulse 8s ease-in-out infinite;
        }

        @keyframes glowPulse {

            0%,
            100% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr 380px;
            min-height: 100vh;
        }

        /* Sidebar with glass effect */
        .sidebar {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            padding: 24px 20px;
            overflow-y: auto;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: logoShine 3s ease-in-out infinite;
        }

        @keyframes logoShine {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.2);
            }
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
            transform: translateY(-1px);
        }

        .category {
            margin-bottom: 8px;
            animation: fadeInUp 0.4s ease-out backwards;
        }

        .category:nth-child(1) {
            animation-delay: 0.05s;
        }

        .category:nth-child(2) {
            animation-delay: 0.1s;
        }

        .category:nth-child(3) {
            animation-delay: 0.15s;
        }

        .category:nth-child(4) {
            animation-delay: 0.2s;
        }

        .category:nth-child(5) {
            animation-delay: 0.25s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-header {
            padding: 12px 14px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            transition: all 0.25s ease;
        }

        .category-header:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .category-count {
            background: var(--accent);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .equation-list {
            display: none;
            padding-left: 12px;
            margin-top: 4px;
        }

        .category.expanded .equation-list {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .equation-item {
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.85rem;
            margin: 3px 0;
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
        }

        .equation-item:hover {
            background: var(--bg-card);
            border-left-color: var(--accent-light);
            padding-left: 18px;
        }

        .equation-item.active {
            background: var(--gradient-1);
            color: white;
            border-left-color: transparent;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        /* Main Content */
        .main-content {
            padding: 40px;
            overflow-y: auto;
        }

        .equation-header {
            margin-bottom: 32px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .equation-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .equation-description {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .equation-reference {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 8px;
            font-style: italic;
            opacity: 0.7;
        }

        .input-section {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            animation: cardSlideIn 0.5s ease-out;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--accent-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--gradient-1);
            border-radius: 2px;
        }

        .input-grid {
            display: grid;
            gap: 18px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 160px 1fr 110px;
            gap: 14px;
            align-items: center;
            animation: fadeInUp 0.3s ease-out backwards;
        }

        .input-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input-label .symbol {
            color: var(--accent-light);
            margin-right: 6px;
            font-weight: 600;
        }

        .input-field {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.25s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow), 0 4px 12px rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.5);
        }

        .input-field:hover:not(:focus) {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .unit-select {
            padding: 12px;
            background: #2a2a3e;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: #ffffff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .unit-select option {
            background: #2a2a3e;
            color: #ffffff;
            padding: 8px;
        }

        .unit-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .reference-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--accent-light);
            text-decoration: none;
            font-size: 0.85rem;
            margin-top: 10px;
            padding: 8px 14px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .reference-link:hover {
            background: rgba(91, 110, 174, 0.1);
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .calculate-btn {
            width: 100%;
            padding: 16px 28px;
            background: var(--gradient-1);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .calculate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .calculate-btn:hover::before {
            left: 100%;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--accent-glow);
        }

        .calculate-btn:active {
            transform: translateY(-1px);
        }

        .calculate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Panel */
        .results-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
        }

        .results-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 24px;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .validation-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 20px;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .validation-badge.pass {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .validation-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .validation-badge.fail {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .result-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 14px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            animation: resultSlideIn 0.4s ease-out backwards;
        }

        .result-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .result-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .result-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes resultSlideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .result-card:hover {
            border-color: var(--accent);
            transform: translateX(-4px);
            box-shadow: 4px 0 20px var(--accent-glow);
        }

        .result-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 1.6rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-unit {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-left: 8px;
            -webkit-text-fill-color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
            animation: fadeIn 0.6s ease-out;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .empty-state h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .tool-card {
            padding: 14px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tool-card:hover {
            border-color: var(--accent);
            background: rgba(91, 110, 174, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--accent-glow);
        }

        .tool-card svg {
            stroke: var(--accent-light);
        }

        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            border: 1px solid var(--border);
            z-index: 100;
            animation: tooltipFade 0.2s ease-out;
        }

        @keyframes tooltipFade {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            background: var(--accent);
            transform: rotate(20deg);
        }

        /* Tips Carousel */
        .tips-carousel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .tips-carousel .tip {
            display: none;
            animation: tipFade 0.5s ease-out;
        }

        .tips-carousel .tip.active {
            display: block;
        }

        .tips-carousel .tip-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .tips-carousel .tip-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .tips-carousel .tip-label {
            font-size: 0.7rem;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        @keyframes tipFade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Equation Preview Tooltip */
        .equation-item {
            position: relative;
        }

        .equation-preview {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            width: 280px;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .equation-item:hover .equation-preview {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
            pointer-events: auto;
        }

        .equation-preview h4 {
            font-size: 0.9rem;
            color: var(--accent-light);
            margin-bottom: 6px;
        }

        .equation-preview p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .equation-preview .preview-inputs {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Input Validation States */
        .input-field.valid {
            border-color: var(--success) !important;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }

        .input-field.warning {
            border-color: var(--warning) !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .input-field.invalid {
            border-color: var(--error) !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        /* Copy Toast */
        .copy-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .copy-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Result Card Copy Interaction */
        .result-card {
            cursor: pointer;
            position: relative;
        }

        .result-card::after {
            content: 'ðŸ“‹ Click to copy';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .result-card:hover::after {
            opacity: 1;
        }

        /* Comparison Mode */
        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .comparison-toggle input {
            accent-color: var(--accent);
        }

        .result-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .result-comparison .result-card {
            font-size: 0.85rem;
        }

        .result-comparison .result-card.previous {
            opacity: 0.6;
            border-style: dashed;
        }

        .delta-indicator {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .delta-indicator.positive {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .delta-indicator.negative {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Calculation Counter */
        .calc-counter {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            z-index: 100;
        }

        .calc-counter strong {
            color: var(--accent-light);
        }

        /* History Dropdown */
        .history-dropdown {
            position: relative;
        }

        .history-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 8px 14px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
            text-align: left;
        }

        .history-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .history-list.show {
            display: block;
        }

        .history-item {
            padding: 10px 14px;
            font-size: 0.8rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .history-item:hover {
            background: rgba(91, 110, 174, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Light Theme */
        body.light-mode {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.6);
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --border: rgba(0, 0, 0, 0.1);
            --gradient-2: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
        }

        body.light-mode::before {
            background:
                radial-gradient(ellipse at 20% 20%, rgba(91, 110, 174, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
        }

        body.light-mode .unit-select,
        body.light-mode .unit-select option {
            background: #f0f0f5;
            color: #1d1d1f;
        }

        body.light-mode .input-field {
            background: rgba(0, 0, 0, 0.03);
            color: #1d1d1f;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* ===============================================
           VISUAL ENHANCEMENTS - Engineering Aesthetics
           =============================================== */

        /* Floating Engineering Symbols Container */
        .floating-symbols {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .floating-symbol {
            position: absolute;
            opacity: 0.04;
            animation: floatDrift 40s ease-in-out infinite;
        }

        .floating-symbol:nth-child(1) {
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .floating-symbol:nth-child(2) {
            top: 60%;
            left: 15%;
            animation-delay: -8s;
        }

        .floating-symbol:nth-child(3) {
            top: 20%;
            right: 10%;
            animation-delay: -16s;
        }

        .floating-symbol:nth-child(4) {
            top: 70%;
            right: 20%;
            animation-delay: -24s;
        }

        .floating-symbol:nth-child(5) {
            top: 40%;
            left: 50%;
            animation-delay: -32s;
        }

        .floating-symbol:nth-child(6) {
            bottom: 15%;
            left: 30%;
            animation-delay: -12s;
        }

        @keyframes floatDrift {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            25% {
                transform: translate(30px, -20px) rotate(5deg);
            }

            50% {
                transform: translate(10px, 30px) rotate(-3deg);
            }

            75% {
                transform: translate(-20px, 10px) rotate(2deg);
            }
        }

        /* Particle Canvas Background */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.6;
        }

        /* Enhanced Button - Neon Edge Glow */
        .calculate-btn {
            position: relative;
            overflow: hidden;
        }

        .calculate-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(90deg, #5b6eae, #6b7db8, #7a8bc4, #6b7db8, #5b6eae);
            background-size: 400% 100%;
            z-index: -1;
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.4s ease;
            animation: neonShift 3s linear infinite;
        }

        .calculate-btn:hover::before {
            opacity: 1;
        }

        @keyframes neonShift {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 400% 50%;
            }
        }

        /* Liquid Metal Ripple Effect on Click */
        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 70%);
            transform: scale(0);
            animation: rippleExpand 0.6s ease-out forwards;
            pointer-events: none;
        }

        @keyframes rippleExpand {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Tool Card Energy Wave Effect */
        .tool-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            z-index: -1;
        }

        .tool-card:hover::before {
            width: 300px;
            height: 300px;
        }

        /* Icon Glow Pulse on Hover */
        .category-header:hover .category-count,
        .equation-item:hover {
            animation: iconGlow 1.5s ease-in-out infinite;
        }

        @keyframes iconGlow {

            0%,
            100% {
                box-shadow: 0 0 5px var(--accent-glow);
            }

            50% {
                box-shadow: 0 0 20px var(--accent-glow), 0 0 30px var(--accent-glow);
            }
        }

        /* Blueprint Line-Draw Animation */
        .blueprint-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawLine 3s ease-out forwards;
        }

        @keyframes drawLine {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* Thermodynamic Contour Decoration */
        .thermo-contour {
            position: absolute;
            opacity: 0.03;
            pointer-events: none;
        }

        .results-panel .thermo-contour {
            bottom: 0;
            right: 0;
            width: 200px;
            height: 200px;
        }

        /* Animated Flask Bubbles */
        @keyframes bubbleRise {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.7;
            }

            50% {
                transform: translateY(-15px) scale(1.2);
                opacity: 0.5;
            }

            100% {
                transform: translateY(-30px) scale(0.8);
                opacity: 0;
            }
        }

        .flask-bubble {
            animation: bubbleRise 2s ease-in-out infinite;
        }

        .flask-bubble:nth-child(1) {
            animation-delay: 0s;
        }

        .flask-bubble:nth-child(2) {
            animation-delay: 0.5s;
        }

        .flask-bubble:nth-child(3) {
            animation-delay: 1s;
        }

        /* Liquid Oscillation in Flask */
        @keyframes liquidWave {

            0%,
            100% {
                d: path('M25 70 Q50 65 75 70 L75 80 Q50 85 25 80 Z');
            }

            50% {
                d: path('M25 70 Q50 75 75 70 L75 80 Q50 75 25 80 Z');
            }
        }

        .flask-liquid {
            animation: liquidWave 3s ease-in-out infinite;
        }

        /* CSS 3D Flask Animation */
        .flask-3d-container {
            perspective: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .flask-3d {
            transform-style: preserve-3d;
            animation: flask3DRotate 20s ease-in-out infinite, flaskFloat 4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(91, 110, 174, 0.4));
        }

        @keyframes flask3DRotate {

            0%,
            100% {
                transform: rotateY(-15deg) rotateX(5deg);
            }

            25% {
                transform: rotateY(10deg) rotateX(-3deg);
            }

            50% {
                transform: rotateY(15deg) rotateX(-5deg);
            }

            75% {
                transform: rotateY(-10deg) rotateX(3deg);
            }
        }

        @keyframes flaskFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .flask-3d:hover {
            animation-play-state: paused;
            transform: rotateY(0deg) rotateX(0deg) scale(1.05);
            transition: transform 0.3s ease;
        }

        /* Typewriter Effect */
        .typewriter {
            overflow: hidden;
            border-right: 2px solid var(--accent);
            white-space: nowrap;
            margin: 20px auto;
            animation: typing 3s steps(40, end), blinkCursor 0.75s step-end infinite;
        }

        @keyframes typing {
            from {
                width: 0;
            }

            to {
                width: 100%;
            }
        }

        @keyframes blinkCursor {

            from,
            to {
                border-color: transparent;
            }

            50% {
                border-color: var(--accent);
            }
        }

        .tagline-fade {
            animation: fadeInUp 1s ease-out 2.5s both;
        }

        /* Engineering Schematics Background */
        .schematics-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.03;
        }

        .schematic-line {
            stroke: var(--accent);
            stroke-width: 1;
            fill: none;
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
            animation: drawLine 8s linear infinite;
        }

        @keyframes drawLine {
            0% {
                stroke-dashoffset: 200;
            }

            50% {
                stroke-dashoffset: 0;
            }

            100% {
                stroke-dashoffset: -200;
            }
        }

        /* Logo Hover Animation */
        .logo:hover {
            animation: logoBounce 0.6s ease;
        }

        .logo:hover svg,
        .logo:hover .logo-icon {
            animation: logoSpin 0.8s ease-in-out;
        }

        @keyframes logoBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            25% {
                transform: translateY(-5px);
            }

            50% {
                transform: translateY(0);
            }

            75% {
                transform: translateY(-3px);
            }
        }

        @keyframes logoSpin {
            0% {
                transform: rotate(0deg) scale(1);
            }

            25% {
                transform: rotate(-10deg) scale(1.1);
            }

            50% {
                transform: rotate(10deg) scale(1.1);
            }

            75% {
                transform: rotate(-5deg) scale(1.05);
            }

            100% {
                transform: rotate(0deg) scale(1);
            }
        }

        /* Category Expansion Animation */
        .category .equations {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 0;
        }

        .category.expanded .equations {
            max-height: 1000px;
            opacity: 1;
        }

        .category-header {
            cursor: pointer;
            position: relative;
            padding-right: 30px;
        }

        .category-header::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            width: 8px;
            height: 8px;
            border-right: 2px solid var(--text-secondary);
            border-bottom: 2px solid var(--text-secondary);
            transform: translateY(-50%) rotate(-45deg);
            transition: transform 0.3s ease;
        }

        .category.expanded .category-header::after {
            transform: translateY(-70%) rotate(45deg);
        }

        /* ===== Tab Navigation ===== */
        .main-tabs {
            display: flex;
            gap: 4px;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .main-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .main-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .main-tab.active {
            color: var(--accent-light);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== Graphing Calculator ===== */
        .graph-calculator {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .graph-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .equation-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .equation-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .equation-row input {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .equation-row input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            padding: 2px;
        }

        .graph-btn {
            padding: 10px 20px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .graph-btn:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
        }

        .graph-btn.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .graph-container {
            flex: 1;
            min-height: 400px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        #graphCanvas {
            width: 100%;
            height: 100%;
        }

        .graph-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(18, 18, 24, 0.9);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .zoom-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .equation-help {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 10px;
            background: rgba(91, 110, 174, 0.1);
            border-radius: 8px;
            margin-top: 10px;
        }

        .equation-help code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .preset-select {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .preset-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .deriv-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .deriv-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .deriv-toggle input:checked+* {
            color: var(--accent);
        }

        .graph-actions {
            display: flex;
            gap: 10px;
        }

        .graph-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-toggle:hover {
            border-color: var(--accent);
        }

        .mode-toggle:has(input:checked) {
            background: rgba(91, 110, 174, 0.2);
            border-color: var(--accent);
            color: var(--accent-light);
        }

        .graph-btn.small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .graph-main {
            display: flex;
            gap: 15px;
            flex: 1;
            min-height: 400px;
        }

        .graph-main .graph-container {
            flex: 1;
        }

        .values-table {
            width: 280px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .values-table h4 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
        }

        .table-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .table-controls label {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .table-controls input {
            width: 50px;
            padding: 4px 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        .table-scroll {
            flex: 1;
            overflow-y: auto;
            max-height: 350px;
        }

        .table-scroll table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .table-scroll th,
        .table-scroll td {
            padding: 6px 8px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .table-scroll th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }

        .trace-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--accent);
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 0 10px var(--accent);
            z-index: 10;
        }

        .graph-results {
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-primary);
            min-height: 40px;
        }

        .graph-results:empty {
            display: none;
        }

        .graph-results .result-item {
            display: inline-block;
            padding: 4px 10px;
            margin: 3px;
            background: rgba(91, 110, 174, 0.15);
            border-radius: 4px;
        }

        /* ===== Scientific Calculator ===== */
        .sci-calculator {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .calc-display {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .calc-history {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-height: 20px;
            text-align: right;
            padding-right: 5px;
        }

        .calc-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 2rem;
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
            outline: none;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .calc-btn {
            padding: 15px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        .calc-btn.number {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .calc-btn.number.wide {
            grid-column: span 2;
        }

        .calc-btn.operator {
            background: rgba(91, 110, 174, 0.2);
            color: var(--accent-light);
        }

        .calc-btn.function {
            background: rgba(91, 110, 174, 0.1);
            font-size: 0.85rem;
        }

        .calc-btn.memory {
            background: rgba(122, 139, 196, 0.1);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .calc-btn.clear {
            background: rgba(220, 80, 80, 0.15);
            color: #e57373;
        }

        .calc-btn.equals {
            background: var(--accent);
            color: white;
            font-size: 1.5rem;
        }

        .calc-btn.equals:hover {
            background: var(--accent-light);
        }

        .calc-btn.const {
            background: rgba(150, 180, 220, 0.15);
            font-style: italic;
        }

        .calc-info {
            margin-top: 10px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ===== Reference Data Panels ===== */
        .reference-panel {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .reference-panel h2 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
        }

        .ref-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .ref-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            align-items: center;
        }

        .ref-controls input,
        .ref-controls select {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .ref-controls input {
            min-width: 200px;
        }

        .ref-controls input:focus,
        .ref-controls select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .ref-table-container {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
        }

        .ref-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .ref-table th,
        .ref-table td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .ref-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        .ref-table th:first-child,
        .ref-table td:first-child {
            text-align: left;
        }

        .ref-table tbody tr:hover {
            background: rgba(91, 110, 174, 0.1);
        }

        .ref-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Gradient Border Effect for Panels */
        .results-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-1);
            opacity: 0.6;
        }

        /* History Dropdown UI */
        .history-dropdown {
            position: relative;
            display: inline-block;
        }

        .history-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 14px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .history-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 280px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 8px;
            padding: 8px;
            z-index: 100;
            display: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .history-menu.show {
            display: block;
            animation: dropdownSlide 0.25s ease-out;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: rgba(91, 110, 174, 0.1);
        }

        .history-item .time {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .history-item .values {
            font-size: 0.8rem;
            color: var(--text-primary);
            margin-top: 4px;
        }

        /* Input Linking Suggestions */
        .link-suggestions {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .link-suggestions h4 {
            font-size: 0.85rem;
            color: var(--accent-light);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .link-suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-glass);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .link-suggestion-item:hover {
            background: rgba(91, 110, 174, 0.12);
            transform: translateX(4px);
        }

        .link-suggestion-item .eq-name {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .link-suggestion-item .param-match {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .link-arrow {
            color: var(--accent);
            font-size: 1.2rem;
        }

        /* Equation Preview Enhancement */
        .equation-preview {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(91, 110, 174, 0.04) 100%);
        }

        .equation-preview .formula {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--accent-light);
            margin: 8px 0;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar,
            .results-panel {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">ðŸŒ™</button>

    <!-- Copy Toast -->
    <div class="copy-toast" id="copyToast">âœ“ Copied to clipboard!</div>

    <!-- Calculation Counter -->
    <div class="calc-counter" id="calcCounter">
        Calculations today: <strong id="calcCount">0</strong>
    </div>

    <!-- Particle Canvas for Molecular Motion -->
    <canvas id="particleCanvas"></canvas>

    <!-- Volumetric Glow -->
    <div class="bg-glow"></div>

    <!-- Engineering Schematics Background -->
    <svg class="schematics-bg" viewBox="0 0 1000 800" preserveAspectRatio="xMidYMid slice">
        <!-- Pipe network lines -->
        <path class="schematic-line" d="M0 200 L200 200 L200 400 L400 400" style="animation-delay: 0s" />
        <path class="schematic-line" d="M1000 300 L800 300 L800 500 L600 500" style="animation-delay: 2s" />
        <path class="schematic-line" d="M500 0 L500 150 L700 150 L700 300" style="animation-delay: 4s" />
        <path class="schematic-line" d="M100 800 L100 600 L300 600 L300 450" style="animation-delay: 1s" />
        <path class="schematic-line" d="M900 800 L900 650 L700 650 L700 550" style="animation-delay: 3s" />
        <!-- Flow diagram elements -->
        <rect class="schematic-line" x="380" y="380" width="40" height="40" style="animation-delay: 5s" />
        <rect class="schematic-line" x="580" y="480" width="40" height="40" style="animation-delay: 6s" />
        <circle class="schematic-line" cx="200" cy="200" r="15" style="animation-delay: 0.5s" />
        <circle class="schematic-line" cx="800" cy="300" r="15" style="animation-delay: 2.5s" />
        <!-- Additional connecting lines -->
        <path class="schematic-line" d="M420 400 L580 500" style="animation-delay: 5.5s" />
        <path class="schematic-line" d="M300 450 L380 400" style="animation-delay: 1.5s" />
    </svg>

    <!-- Floating Engineering Symbols -->
    <div class="floating-symbols">
        <!-- Pump Symbol -->
        <svg class="floating-symbol" width="80" height="80" viewBox="0 0 100 100" fill="none">
            <circle cx="50" cy="50" r="35" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <path d="M30 50 L70 50 M50 30 L50 70" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <path d="M50 15 L50 30 M50 70 L50 85" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
        <!-- Valve Symbol -->
        <svg class="floating-symbol" width="70" height="70" viewBox="0 0 100 100" fill="none">
            <path d="M20 50 L50 30 L80 50 L50 70 Z" stroke="currentColor" stroke-width="2" fill="none" opacity="0.5" />
            <line x1="10" y1="50" x2="20" y2="50" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="80" y1="50" x2="90" y2="50" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
        <!-- Heat Exchanger Symbol -->
        <svg class="floating-symbol" width="90" height="60" viewBox="0 0 120 80" fill="none">
            <ellipse cx="60" cy="40" rx="50" ry="30" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="10" y1="40" x2="30" y2="40" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="90" y1="40" x2="110" y2="40" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <path d="M40 25 L40 55 M50 25 L50 55 M60 25 L60 55 M70 25 L70 55 M80 25 L80 55" stroke="currentColor"
                stroke-width="1" opacity="0.3" />
        </svg>
        <!-- Reactor Symbol -->
        <svg class="floating-symbol" width="60" height="80" viewBox="0 0 80 100" fill="none">
            <rect x="15" y="20" width="50" height="60" rx="5" stroke="currentColor" stroke-width="2" fill="none"
                opacity="0.5" />
            <path d="M30 20 L30 10 L50 10 L50 20" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <circle cx="40" cy="50" r="15" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <line x1="15" y1="80" x2="15" y2="90" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="65" y1="80" x2="65" y2="90" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
        <!-- Distillation Column Symbol -->
        <svg class="floating-symbol" width="50" height="100" viewBox="0 0 60 120" fill="none">
            <rect x="15" y="10" width="30" height="100" rx="3" stroke="currentColor" stroke-width="2" fill="none"
                opacity="0.5" />
            <line x1="15" y1="30" x2="45" y2="30" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <line x1="15" y1="50" x2="45" y2="50" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <line x1="15" y1="70" x2="45" y2="70" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <line x1="15" y1="90" x2="45" y2="90" stroke="currentColor" stroke-width="1" opacity="0.3" />
            <path d="M5 20 L15 20" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <path d="M45 10 L55 10" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
        <!-- Tank Symbol -->
        <svg class="floating-symbol" width="70" height="70" viewBox="0 0 100 100" fill="none">
            <ellipse cx="50" cy="20" rx="30" ry="10" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <ellipse cx="50" cy="80" rx="30" ry="10" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="20" y1="20" x2="20" y2="80" stroke="currentColor" stroke-width="2" opacity="0.5" />
            <line x1="80" y1="20" x2="80" y2="80" stroke="currentColor" stroke-width="2" opacity="0.5" />
        </svg>
    </div>


    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="/" class="logo" style="text-decoration: none;">
                <img src="/logo.png" alt="Webster Engineering" style="height: 40px; filter: invert(1);">
            </a>
            <input type="text" class="search-box" placeholder="Search equations..." id="searchBox">
            <div id="categoryList"></div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Tab Navigation -->
            <div class="main-tabs">
                <button class="main-tab active" onclick="switchTab('equations')">Equations</button>
                <button class="main-tab" onclick="switchTab('graphing')">Graphing</button>
                <button class="main-tab" onclick="switchTab('scientific')">Calculator</button>
                <button class="main-tab" onclick="switchTab('steam')">Steam Tables</button>
                <button class="main-tab" onclick="switchTab('fluids')">Fluids</button>
                <button class="main-tab" onclick="switchTab('pipes')">Pipe Schedule</button>
                <button class="main-tab" onclick="switchTab('materials')">Materials</button>
            </div>

            <!-- Equations Tab Content -->
            <div id="equationsTab" class="tab-content active">
                <div id="welcomeState" class="empty-state">
                    <h2>Welcome to the Webster Engineering Solver</h2>
                    <p class="tagline-fade">Select an equation from the sidebar to get started</p>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <a href="/pid.html" class="tool-card">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" />
                                <line x1="3" y1="9" x2="21" y2="9" />
                                <line x1="9" y1="21" x2="9" y2="9" />
                            </svg>
                            P&ID Sketcher
                        </a>
                        <a href="/wizard.html" class="tool-card">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M12 1v6m0 6v10M4.22 4.22l4.24 4.24m7.07 7.07l4.24 4.24M1 12h6m6 0h10M4.22 19.78l4.24-4.24m7.07-7.07l4.24-4.24" />
                            </svg>
                            Unit Ops Wizard
                        </a>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
                        <button onclick="switchTab('scientific')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="4" y="2" width="16" height="20" rx="2" />
                                <line x1="8" y1="6" x2="16" y2="6" />
                                <line x1="8" y1="10" x2="16" y2="10" />
                                <rect x="8" y="14" width="8" height="6" rx="1" />
                            </svg>
                            Scientific Calculator
                        </button>
                        <button onclick="switchTab('steam')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 2v4m0 0a4 4 0 1 1 0 8m0-8a4 4 0 1 0 0 8m0 0v8" />
                                <path d="M8 14s-2 2-2 4a4 4 0 0 0 8 0c0-2-2-4-2-4" />
                            </svg>
                            Steam Tables
                        </button>
                        <button onclick="switchTab('fluids')" class="tool-card" style="cursor: pointer;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                            </svg>
                            Fluid Properties
                        </button>
                    </div>
                </div>

                <div id="equationView" style="display:none;">
                    <div class="equation-header">
                        <h1 class="equation-title" id="eqTitle"></h1>
                        <p class="equation-description" id="eqDescription"></p>
                        <p class="equation-reference" id="eqReference"></p>
                        <div id="externalLinks" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px;">
                        </div>
                    </div>
                    <div class="input-section">
                        <h3 class="section-title">Inputs</h3>
                        <div class="input-grid" id="inputGrid"></div>
                    </div>
                    <button class="calculate-btn" id="calculateBtn" onclick="calculate()">
                        Calculate
                    </button>
                </div>
            </div>
            <!-- End Equations Tab -->

            <!-- Graphing Calculator Tab -->
            <div id="graphingTab" class="tab-content">
                <div class="graph-calculator">
                    <div class="graph-header">
                        <h2 style="margin: 0; color: var(--text-primary);">Graphing Calculator</h2>
                        <select id="presetEquations" class="preset-select" onchange="loadPreset()">
                            <option value="">ðŸ“š Presets...</option>
                            <optgroup label="ChemE Functions">
                                <option value="exp(-x^2)">Gaussian: exp(-xÂ²)</option>
                                <option value="1/(1+exp(-x))">Sigmoid: 1/(1+eâ»Ë£)</option>
                                <option value="x*exp(-x)">Response: xÂ·eâ»Ë£</option>
                                <option value="(1-exp(-x))">First Order: 1-eâ»Ë£</option>
                            </optgroup>
                            <optgroup label="Trigonometric">
                                <option value="sin(x)">Sine: sin(x)</option>
                                <option value="cos(x)">Cosine: cos(x)</option>
                                <option value="sin(x)/x">Sinc: sin(x)/x</option>
                            </optgroup>
                            <optgroup label="Polynomials">
                                <option value="x^2">Parabola: xÂ²</option>
                                <option value="x^3-3*x">Cubic: xÂ³-3x</option>
                                <option value="x^4-2*x^2">Quartic: xâ´-2xÂ²</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="graph-controls">
                        <div class="equation-inputs">
                            <div class="equation-row">
                                <span style="color: var(--text-secondary); min-width: 60px;">yâ‚ =</span>
                                <input type="text" id="equation1" placeholder="e.g., sin(x), x^2, exp(-x)"
                                    value="sin(x)">
                                <input type="color" class="color-picker" id="color1" value="#5b6eae">
                                <label class="deriv-toggle" title="Show derivative">
                                    <input type="checkbox" id="deriv1" onchange="plotGraph()"> f'
                                </label>
                            </div>
                            <div class="equation-row">
                                <span style="color: var(--text-secondary); min-width: 60px;">yâ‚‚ =</span>
                                <input type="text" id="equation2" placeholder="e.g., cos(x), log(x), sqrt(x)">
                                <input type="color" class="color-picker" id="color2" value="#7a8bc4">
                                <label class="deriv-toggle" title="Show derivative">
                                    <input type="checkbox" id="deriv2" onchange="plotGraph()"> f'
                                </label>
                            </div>
                            <div class="equation-row">
                                <span style="color: var(--text-secondary); min-width: 60px;">yâ‚ƒ =</span>
                                <input type="text" id="equation3" placeholder="e.g., x^3 - 3*x">
                                <input type="color" class="color-picker" id="color3" value="#9ca3c0">
                                <label class="deriv-toggle" title="Show derivative">
                                    <input type="checkbox" id="deriv3" onchange="plotGraph()"> f'
                                </label>
                            </div>
                        </div>
                        <div class="graph-actions">
                            <button class="graph-btn" onclick="plotGraph()">Plot</button>
                            <button class="graph-btn secondary" onclick="clearGraph()">Clear</button>
                        </div>
                    </div>
                    <div class="graph-toolbar">
                        <label class="mode-toggle" title="Click on graph to trace curve values">
                            <input type="checkbox" id="traceMode"> ðŸ“ Trace
                        </label>
                        <label class="mode-toggle" title="Shade area under first curve">
                            <input type="checkbox" id="integralMode" onchange="plotGraph()"> âˆ« Integral
                        </label>
                        <button class="graph-btn secondary small" onclick="findRoots()">ðŸ” Roots</button>
                        <button class="graph-btn secondary small" onclick="findIntersections()">â¨‰ Intersections</button>
                        <button class="graph-btn secondary small" onclick="saveGraph()">ðŸ’¾ Save PNG</button>
                        <button class="graph-btn secondary small" onclick="toggleTable()">ðŸ“Š Table</button>
                    </div>
                    <div class="graph-main">
                        <div class="graph-container" id="graphContainerMain">
                            <canvas id="graphCanvas"></canvas>
                            <div class="graph-info" id="graphInfo">Hover to see coordinates | Drag to pan</div>
                            <div class="zoom-controls">
                                <button class="zoom-btn" onclick="zoomGraph(1.5)" title="Zoom out">âˆ’</button>
                                <button class="zoom-btn" onclick="zoomGraph(0.67)" title="Zoom in">+</button>
                                <button class="zoom-btn" onclick="resetGraph()" title="Reset view">âŸ²</button>
                            </div>
                            <div class="trace-point" id="tracePoint" style="display: none;"></div>
                        </div>
                        <div class="values-table" id="valuesTable" style="display: none;">
                            <h4>Table of Values</h4>
                            <div class="table-controls">
                                <label>x from <input type="number" id="tableXMin" value="-5" step="1"></label>
                                <label>to <input type="number" id="tableXMax" value="5" step="1"></label>
                                <label>step <input type="number" id="tableStep" value="1" step="0.5" min="0.1"></label>
                                <button class="graph-btn small" onclick="generateTable()">Generate</button>
                            </div>
                            <div class="table-scroll" id="tableContent"></div>
                        </div>
                    </div>
                    <div class="graph-results" id="graphResults"></div>
                </div>
            </div>

            <!-- Scientific Calculator Tab -->
            <div id="scientificTab" class="tab-content">
                <div class="sci-calculator">
                    <h2 style="margin: 0 0 15px 0; color: var(--text-primary);">Scientific Calculator</h2>
                    <div class="calc-display">
                        <div class="calc-history" id="calcHistory"></div>
                        <input type="text" class="calc-input" id="calcDisplay" value="0" readonly>
                    </div>
                    <div class="calc-buttons">
                        <!-- Row 1: Memory and Clear -->
                        <button class="calc-btn memory" onclick="calcMemory('MC')">MC</button>
                        <button class="calc-btn memory" onclick="calcMemory('MR')">MR</button>
                        <button class="calc-btn memory" onclick="calcMemory('M+')">M+</button>
                        <button class="calc-btn memory" onclick="calcMemory('M-')">Mâˆ’</button>
                        <button class="calc-btn clear" onclick="calcClear()">C</button>
                        <button class="calc-btn clear" onclick="calcBackspace()">âŒ«</button>

                        <!-- Row 2: Scientific -->
                        <button class="calc-btn function" onclick="calcFunction('sin')">sin</button>
                        <button class="calc-btn function" onclick="calcFunction('cos')">cos</button>
                        <button class="calc-btn function" onclick="calcFunction('tan')">tan</button>
                        <button class="calc-btn function" onclick="calcFunction('log')">log</button>
                        <button class="calc-btn function" onclick="calcFunction('ln')">ln</button>
                        <button class="calc-btn function" onclick="calcFunction('sqrt')">âˆš</button>

                        <!-- Row 3: More Scientific -->
                        <button class="calc-btn function" onclick="calcFunction('asin')">sinâ»Â¹</button>
                        <button class="calc-btn function" onclick="calcFunction('acos')">cosâ»Â¹</button>
                        <button class="calc-btn function" onclick="calcFunction('atan')">tanâ»Â¹</button>
                        <button class="calc-btn function" onclick="calcFunction('exp')">eË£</button>
                        <button class="calc-btn function" onclick="calcFunction('pow10')">10Ë£</button>
                        <button class="calc-btn function" onclick="calcFunction('square')">xÂ²</button>

                        <!-- Row 4: Constants and operators -->
                        <button class="calc-btn const" onclick="calcConst('pi')">Ï€</button>
                        <button class="calc-btn const" onclick="calcConst('e')">e</button>
                        <button class="calc-btn operator" onclick="calcOperator('(')">(</button>
                        <button class="calc-btn operator" onclick="calcOperator(')')">)</button>
                        <button class="calc-btn operator" onclick="calcOperator('^')">xÊ¸</button>
                        <button class="calc-btn operator" onclick="calcOperator('!')">n!</button>

                        <!-- Row 5: Numbers 7-9 and operators -->
                        <button class="calc-btn number" onclick="calcDigit('7')">7</button>
                        <button class="calc-btn number" onclick="calcDigit('8')">8</button>
                        <button class="calc-btn number" onclick="calcDigit('9')">9</button>
                        <button class="calc-btn operator" onclick="calcOperator('/')">Ã·</button>
                        <button class="calc-btn operator" onclick="calcOperator('%')">%</button>
                        <button class="calc-btn function" onclick="calcFunction('abs')">|x|</button>

                        <!-- Row 6: Numbers 4-6 -->
                        <button class="calc-btn number" onclick="calcDigit('4')">4</button>
                        <button class="calc-btn number" onclick="calcDigit('5')">5</button>
                        <button class="calc-btn number" onclick="calcDigit('6')">6</button>
                        <button class="calc-btn operator" onclick="calcOperator('*')">Ã—</button>
                        <button class="calc-btn function" onclick="calcFunction('inv')">1/x</button>
                        <button class="calc-btn function" onclick="calcFunction('negate')">Â±</button>

                        <!-- Row 7: Numbers 1-3 -->
                        <button class="calc-btn number" onclick="calcDigit('1')">1</button>
                        <button class="calc-btn number" onclick="calcDigit('2')">2</button>
                        <button class="calc-btn number" onclick="calcDigit('3')">3</button>
                        <button class="calc-btn operator" onclick="calcOperator('-')">âˆ’</button>
                        <button class="calc-btn equals" onclick="calcEquals()" rowspan="2">=</button>
                        <button class="calc-btn function" onclick="calcDegRad()">DEG</button>

                        <!-- Row 8: Zero and decimal -->
                        <button class="calc-btn number wide" onclick="calcDigit('0')">0</button>
                        <button class="calc-btn number" onclick="calcDigit('.')">.</button>
                        <button class="calc-btn operator" onclick="calcOperator('+')">+</button>
                        <button class="calc-btn function" onclick="calcAns()">ANS</button>
                    </div>
                    <div class="calc-info">
                        <span id="calcMode">DEG</span> |
                        <span id="calcMemoryIndicator"></span>
                    </div>
                </div>
            </div>

            <!-- Steam Tables Tab -->
            <div id="steamTab" class="tab-content">
                <div class="reference-panel">
                    <h2>Steam Tables</h2>
                    <p class="ref-description">Saturated steam properties at common temperatures and pressures</p>
                    <div class="ref-controls">
                        <label>View by:
                            <select id="steamViewType" onchange="updateSteamTable()">
                                <option value="temp">Temperature</option>
                                <option value="pressure">Pressure</option>
                            </select>
                        </label>
                    </div>
                    <div class="ref-table-container">
                        <table class="ref-table" id="steamTable">
                            <thead>
                                <tr>
                                    <th>T (Â°C)</th>
                                    <th>P (kPa)</th>
                                    <th>vf (mÂ³/kg)</th>
                                    <th>vg (mÂ³/kg)</th>
                                    <th>hf (kJ/kg)</th>
                                    <th>hfg (kJ/kg)</th>
                                    <th>hg (kJ/kg)</th>
                                    <th>sf (kJ/kgÂ·K)</th>
                                    <th>sg (kJ/kgÂ·K)</th>
                                </tr>
                            </thead>
                            <tbody id="steamTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Fluid Properties Tab -->
            <div id="fluidsTab" class="tab-content">
                <div class="reference-panel">
                    <h2>Fluid Properties</h2>
                    <p class="ref-description">Common fluid properties at 25Â°C and 1 atm (unless noted)</p>
                    <div class="ref-controls">
                        <input type="text" id="fluidSearch" placeholder="Search fluids..." oninput="filterFluids()">
                    </div>
                    <div class="ref-table-container">
                        <table class="ref-table" id="fluidsTable">
                            <thead>
                                <tr>
                                    <th>Fluid</th>
                                    <th>Ï (kg/mÂ³)</th>
                                    <th>Î¼ (mPaÂ·s)</th>
                                    <th>Cp (kJ/kgÂ·K)</th>
                                    <th>k (W/mÂ·K)</th>
                                    <th>Tb (Â°C)</th>
                                    <th>Tc (Â°C)</th>
                                    <th>Pc (MPa)</th>
                                </tr>
                            </thead>
                            <tbody id="fluidsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pipe Schedule Tab -->
            <div id="pipesTab" class="tab-content">
                <div class="reference-panel">
                    <h2>Pipe Schedule</h2>
                    <p class="ref-description">Standard pipe dimensions per ASME B36.10M (carbon steel)</p>
                    <div class="ref-controls">
                        <label>Schedule:
                            <select id="pipeSchedule" onchange="updatePipeTable()">
                                <option value="10">Sch 10</option>
                                <option value="40" selected>Sch 40</option>
                                <option value="80">Sch 80</option>
                                <option value="160">Sch 160</option>
                            </select>
                        </label>
                    </div>
                    <div class="ref-table-container">
                        <table class="ref-table" id="pipesTable">
                            <thead>
                                <tr>
                                    <th>NPS</th>
                                    <th>OD (in)</th>
                                    <th>OD (mm)</th>
                                    <th>Wall (in)</th>
                                    <th>Wall (mm)</th>
                                    <th>ID (in)</th>
                                    <th>ID (mm)</th>
                                    <th>Flow Area (inÂ²)</th>
                                    <th>Weight (lb/ft)</th>
                                </tr>
                            </thead>
                            <tbody id="pipesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Materials Database Tab -->
            <div id="materialsTab" class="tab-content">
                <div class="reference-panel">
                    <h2>Materials Database</h2>
                    <p class="ref-description">Common engineering materials and their properties</p>
                    <div class="ref-controls">
                        <input type="text" id="materialSearch" placeholder="Search materials..."
                            oninput="filterMaterials()">
                        <select id="materialCategory" onchange="filterMaterials()">
                            <option value="">All Categories</option>
                            <option value="steel">Carbon Steel</option>
                            <option value="stainless">Stainless Steel</option>
                            <option value="alloy">Alloys</option>
                            <option value="plastic">Plastics</option>
                        </select>
                    </div>
                    <div class="ref-table-container">
                        <table class="ref-table" id="materialsTable">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Category</th>
                                    <th>Ï (kg/mÂ³)</th>
                                    <th>E (GPa)</th>
                                    <th>Ïƒy (MPa)</th>
                                    <th>Î± (Î¼m/mÂ·K)</th>
                                    <th>k (W/mÂ·K)</th>
                                    <th>Tmax (Â°C)</th>
                                </tr>
                            </thead>
                            <tbody id="materialsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Results Panel -->
        <aside class="results-panel">
            <h3 class="results-header">Results</h3>
            <label class="comparison-toggle">
                <input type="checkbox" onchange="toggleComparison(this)">
                Compare with previous
            </label>
            <div id="resultsContent">
                <div class="empty-state">
                    <p>Run a calculation to see results</p>
                </div>
            </div>

            <!-- Tips Carousel -->
            <div class="tips-carousel" id="tipsCarousel">
                <div class="tip-label">ðŸ’¡ ChemE Fact</div>
                <div class="tip active">
                    <div class="tip-text">The Haber process for ammonia synthesis operates at 400-500Â°C and 150-300 atm,
                        producing 150 million tons annually.</div>
                </div>
                <div class="tip">
                    <div class="tip-text">A typical oil refinery can process up to 600,000 barrels of crude oil per day
                        into gasoline, diesel, and jet fuel.</div>
                </div>
                <div class="tip">
                    <div class="tip-text">The Reynolds number (Re > 4000) determines turbulent flow - discovered by
                        Osborne Reynolds in 1883.</div>
                </div>
                <div class="tip">
                    <div class="tip-text">Water has an unusually high heat capacity (4.18 kJ/kgÂ·K), making it excellent
                        for industrial cooling.</div>
                </div>
                <div class="tip">
                    <div class="tip-text">Distillation accounts for ~40% of all energy used in chemical processing. Heat
                        integration can cut this in half.</div>
                </div>
                <div class="tip">
                    <div class="tip-text">The Navier-Stokes equations governing fluid flow remain one of the Millennium
                        Prize Problems in mathematics.</div>
                </div>
                <div class="tip">
                    <div class="tip-text">Bioreactors can produce 200+ grams of monoclonal antibodies per liter - up
                        from milligrams in the 1980s.</div>
                </div>
            </div>
            <div id="chartSection" style="display:none; margin-top: 20px;">
                <h4 style="font-size: 0.9rem; color: var(--accent); margin-bottom: 10px;">Sensitivity Analysis</h4>
                <canvas id="sensitivityChart" style="max-height: 250px;"></canvas>
            </div>
            <div id="chartActions" style="display:none; margin-top: 15px;">
                <button class="calculate-btn" style="padding: 10px; font-size: 0.85rem;" onclick="runSensitivity()">
                    ðŸ“Š Run Sensitivity Analysis
                </button>
            </div>
        </aside>
    </div>

    <script>
        const API_BASE = '';
        let currentCategory = null;
        let currentEquation = null;
        let equationParams = [];
        let previousResult = null;
        let comparisonMode = false;
        let equationCache = {};

        // ===== Wikipedia URL Mapping =====
        const wikipediaUrls = {
            // Process Control
            'ziegler_nichols_pid': 'Ziegler%E2%80%93Nichols_method',
            'cohen_coon_pid': 'PID_controller#Loop_tuning',
            'imc_pid': 'Internal_model_control',
            'tyreus_luyben_pid': 'PID_controller#Tyreus%E2%80%93Luyben_tuning',
            'cv_liquid': 'Control_valve#Valve_coefficient',
            'cv_gas': 'Control_valve#Valve_coefficient',
            'gain_margin': 'Gain_margin',
            'phase_margin': 'Phase_margin',
            'fopdt_model': 'PID_controller#FOPDT_model',
            'cascade_control': 'Cascade_control',
            'feedforward_control': 'Feed-forward_(control)',
            // Fluid Dynamics
            'reynolds_number': 'Reynolds_number',
            'bernoulli': 'Bernoulli%27s_principle',
            'orifice_flow': 'Orifice_plate',
            'friction_factor': 'Darcy_friction_factor',
            'darcy_weisbach': 'Darcy%E2%80%93Weisbach_equation',
            'hazen_williams': 'Hazen%E2%80%93Williams_equation',
            'pump_power': 'Pump#Pump_power',
            'npsh': 'Net_positive_suction_head',
            'cavitation': 'Cavitation',
            // Heat Transfer
            'lmtd': 'Log_mean_temperature_difference',
            'hx_area': 'Heat_exchanger#Design',
            'heat_duty': 'Heat_transfer',
            'ntu_eff': 'NTU_method',
            'overall_u': 'Thermal_contact_conductance',
            'convection_coeff': 'Convective_heat_transfer#Dittus%E2%80%93Boelter_correlation',
            // Thermodynamics
            'antoine': 'Antoine_equation',
            'clausius_clapeyron': 'Clausius%E2%80%93Clapeyron_relation',
            'ideal_gas': 'Ideal_gas_law',
            'compressibility': 'Compressibility_factor',
            'raoults_law': 'Raoult%27s_law',
            'henrys_law': 'Henry%27s_law',
            // Mass Transfer
            'ficks_law': 'Fick%27s_laws_of_diffusion',
            'mass_transfer_coeff': 'Mass_transfer_coefficient',
            'sherwood': 'Sherwood_number',
            'schmidt': 'Schmidt_number',
            // Reaction Kinetics
            'arrhenius': 'Arrhenius_equation',
            'first_order': 'First-order_reaction',
            'second_order': 'Second-order_reaction',
            'half_life': 'Half-life',
            // Distillation
            'mccabe_thiele': 'McCabe%E2%80%93Thiele_method',
            'fenske_equation': 'Fenske_equation',
            'underwood_equation': 'Underwood_equation',
            'relative_volatility': 'Relative_volatility',
            // Safety
            'relief_valve': 'Relief_valve',
            'fire_case': 'Process_safety#Fire_scenarios',
            'tnteq': 'TNT_equivalent',
            // Economics
            'npv': 'Net_present_value',
            'irr': 'Internal_rate_of_return',
            'payback': 'Payback_period',
            'cepci': 'Chemical_Engineering_Plant_Cost_Index',
            // Default fallback
            'default': null
        };

        function getWikipediaUrl(equationId, equationName) {
            if (wikipediaUrls[equationId]) {
                return `https://en.wikipedia.org/wiki/${wikipediaUrls[equationId]}`;
            }
            // Fallback to search if no mapping exists
            return `https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(equationName + ' chemical engineering')}`;
        }

        // ===== Chemical Engineering Tips =====
        const chemEngTips = [
            { icon: "ðŸ§ª", text: "The Haber process for ammonia synthesis operates at 400-500Â°C and 150-300 atm, producing 150 million tons annually worldwide." },
            { icon: "âš—ï¸", text: "A typical oil refinery can process up to 600,000 barrels of crude oil per day into gasoline, diesel, and jet fuel." },
            { icon: "ðŸ”¬", text: "The Reynolds number (Re > 4000) determines turbulent flow - discovered by Osborne Reynolds in 1883." },
            { icon: "ðŸ’§", text: "Water has an unusually high heat capacity (4.18 kJ/kgÂ·K), making it excellent for industrial cooling." },
            { icon: "ðŸ­", text: "The first commercial petrochemical plant opened in 1920 in the US, producing isopropyl alcohol." },
            { icon: "âš¡", text: "Electrolysis of water requires 237 kJ/mol, but fuel cells can recover up to 83% of this energy." },
            { icon: "ðŸŒ¡ï¸", text: "Absolute zero (-273.15Â°C) is theoretically unreachable - the closest achieved is 100 picoKelvin." },
            { icon: "ðŸ”„", text: "Distillation accounts for ~40% of all energy used in chemical processing. Heat integration can cut this in half." },
            { icon: "ðŸ“Š", text: "The Navier-Stokes equations governing fluid flow remain one of the Millennium Prize Problems in mathematics." },
            { icon: "ðŸŽ¯", text: "Six Sigma quality (3.4 defects per million) was pioneered by Motorola and adopted industry-wide." },
            { icon: "ðŸ’¨", text: "Supersonic wind tunnels can simulate speeds up to Mach 10 (12,350 km/h) for aerospace testing." },
            { icon: "ðŸ§¬", text: "Bioreactors can produce 200+ grams of monoclonal antibodies per liter - up from milligrams in the 1980s." },
        ];
        let currentTipIndex = 0;

        // ===== Theme Toggle =====
        function toggleTheme() {
            const body = document.body;
            const btn = document.querySelector('.theme-toggle');
            body.classList.toggle('light-mode');
            btn.textContent = body.classList.contains('light-mode') ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('theme', body.classList.contains('light-mode') ? 'light' : 'dark');
        }

        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.body.classList.add('light-mode');
                document.querySelector('.theme-toggle').textContent = 'â˜€ï¸';
            }
        }

        // ===== Calculation Counter =====
        function updateCalcCounter() {
            const today = new Date().toDateString();
            let data = JSON.parse(localStorage.getItem('calcStats') || '{}');
            if (data.date !== today) {
                data = { date: today, count: 0 };
            }
            data.count++;
            localStorage.setItem('calcStats', JSON.stringify(data));
            document.getElementById('calcCount').textContent = data.count;
        }

        function loadCalcCounter() {
            const today = new Date().toDateString();
            let data = JSON.parse(localStorage.getItem('calcStats') || '{}');
            if (data.date !== today) {
                data = { date: today, count: 0 };
            }
            document.getElementById('calcCount').textContent = data.count;
        }

        // ===== Calculation History =====
        function saveToHistory(equationId, inputs, outputs) {
            const key = `history_${equationId}`;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            history.unshift({
                timestamp: new Date().toISOString(),
                inputs: inputs,
                outputs: outputs
            });
            history = history.slice(0, 10); // Keep last 10
            localStorage.setItem(key, JSON.stringify(history));
        }

        function loadFromHistory(equationId, index) {
            const key = `history_${equationId}`;
            const history = JSON.parse(localStorage.getItem(key) || '[]');
            if (history[index]) {
                const entry = history[index];
                for (const [name, data] of Object.entries(entry.inputs)) {
                    const input = document.getElementById(`input_${name}`);
                    const unit = document.getElementById(`unit_${name}`);
                    if (input) input.value = data.value;
                    if (unit && data.unit) unit.value = data.unit;
                }
            }
        }

        function getHistory(equationId) {
            const key = `history_${equationId}`;
            return JSON.parse(localStorage.getItem(key) || '[]');
        }

        // ===== Copy to Clipboard =====
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('copyToast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }

        // ===== Input Validation =====
        function validateInput(inputEl, param) {
            const value = parseFloat(inputEl.value);
            inputEl.classList.remove('valid', 'warning', 'invalid');

            if (isNaN(value)) return;

            if (param.typical_range && param.typical_range.length === 2) {
                const [min, max] = param.typical_range;
                const range = max - min;
                const edgeBuffer = range * 0.1;

                if (value < min || value > max) {
                    inputEl.classList.add('invalid');
                } else if (value < min + edgeBuffer || value > max - edgeBuffer) {
                    inputEl.classList.add('warning');
                } else {
                    inputEl.classList.add('valid');
                }
            }
        }

        function setupInputValidation() {
            for (const param of equationParams) {
                const inputEl = document.getElementById(`input_${param.name}`);
                if (inputEl && param.typical_range) {
                    inputEl.addEventListener('input', () => validateInput(inputEl, param));
                }
            }
        }

        // ===== Tips Carousel =====
        function rotateTip() {
            const tips = document.querySelectorAll('.tips-carousel .tip');
            if (tips.length === 0) return;

            tips.forEach(t => t.classList.remove('active'));
            currentTipIndex = (currentTipIndex + 1) % tips.length;
            tips[currentTipIndex].classList.add('active');
        }

        function initTipsCarousel() {
            setInterval(rotateTip, 20000);
        }

        // ===== Comparison Mode Toggle =====
        function toggleComparison(checkbox) {
            comparisonMode = checkbox.checked;
            if (lastResult) {
                displayResultsEnhanced(lastResult);
            }
        }


        // Load categories on page load
        async function loadCategories() {
            const response = await fetch(`${API_BASE}/api/categories`);
            const categories = await response.json();

            const container = document.getElementById('categoryList');
            container.innerHTML = categories.map((cat, index) => `
                <div class="category ${index === 0 ? 'expanded' : ''}" data-category="${cat.name.toLowerCase().replace(/ /g, '_')}">
                    <div class="category-header" onclick="toggleCategory(this)">
                        ${cat.name}
                        <span class="category-count">${cat.equation_count}</span>
                    </div>
                    <div class="equations">
                        ${cat.equations.map(eq => `
                            <div class="equation-item" 
                                 onclick="selectEquation('${cat.name.toLowerCase().replace(/ /g, '_')}', '${eq.id}')"
                                 onmouseenter="showEquationPreview(this, '${cat.name.toLowerCase().replace(/ /g, '_')}', '${eq.id}')">
                                ${eq.name}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleCategory(header) {
            const category = header.parentElement;
            category.classList.toggle('expanded');
        }

        async function selectEquation(category, equationId) {
            currentCategory = category;
            currentEquation = equationId;

            // Update active state
            document.querySelectorAll('.equation-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            // Fetch equation details
            const response = await fetch(`${API_BASE}/api/equations/${category}/${equationId}`);
            const eq = await response.json();

            document.getElementById('welcomeState').style.display = 'none';
            document.getElementById('equationView').style.display = 'block';

            document.getElementById('eqTitle').textContent = eq.name;
            document.getElementById('eqDescription').textContent = eq.description;
            document.getElementById('eqReference').textContent = `Reference: ${eq.reference}`;

            // Add external resource links
            const searchQuery = encodeURIComponent(`${eq.name} chemical engineering`);
            document.getElementById('externalLinks').innerHTML = `
                <a href="https://www.google.com/search?q=${searchQuery}" target="_blank" class="reference-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    Search Google
                </a>
                <a href="${getWikipediaUrl(equationId, eq.name)}" target="_blank" class="reference-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="m2 17 10 5 10-5"/><path d="m2 12 10 5 10-5"/>
                    </svg>
                    Wikipedia
                </a>
                <a href="https://scholar.google.com/scholar?q=${searchQuery}" target="_blank" class="reference-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    Google Scholar
                </a>
            `;

            // Build input form
            equationParams = eq.parameters.filter(p => p.param_type === 'input');
            const inputGrid = document.getElementById('inputGrid');
            inputGrid.innerHTML = equationParams.map(param => {
                // Build unit options - use unit_options array if available, otherwise just default
                const unitOptions = (param.unit_options && param.unit_options.length > 0)
                    ? param.unit_options
                    : (param.unit ? [param.unit] : ['']);
                const optionsHtml = unitOptions.map(u =>
                    `<option value="${u}" ${u === param.unit ? 'selected' : ''}>${u || 'â€”'}</option>`
                ).join('');

                return `
                <div class="input-group">
                    <label class="input-label ${param.tooltip ? 'tooltip' : ''}" ${param.tooltip ? `data-tooltip="${param.tooltip}"` : ''}>
                        <span class="symbol">${param.symbol}</span>
                    </label>
                    <input type="number" class="input-field" id="input_${param.name}" 
                           placeholder="${param.description}" step="any">
                    <select class="unit-select" id="unit_${param.name}">
                        ${optionsHtml}
                    </select>
                </div>
            `}).join('');

            // Clear results
            document.getElementById('resultsContent').innerHTML = `
                <div class="empty-state">
                    <p>Enter values and click Calculate</p>
                </div>
            `;

            // Render history dropdown if there's history for this equation
            setTimeout(() => renderHistoryDropdown(), 100);

            // Setup input validation
            setupInputValidation();
        }

        async function calculate() {
            const btn = document.getElementById('calculateBtn');
            btn.disabled = true;
            btn.textContent = 'Calculating...';

            // Gather inputs
            const inputs = {};
            for (const param of equationParams) {
                const valueEl = document.getElementById(`input_${param.name}`);
                const unitEl = document.getElementById(`unit_${param.name}`);
                const value = parseFloat(valueEl.value);

                if (!isNaN(value)) {
                    inputs[param.name] = {
                        value: value,
                        unit: unitEl.value || ''
                    };
                }
            }

            try {
                const response = await fetch(`${API_BASE}/api/calculate/${currentCategory}/${currentEquation}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputs })
                });
                const result = await response.json();
                displayResults(result);
            } catch (error) {
                displayResults({ success: false, error: error.message });
            }

            btn.disabled = false;
            btn.textContent = 'Calculate';
        }

        function displayResults(result) {
            const container = document.getElementById('resultsContent');

            if (!result.success) {
                container.innerHTML = `
                    <div class="validation-badge fail">âŒ Error</div>
                    <p>${result.error || 'Calculation failed'}</p>
                `;
                return;
            }

            let html = '';

            // Validation badge
            if (result.validation_status) {
                const status = result.validation_status.toLowerCase();
                const icon = status === 'pass' ? 'âœ“' : status === 'warning' ? 'âš ' : 'âœ—';
                html += `<div class="validation-badge ${status}">${icon} ${result.validation_status}</div>`;
            }

            // Output cards
            for (const [name, data] of Object.entries(result.outputs)) {
                const value = typeof data.value === 'number' ?
                    (Math.abs(data.value) < 0.001 || Math.abs(data.value) > 10000 ?
                        data.value.toExponential(4) : data.value.toFixed(4)) : data.value;
                html += `
                    <div class="result-card">
                        <div class="result-name">${name}</div>
                        <div class="result-value">
                            ${value}
                            <span class="result-unit">${data.unit || ''}</span>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', async (e) => {
            const query = e.target.value;
            if (query.length < 2) {
                loadCategories();
                return;
            }

            const response = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(query)}`);
            const results = await response.json();

            const container = document.getElementById('categoryList');
            if (results.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); padding: 10px;">No results found</p>';
                return;
            }

            container.innerHTML = results.map(eq => `
                <div class="equation-item" onclick="selectEquation('${eq.category}', '${eq.id}')">
                    ${eq.name}
                </div>
            `).join('');
        });

        // Charting variables
        let sensitivityChart = null;
        let lastResult = null;

        // Show chart actions after successful calculation
        function showChartActions() {
            document.getElementById('chartActions').style.display = 'block';
        }

        // Run sensitivity analysis on first input parameter
        async function runSensitivity() {
            if (!currentEquation || equationParams.length === 0) return;

            const baseParam = equationParams[0];
            const baseInput = document.getElementById(`input_${baseParam.name}`);
            const baseValue = parseFloat(baseInput.value);
            if (isNaN(baseValue) || baseValue === 0) {
                alert('Enter a valid base value for the first parameter');
                return;
            }

            // Run calculations at Â±50% in 10 steps
            const variations = [];
            const outputs = {};

            for (let pct = -50; pct <= 50; pct += 10) {
                const testValue = baseValue * (1 + pct / 100);
                variations.push({ pct, value: testValue });

                // Build inputs
                const inputs = {};
                for (const param of equationParams) {
                    const valueEl = document.getElementById(`input_${param.name}`);
                    const unitEl = document.getElementById(`unit_${param.name}`);
                    let value = parseFloat(valueEl.value);

                    if (param.name === baseParam.name) {
                        value = testValue;
                    }

                    if (!isNaN(value)) {
                        inputs[param.name] = { value, unit: unitEl.value || '' };
                    }
                }

                try {
                    const response = await fetch(`${API_BASE}/api/calculate/${currentCategory}/${currentEquation}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ inputs })
                    });
                    const result = await response.json();

                    if (result.success) {
                        for (const [name, data] of Object.entries(result.outputs)) {
                            if (!outputs[name]) outputs[name] = [];
                            outputs[name].push(data.value);
                        }
                    }
                } catch (e) {
                    console.error('Sensitivity calc error:', e);
                }
            }

            // Create chart
            const labels = variations.map(v => `${v.pct > 0 ? '+' : ''}${v.pct}%`);
            const datasets = [];
            const colors = ['#89b4fa', '#a6e3a1', '#f9e2af', '#f38ba8', '#cba6f7', '#94e2d5'];

            let i = 0;
            for (const [name, values] of Object.entries(outputs)) {
                datasets.push({
                    label: name,
                    data: values,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '33',
                    tension: 0.3,
                    fill: false
                });
                i++;
            }

            // Show chart section
            document.getElementById('chartSection').style.display = 'block';

            // Destroy old chart
            if (sensitivityChart) {
                sensitivityChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('sensitivityChart').getContext('2d');
            sensitivityChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#cdd6f4', font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: `Effect of ${baseParam.name} variation`,
                            color: '#cdd6f4'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a6adc8' },
                            grid: { color: '#45475a' }
                        },
                        y: {
                            ticks: { color: '#a6adc8' },
                            grid: { color: '#45475a' }
                        }
                    }
                }
            });
        }

        // Update displayResults to show chart button
        const originalDisplayResults = displayResults;
        displayResults = function (result) {
            const container = document.getElementById('resultsContent');

            if (!result.success) {
                container.innerHTML = `
                    <div class="validation-badge fail">âŒ Error</div>
                    <p>${result.error || 'Calculation failed'}</p>
                `;
                document.getElementById('chartActions').style.display = 'none';
                document.getElementById('chartSection').style.display = 'none';
                return;
            }

            let html = '';

            // Validation badge
            if (result.validation_status) {
                const status = result.validation_status.toLowerCase();
                const icon = status === 'pass' ? 'âœ“' : status === 'warning' ? 'âš ' : 'âœ—';
                html += `<div class="validation-badge ${status}">${icon} ${result.validation_status}</div>`;
            }

            // Check for comparison mode
            if (comparisonMode && previousResult && previousResult.outputs) {
                html += '<div class="result-comparison">';
                for (const [name, data] of Object.entries(result.outputs)) {
                    const value = typeof data.value === 'number' ?
                        (Math.abs(data.value) < 0.001 || Math.abs(data.value) > 10000 ?
                            data.value.toExponential(4) : data.value.toFixed(4)) : data.value;

                    // Current result
                    const copyText = `${value} ${data.unit || ''}`.trim();
                    html += `
                        <div class="result-card" onclick="copyToClipboard('${copyText}')">
                            <div class="result-name">${name} (Current)</div>
                            <div class="result-value">
                                ${value}
                                <span class="result-unit">${data.unit || ''}</span>
                            </div>
                        </div>
                    `;

                    // Previous result
                    const prevData = previousResult.outputs[name];
                    if (prevData) {
                        const prevValue = typeof prevData.value === 'number' ?
                            (Math.abs(prevData.value) < 0.001 || Math.abs(prevData.value) > 10000 ?
                                prevData.value.toExponential(4) : prevData.value.toFixed(4)) : prevData.value;

                        // Calculate delta
                        let delta = '';
                        if (typeof data.value === 'number' && typeof prevData.value === 'number') {
                            const pctChange = ((data.value - prevData.value) / prevData.value * 100).toFixed(1);
                            const deltaClass = parseFloat(pctChange) >= 0 ? 'positive' : 'negative';
                            delta = `<span class="delta-indicator ${deltaClass}">${pctChange > 0 ? '+' : ''}${pctChange}%</span>`;
                        }

                        html += `
                            <div class="result-card previous">
                                <div class="result-name">${name} (Previous) ${delta}</div>
                                <div class="result-value">
                                    ${prevValue}
                                    <span class="result-unit">${prevData.unit || ''}</span>
                                </div>
                            </div>
                        `;
                    }
                }
                html += '</div>';
            } else {
                // Normal output cards with copy functionality
                for (const [name, data] of Object.entries(result.outputs)) {
                    const value = typeof data.value === 'number' ?
                        (Math.abs(data.value) < 0.001 || Math.abs(data.value) > 10000 ?
                            data.value.toExponential(4) : data.value.toFixed(4)) : data.value;
                    const copyText = `${value} ${data.unit || ''}`.trim();
                    html += `
                        <div class="result-card" onclick="copyToClipboard('${copyText}')">
                            <div class="result-name">${name}</div>
                            <div class="result-value">
                                ${value}
                                <span class="result-unit">${data.unit || ''}</span>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
            previousResult = lastResult;
            lastResult = result;
            showChartActions();

            // Update calculation counter
            updateCalcCounter();

            // Save to history
            const inputs = {};
            for (const param of equationParams) {
                const valueEl = document.getElementById(`input_${param.name}`);
                const unitEl = document.getElementById(`unit_${param.name}`);
                if (valueEl && valueEl.value) {
                    inputs[param.name] = {
                        value: parseFloat(valueEl.value),
                        unit: unitEl ? unitEl.value : ''
                    };
                }
            }
            saveToHistory(currentEquation, inputs, result.outputs);

            // Show input linking suggestions
            showLinkSuggestions(result.outputs);
        };

        // ===== Particle System (Brownian Motion) =====
        const particleCanvas = document.getElementById('particleCanvas');
        const ctx = particleCanvas ? particleCanvas.getContext('2d') : null;
        let particles = [];

        function initParticles() {
            if (!particleCanvas || !ctx) return;

            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;

            particles = [];
            const numParticles = 25;

            for (let i = 0; i < numParticles; i++) {
                particles.push({
                    x: Math.random() * particleCanvas.width,
                    y: Math.random() * particleCanvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    radius: Math.random() * 2 + 1,
                    opacity: Math.random() * 0.3 + 0.1
                });
            }
        }

        function drawParticles() {
            if (!ctx || !particleCanvas) return;

            ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);

            // Draw connecting lines (polymer chains)
            ctx.strokeStyle = 'rgba(91, 110, 174, 0.06)';
            ctx.lineWidth = 1;
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 150) {
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.globalAlpha = 0.1 * (1 - dist / 150);
                        ctx.stroke();
                    }
                }
            }

            // Draw particles
            for (const p of particles) {
                // Brownian motion - random velocity changes
                p.vx += (Math.random() - 0.5) * 0.1;
                p.vy += (Math.random() - 0.5) * 0.1;

                // Damping
                p.vx *= 0.99;
                p.vy *= 0.99;

                // Update position
                p.x += p.vx;
                p.y += p.vy;

                // Wrap around edges
                if (p.x < 0) p.x = particleCanvas.width;
                if (p.x > particleCanvas.width) p.x = 0;
                if (p.y < 0) p.y = particleCanvas.height;
                if (p.y > particleCanvas.height) p.y = 0;

                // Draw particle
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(91, 110, 174, ${p.opacity})`;
                ctx.globalAlpha = 1;
                ctx.fill();
            }

            requestAnimationFrame(drawParticles);
        }

        // ===== Ripple Effect on Calculate Button =====
        function createRipple(event) {
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            const ripple = document.createElement('span');
            ripple.classList.add('ripple-effect');
            ripple.style.left = `${event.clientX - rect.left}px`;
            ripple.style.top = `${event.clientY - rect.top}px`;
            ripple.style.width = ripple.style.height = '20px';
            button.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        // ===== Equation Preview on Hover =====
        async function showEquationPreview(element, category, eqId) {
            const cacheKey = `${category}/${eqId}`;

            // Check cache
            if (!equationCache[cacheKey]) {
                try {
                    const response = await fetch(`${API_BASE}/api/equations/${category}/${eqId}`);
                    equationCache[cacheKey] = await response.json();
                } catch (e) {
                    return;
                }
            }

            const eq = equationCache[cacheKey];

            // Create or update preview
            let preview = element.querySelector('.equation-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.className = 'equation-preview';
                element.appendChild(preview);
            }

            const inputsList = eq.parameters.map(p => `${p.symbol}`).join(', ');
            preview.innerHTML = `
                <h4>${eq.name}</h4>
                ${eq.formula ? `<div class="formula">${eq.formula}</div>` : ''}
                <p>${eq.description.substring(0, 100)}${eq.description.length > 100 ? '...' : ''}</p>
                <div class="preview-inputs">Inputs: ${inputsList}</div>
            `;
        }

        // ===== History Dropdown UI =====
        function renderHistoryDropdown() {
            if (!currentEquation) return;

            const history = getHistory(currentEquation);
            if (history.length === 0) return;

            // Check if dropdown already exists
            let dropdown = document.querySelector('.history-dropdown');
            if (!dropdown) {
                const inputSection = document.querySelector('.input-section');
                if (!inputSection) return;

                const header = inputSection.querySelector('.section-title');
                if (!header) return;

                dropdown = document.createElement('div');
                dropdown.className = 'history-dropdown';
                dropdown.innerHTML = `
                    <button class="history-btn" onclick="toggleHistoryMenu(event)">
                        ðŸ“œ History <span class="history-count">(${history.length})</span>
                    </button>
                    <div class="history-menu" id="historyMenu"></div>
                `;
                header.parentNode.insertBefore(dropdown, header.nextSibling);
            }

            // Update count
            const countSpan = dropdown.querySelector('.history-count');
            if (countSpan) countSpan.textContent = `(${history.length})`;

            // Populate menu
            const menu = dropdown.querySelector('.history-menu');
            if (!menu) return;

            menu.innerHTML = history.map((entry, idx) => {
                const time = new Date(entry.timestamp);
                const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = time.toLocaleDateString();
                const values = Object.entries(entry.inputs).slice(0, 2).map(([k, v]) => `${k}=${v.value}`).join(', ');
                return `
                    <div class="history-item" onclick="loadHistoryEntry(${idx})">
                        <div class="time">${dateStr} ${timeStr}</div>
                        <div class="values">${values}${Object.keys(entry.inputs).length > 2 ? '...' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        function toggleHistoryMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('historyMenu');
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        function loadHistoryEntry(index) {
            loadFromHistory(currentEquation, index);
            const menu = document.getElementById('historyMenu');
            if (menu) menu.classList.remove('show');
        }

        // Close history menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.history-dropdown')) {
                const menu = document.getElementById('historyMenu');
                if (menu) menu.classList.remove('show');
            }
        });

        // ===== Input Linking Suggestions =====
        const linkableParams = {
            'pressure': ['pressure', 'P', 'pressure_drop', 'delta_P'],
            'temperature': ['temperature', 'T', 'temp', 'T_hot', 'T_cold'],
            'flow_rate': ['flow_rate', 'Q', 'volumetric_flow', 'mass_flow'],
            'velocity': ['velocity', 'v', 'fluid_velocity'],
            'heat_duty': ['heat_duty', 'Q_heat', 'heat_transfer'],
            'area': ['area', 'A', 'surface_area']
        };

        function showLinkSuggestions(outputs) {
            // Remove existing suggestions
            const existing = document.querySelector('.link-suggestions');
            if (existing) existing.remove();

            // Find matchable output types
            const suggestions = [];
            for (const [outputName, outputData] of Object.entries(outputs)) {
                for (const [category, params] of Object.entries(linkableParams)) {
                    if (params.some(p => outputName.toLowerCase().includes(p.toLowerCase()))) {
                        suggestions.push({
                            outputName,
                            outputValue: outputData.value,
                            outputUnit: outputData.unit,
                            category
                        });
                    }
                }
            }

            if (suggestions.length === 0) return;

            // Create suggestions container
            const container = document.getElementById('resultsContent');
            if (!container) return;

            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'link-suggestions';
            suggestionsDiv.innerHTML = `
                <h4>ðŸ”— Link to Other Equations</h4>
                ${suggestions.slice(0, 3).map(s => `
                    <div class="link-suggestion-item" onclick="copyToClipboard('${s.outputValue}')">
                        <div>
                            <div class="eq-name">${s.outputName}</div>
                            <div class="param-match">${typeof s.outputValue === 'number' ? s.outputValue.toFixed(4) : s.outputValue} ${s.outputUnit || ''}</div>
                        </div>
                        <span class="link-arrow">â†’</span>
                    </div>
                `).join('')}
            `;

            container.appendChild(suggestionsDiv);
        }

        // ===== Window Resize Handler =====
        window.addEventListener('resize', () => {
            if (particleCanvas) {
                particleCanvas.width = window.innerWidth;
                particleCanvas.height = window.innerHeight;
            }
        });

        // Initialize
        loadCategories();
        loadTheme();
        loadCalcCounter();
        initTipsCarousel();
        initParticles();
        drawParticles();

        // Add ripple effect to calculate button
        const calcBtn = document.getElementById('calculateBtn');
        if (calcBtn) {
            calcBtn.addEventListener('click', createRipple);
        }

        // ===== Tab Switching =====
        function switchTab(tabName) {
            // Update tab buttons - match by checking if button text contains tab name
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
                const btnText = tab.textContent.toLowerCase();
                if (tabName === 'equations' && btnText.includes('equation')) tab.classList.add('active');
                else if (tabName === 'graphing' && btnText.includes('graph')) tab.classList.add('active');
                else if (tabName === 'scientific' && btnText.includes('calc')) tab.classList.add('active');
                else if (tabName === 'steam' && btnText.includes('steam')) tab.classList.add('active');
                else if (tabName === 'fluids' && btnText.includes('fluid')) tab.classList.add('active');
                else if (tabName === 'pipes' && btnText.includes('pipe')) tab.classList.add('active');
                else if (tabName === 'materials' && btnText.includes('material')) tab.classList.add('active');
            });

            // Hide all tabs
            ['equations', 'graphing', 'scientific', 'steam', 'fluids', 'pipes', 'materials'].forEach(t => {
                const el = document.getElementById(t + 'Tab');
                if (el) el.classList.remove('active');
            });

            // Show selected tab
            const tabEl = document.getElementById(tabName + 'Tab');
            if (tabEl) tabEl.classList.add('active');

            // Initialize specific tabs
            if (tabName === 'graphing') {
                initGraphCanvas();
                if (typeof setupPanning === 'function') setupPanning();
                plotGraph();
            } else if (tabName === 'steam' && typeof updateSteamTable === 'function') {
                updateSteamTable();
            } else if (tabName === 'fluids' && typeof filterFluids === 'function') {
                filterFluids();
            } else if (tabName === 'pipes' && typeof updatePipeTable === 'function') {
                updatePipeTable();
            } else if (tabName === 'materials' && typeof filterMaterials === 'function') {
                filterMaterials();
            }
        }

        // ===== Graphing Calculator =====
        let graphSettings = {
            xMin: -10,
            xMax: 10,
            yMin: -10,
            yMax: 10
        };

        function initGraphCanvas() {
            const canvas = document.getElementById('graphCanvas');
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            // Add mouse move listener for coordinates
            canvas.addEventListener('mousemove', showCoordinates);
        }

        function parseEquation(expr) {
            // Replace common math functions and constants
            let parsed = expr
                .replace(/\^/g, '**')
                .replace(/sin\(/g, 'Math.sin(')
                .replace(/cos\(/g, 'Math.cos(')
                .replace(/tan\(/g, 'Math.tan(')
                .replace(/log\(/g, 'Math.log10(')
                .replace(/ln\(/g, 'Math.log(')
                .replace(/exp\(/g, 'Math.exp(')
                .replace(/sqrt\(/g, 'Math.sqrt(')
                .replace(/abs\(/g, 'Math.abs(')
                .replace(/pi/g, 'Math.PI')
                .replace(/\be\b/g, 'Math.E');
            return parsed;
        }

        function evaluateEquation(expr, x) {
            try {
                const parsed = parseEquation(expr);
                const result = eval(parsed);
                return isFinite(result) ? result : null;
            } catch (e) {
                return null;
            }
        }

        function plotGraph() {
            const canvas = document.getElementById('graphCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.fillStyle = '#1a1a22';
            ctx.fillRect(0, 0, width, height);

            const { xMin, xMax, yMin, yMax } = graphSettings;
            const xRange = xMax - xMin;
            const yRange = yMax - yMin;

            // Coordinate transformations
            const toCanvasX = x => ((x - xMin) / xRange) * width;
            const toCanvasY = y => height - ((y - yMin) / yRange) * height;

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;

            // Vertical grid lines
            for (let x = Math.ceil(xMin); x <= xMax; x++) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(x), 0);
                ctx.lineTo(toCanvasX(x), height);
                ctx.stroke();
            }

            // Horizontal grid lines
            for (let y = Math.ceil(yMin); y <= yMax; y++) {
                ctx.beginPath();
                ctx.moveTo(0, toCanvasY(y));
                ctx.lineTo(width, toCanvasY(y));
                ctx.stroke();
            }

            // Draw axes
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;

            // X-axis
            if (yMin <= 0 && yMax >= 0) {
                ctx.beginPath();
                ctx.moveTo(0, toCanvasY(0));
                ctx.lineTo(width, toCanvasY(0));
                ctx.stroke();
            }

            // Y-axis
            if (xMin <= 0 && xMax >= 0) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(0), 0);
                ctx.lineTo(toCanvasX(0), height);
                ctx.stroke();
            }

            // Draw axis labels
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.font = '11px Inter, sans-serif';

            // X-axis labels
            for (let x = Math.ceil(xMin); x <= xMax; x += Math.ceil(xRange / 10) || 1) {
                if (x !== 0) {
                    ctx.fillText(x.toString(), toCanvasX(x) + 3, toCanvasY(0) - 5);
                }
            }

            // Y-axis labels
            for (let y = Math.ceil(yMin); y <= yMax; y += Math.ceil(yRange / 10) || 1) {
                if (y !== 0) {
                    ctx.fillText(y.toString(), toCanvasX(0) + 5, toCanvasY(y) + 4);
                }
            }

            // Plot equations
            const equations = [
                { id: 'equation1', color: document.getElementById('color1').value },
                { id: 'equation2', color: document.getElementById('color2').value },
                { id: 'equation3', color: document.getElementById('color3').value }
            ];

            equations.forEach(eq => {
                const expr = document.getElementById(eq.id).value.trim();
                if (!expr) return;

                ctx.strokeStyle = eq.color;
                ctx.lineWidth = 2;
                ctx.beginPath();

                let started = false;
                const step = xRange / width;

                for (let px = 0; px < width; px++) {
                    const x = xMin + (px / width) * xRange;
                    const y = evaluateEquation(expr, x);

                    if (y !== null && y >= yMin && y <= yMax) {
                        const canvasY = toCanvasY(y);
                        if (!started) {
                            ctx.moveTo(px, canvasY);
                            started = true;
                        } else {
                            ctx.lineTo(px, canvasY);
                        }
                    } else {
                        started = false;
                    }
                }

                ctx.stroke();
            });
        }

        function showCoordinates(e) {
            const canvas = document.getElementById('graphCanvas');
            const rect = canvas.getBoundingClientRect();
            const px = e.clientX - rect.left;
            const py = e.clientY - rect.top;

            const { xMin, xMax, yMin, yMax } = graphSettings;
            const x = xMin + (px / canvas.width) * (xMax - xMin);
            const y = yMax - (py / canvas.height) * (yMax - yMin);

            document.getElementById('graphInfo').textContent =
                `x: ${x.toFixed(2)}, y: ${y.toFixed(2)}`;
        }

        function zoomGraph(factor) {
            const cx = (graphSettings.xMax + graphSettings.xMin) / 2;
            const cy = (graphSettings.yMax + graphSettings.yMin) / 2;
            const xRange = (graphSettings.xMax - graphSettings.xMin) * factor;
            const yRange = (graphSettings.yMax - graphSettings.yMin) * factor;

            graphSettings.xMin = cx - xRange / 2;
            graphSettings.xMax = cx + xRange / 2;
            graphSettings.yMin = cy - yRange / 2;
            graphSettings.yMax = cy + yRange / 2;

            plotGraph();
        }

        function resetGraph() {
            graphSettings = { xMin: -10, xMax: 10, yMin: -10, yMax: 10 };
            plotGraph();
        }

        function clearGraph() {
            document.getElementById('equation1').value = '';
            document.getElementById('equation2').value = '';
            document.getElementById('equation3').value = '';
            plotGraph();
        }

        // Handle window resize for graph canvas
        window.addEventListener('resize', () => {
            if (document.getElementById('graphingTab').classList.contains('active')) {
                initGraphCanvas();
                plotGraph();
            }
        });

        // ===== Advanced Graphing Features =====

        // Pan/Drag functionality
        let isPanning = false;
        let panStart = { x: 0, y: 0 };

        function setupPanning() {
            const canvas = document.getElementById('graphCanvas');
            if (!canvas) return;

            canvas.addEventListener('mousedown', (e) => {
                if (!document.getElementById('traceMode').checked) {
                    isPanning = true;
                    panStart = { x: e.clientX, y: e.clientY };
                    canvas.style.cursor = 'grabbing';
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isPanning) {
                    const dx = e.clientX - panStart.x;
                    const dy = e.clientY - panStart.y;

                    const { xMin, xMax, yMin, yMax } = graphSettings;
                    const xRange = xMax - xMin;
                    const yRange = yMax - yMin;

                    const xShift = (dx / canvas.width) * xRange;
                    const yShift = (dy / canvas.height) * yRange;

                    graphSettings.xMin -= xShift;
                    graphSettings.xMax -= xShift;
                    graphSettings.yMin += yShift;
                    graphSettings.yMax += yShift;

                    panStart = { x: e.clientX, y: e.clientY };
                    plotGraph();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isPanning = false;
                canvas.style.cursor = 'crosshair';
            });

            canvas.addEventListener('mouseleave', () => {
                isPanning = false;
                canvas.style.cursor = 'crosshair';
            });

            // Trace mode click
            canvas.addEventListener('click', (e) => {
                if (document.getElementById('traceMode').checked) {
                    traceAtPoint(e);
                }
            });

            canvas.style.cursor = 'crosshair';
        }

        // Load equation preset
        function loadPreset() {
            const select = document.getElementById('presetEquations');
            const value = select.value;
            if (value) {
                document.getElementById('equation1').value = value;
                select.value = '';
                plotGraph();
            }
        }

        // Numerical derivative
        function numericalDerivative(expr, x, h = 0.0001) {
            const y1 = evaluateEquation(expr, x - h);
            const y2 = evaluateEquation(expr, x + h);
            if (y1 === null || y2 === null) return null;
            return (y2 - y1) / (2 * h);
        }

        // Enhanced plot with derivatives and integrals
        const originalPlotGraph = plotGraph;
        plotGraph = function () {
            const canvas = document.getElementById('graphCanvas');
            if (!canvas || canvas.width === 0) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.fillStyle = '#1a1a22';
            ctx.fillRect(0, 0, width, height);

            const { xMin, xMax, yMin, yMax } = graphSettings;
            const xRange = xMax - xMin;
            const yRange = yMax - yMin;

            const toCanvasX = x => ((x - xMin) / xRange) * width;
            const toCanvasY = y => height - ((y - yMin) / yRange) * height;

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;

            for (let x = Math.ceil(xMin); x <= xMax; x++) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(x), 0);
                ctx.lineTo(toCanvasX(x), height);
                ctx.stroke();
            }

            for (let y = Math.ceil(yMin); y <= yMax; y++) {
                ctx.beginPath();
                ctx.moveTo(0, toCanvasY(y));
                ctx.lineTo(width, toCanvasY(y));
                ctx.stroke();
            }

            // Draw axes
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;

            if (yMin <= 0 && yMax >= 0) {
                ctx.beginPath();
                ctx.moveTo(0, toCanvasY(0));
                ctx.lineTo(width, toCanvasY(0));
                ctx.stroke();
            }

            if (xMin <= 0 && xMax >= 0) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(0), 0);
                ctx.lineTo(toCanvasX(0), height);
                ctx.stroke();
            }

            // Draw axis labels
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.font = '11px Inter, sans-serif';

            const xStep = Math.ceil(xRange / 10) || 1;
            for (let x = Math.ceil(xMin); x <= xMax; x += xStep) {
                if (x !== 0) ctx.fillText(x.toString(), toCanvasX(x) + 3, toCanvasY(0) - 5);
            }

            const yStep = Math.ceil(yRange / 10) || 1;
            for (let y = Math.ceil(yMin); y <= yMax; y += yStep) {
                if (y !== 0) ctx.fillText(y.toString(), toCanvasX(0) + 5, toCanvasY(y) + 4);
            }

            // Draw integral shading for first equation
            const integralMode = document.getElementById('integralMode')?.checked;
            const expr1 = document.getElementById('equation1')?.value.trim();

            if (integralMode && expr1) {
                ctx.fillStyle = 'rgba(91, 110, 174, 0.2)';
                ctx.beginPath();
                ctx.moveTo(toCanvasX(xMin), toCanvasY(0));

                for (let px = 0; px < width; px++) {
                    const x = xMin + (px / width) * xRange;
                    const y = evaluateEquation(expr1, x);
                    if (y !== null) {
                        ctx.lineTo(px, toCanvasY(y));
                    }
                }

                ctx.lineTo(toCanvasX(xMax), toCanvasY(0));
                ctx.closePath();
                ctx.fill();
            }

            // Plot equations
            const equations = [
                { id: 'equation1', color: document.getElementById('color1')?.value || '#5b6eae', deriv: 'deriv1' },
                { id: 'equation2', color: document.getElementById('color2')?.value || '#7a8bc4', deriv: 'deriv2' },
                { id: 'equation3', color: document.getElementById('color3')?.value || '#9ca3c0', deriv: 'deriv3' }
            ];

            equations.forEach(eq => {
                const input = document.getElementById(eq.id);
                if (!input) return;
                const expr = input.value.trim();
                if (!expr) return;

                // Plot main curve
                ctx.strokeStyle = eq.color;
                ctx.lineWidth = 2;
                ctx.beginPath();

                let started = false;
                for (let px = 0; px < width; px++) {
                    const x = xMin + (px / width) * xRange;
                    const y = evaluateEquation(expr, x);

                    if (y !== null && y >= yMin && y <= yMax) {
                        if (!started) {
                            ctx.moveTo(px, toCanvasY(y));
                            started = true;
                        } else {
                            ctx.lineTo(px, toCanvasY(y));
                        }
                    } else {
                        started = false;
                    }
                }
                ctx.stroke();

                // Plot derivative if enabled
                const derivCheckbox = document.getElementById(eq.deriv);
                if (derivCheckbox?.checked) {
                    ctx.strokeStyle = eq.color;
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 3]);
                    ctx.beginPath();

                    started = false;
                    for (let px = 0; px < width; px += 2) {
                        const x = xMin + (px / width) * xRange;
                        const dy = numericalDerivative(expr, x);

                        if (dy !== null && dy >= yMin && dy <= yMax) {
                            if (!started) {
                                ctx.moveTo(px, toCanvasY(dy));
                                started = true;
                            } else {
                                ctx.lineTo(px, toCanvasY(dy));
                            }
                        } else {
                            started = false;
                        }
                    }
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            });
        };

        // Find roots numerically
        function findRoots() {
            const expr = document.getElementById('equation1').value.trim();
            if (!expr) return;

            const roots = [];
            const { xMin, xMax } = graphSettings;
            const step = (xMax - xMin) / 500;

            let prevY = evaluateEquation(expr, xMin);
            for (let x = xMin + step; x <= xMax; x += step) {
                const y = evaluateEquation(expr, x);
                if (prevY !== null && y !== null && prevY * y < 0) {
                    // Sign change - root between x-step and x
                    const root = bisection(expr, x - step, x);
                    if (root !== null) roots.push(root);
                }
                prevY = y;
            }

            const resultsDiv = document.getElementById('graphResults');
            if (roots.length > 0) {
                resultsDiv.innerHTML = '<strong>Roots (x-intercepts):</strong> ' +
                    roots.map(r => `<span class="result-item">x = ${r.toFixed(4)}</span>`).join('');
            } else {
                resultsDiv.innerHTML = '<strong>No roots found in visible range</strong>';
            }
        }

        function bisection(expr, a, b, tol = 0.0001, maxIter = 50) {
            for (let i = 0; i < maxIter; i++) {
                const mid = (a + b) / 2;
                const fMid = evaluateEquation(expr, mid);
                const fA = evaluateEquation(expr, a);

                if (fMid === null || fA === null) return null;
                if (Math.abs(fMid) < tol) return mid;

                if (fA * fMid < 0) b = mid;
                else a = mid;
            }
            return (a + b) / 2;
        }

        // Find intersections
        function findIntersections() {
            const expr1 = document.getElementById('equation1').value.trim();
            const expr2 = document.getElementById('equation2').value.trim();

            if (!expr1 || !expr2) {
                document.getElementById('graphResults').innerHTML =
                    '<strong>Enter two equations to find intersections</strong>';
                return;
            }

            const intersections = [];
            const { xMin, xMax } = graphSettings;
            const step = (xMax - xMin) / 500;

            let prevDiff = evaluateEquation(expr1, xMin) - evaluateEquation(expr2, xMin);
            for (let x = xMin + step; x <= xMax; x += step) {
                const y1 = evaluateEquation(expr1, x);
                const y2 = evaluateEquation(expr2, x);
                if (y1 === null || y2 === null) continue;

                const diff = y1 - y2;
                if (prevDiff * diff < 0) {
                    // Intersection between x-step and x
                    const ix = bisectionIntersect(expr1, expr2, x - step, x);
                    if (ix !== null) {
                        const iy = evaluateEquation(expr1, ix);
                        intersections.push({ x: ix, y: iy });
                    }
                }
                prevDiff = diff;
            }

            const resultsDiv = document.getElementById('graphResults');
            if (intersections.length > 0) {
                resultsDiv.innerHTML = '<strong>Intersections:</strong> ' +
                    intersections.map(p =>
                        `<span class="result-item">(${p.x.toFixed(3)}, ${p.y.toFixed(3)})</span>`
                    ).join('');
            } else {
                resultsDiv.innerHTML = '<strong>No intersections found in visible range</strong>';
            }
        }

        function bisectionIntersect(expr1, expr2, a, b, tol = 0.0001, maxIter = 50) {
            for (let i = 0; i < maxIter; i++) {
                const mid = (a + b) / 2;
                const diff = evaluateEquation(expr1, mid) - evaluateEquation(expr2, mid);
                const diffA = evaluateEquation(expr1, a) - evaluateEquation(expr2, a);

                if (diff === null || diffA === null) return null;
                if (Math.abs(diff) < tol) return mid;

                if (diffA * diff < 0) b = mid;
                else a = mid;
            }
            return (a + b) / 2;
        }

        // Save graph as PNG
        function saveGraph() {
            const canvas = document.getElementById('graphCanvas');
            const link = document.createElement('a');
            link.download = 'graph.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // Toggle table visibility
        function toggleTable() {
            const table = document.getElementById('valuesTable');
            table.style.display = table.style.display === 'none' ? 'flex' : 'none';
            if (table.style.display !== 'none') {
                generateTable();
            }
        }

        // Generate table of values
        function generateTable() {
            const xMin = parseFloat(document.getElementById('tableXMin').value) || -5;
            const xMax = parseFloat(document.getElementById('tableXMax').value) || 5;
            const step = parseFloat(document.getElementById('tableStep').value) || 1;

            const expr1 = document.getElementById('equation1').value.trim();
            const expr2 = document.getElementById('equation2').value.trim();
            const expr3 = document.getElementById('equation3').value.trim();

            let html = '<table><thead><tr><th>x</th>';
            if (expr1) html += '<th>yâ‚</th>';
            if (expr2) html += '<th>yâ‚‚</th>';
            if (expr3) html += '<th>yâ‚ƒ</th>';
            html += '</tr></thead><tbody>';

            for (let x = xMin; x <= xMax; x += step) {
                html += `<tr><td>${x.toFixed(2)}</td>`;
                if (expr1) {
                    const y = evaluateEquation(expr1, x);
                    html += `<td>${y !== null ? y.toFixed(4) : 'â€”'}</td>`;
                }
                if (expr2) {
                    const y = evaluateEquation(expr2, x);
                    html += `<td>${y !== null ? y.toFixed(4) : 'â€”'}</td>`;
                }
                if (expr3) {
                    const y = evaluateEquation(expr3, x);
                    html += `<td>${y !== null ? y.toFixed(4) : 'â€”'}</td>`;
                }
                html += '</tr>';
            }

            html += '</tbody></table>';
            document.getElementById('tableContent').innerHTML = html;
        }

        // Trace mode - click to see exact values
        function traceAtPoint(e) {
            const canvas = document.getElementById('graphCanvas');
            const rect = canvas.getBoundingClientRect();
            const px = e.clientX - rect.left;

            const { xMin, xMax } = graphSettings;
            const x = xMin + (px / canvas.width) * (xMax - xMin);

            const expr1 = document.getElementById('equation1').value.trim();
            if (!expr1) return;

            const y = evaluateEquation(expr1, x);
            if (y === null) return;

            const toCanvasY = y => canvas.height - ((y - graphSettings.yMin) / (graphSettings.yMax - graphSettings.yMin)) * canvas.height;

            const tracePoint = document.getElementById('tracePoint');
            tracePoint.style.display = 'block';
            tracePoint.style.left = px + 'px';
            tracePoint.style.top = toCanvasY(y) + 'px';

            document.getElementById('graphInfo').textContent =
                `Trace: x = ${x.toFixed(4)}, y = ${y.toFixed(4)}`;
        }

        // Note: switchTab is defined later with full tab support

        // ===== Scientific Calculator =====
        let calcExpression = '';
        let calcMemory = 0;
        let calcLastAnswer = 0;
        let calcDegMode = true; // true = degrees, false = radians

        function updateCalcDisplay() {
            document.getElementById('calcDisplay').value = calcExpression || '0';
        }

        function calcDigit(d) {
            if (calcExpression === '0' && d !== '.') {
                calcExpression = d;
            } else {
                calcExpression += d;
            }
            updateCalcDisplay();
        }

        function calcOperator(op) {
            calcExpression += op;
            updateCalcDisplay();
        }

        function calcFunction(fn) {
            const val = parseFloat(calcExpression) || 0;
            let result;

            switch (fn) {
                case 'sin':
                    result = Math.sin(calcDegMode ? val * Math.PI / 180 : val);
                    break;
                case 'cos':
                    result = Math.cos(calcDegMode ? val * Math.PI / 180 : val);
                    break;
                case 'tan':
                    result = Math.tan(calcDegMode ? val * Math.PI / 180 : val);
                    break;
                case 'asin':
                    result = calcDegMode ? Math.asin(val) * 180 / Math.PI : Math.asin(val);
                    break;
                case 'acos':
                    result = calcDegMode ? Math.acos(val) * 180 / Math.PI : Math.acos(val);
                    break;
                case 'atan':
                    result = calcDegMode ? Math.atan(val) * 180 / Math.PI : Math.atan(val);
                    break;
                case 'log':
                    result = Math.log10(val);
                    break;
                case 'ln':
                    result = Math.log(val);
                    break;
                case 'sqrt':
                    result = Math.sqrt(val);
                    break;
                case 'square':
                    result = val * val;
                    break;
                case 'exp':
                    result = Math.exp(val);
                    break;
                case 'pow10':
                    result = Math.pow(10, val);
                    break;
                case 'abs':
                    result = Math.abs(val);
                    break;
                case 'inv':
                    result = 1 / val;
                    break;
                case 'negate':
                    calcExpression = calcExpression.startsWith('-') ?
                        calcExpression.substring(1) : '-' + calcExpression;
                    updateCalcDisplay();
                    return;
                default:
                    return;
            }

            calcExpression = isFinite(result) ? result.toString() : 'Error';
            updateCalcDisplay();
        }

        function calcConst(c) {
            if (c === 'pi') calcExpression += Math.PI.toString();
            else if (c === 'e') calcExpression += Math.E.toString();
            updateCalcDisplay();
        }

        function calcClear() {
            calcExpression = '';
            document.getElementById('calcHistory').textContent = '';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcExpression = calcExpression.slice(0, -1);
            updateCalcDisplay();
        }

        function factorial(n) {
            if (n < 0) return NaN;
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        function calcEquals() {
            try {
                // Replace display operators with JS operators
                let expr = calcExpression
                    .replace(/Ã—/g, '*')
                    .replace(/Ã·/g, '/')
                    .replace(/âˆ’/g, '-')
                    .replace(/\^/g, '**');

                // Handle factorial
                expr = expr.replace(/(\d+)!/g, (match, num) => factorial(parseInt(num)));

                const result = eval(expr);
                document.getElementById('calcHistory').textContent = calcExpression + ' =';
                calcLastAnswer = result;
                calcExpression = isFinite(result) ? result.toString() : 'Error';
                updateCalcDisplay();
            } catch (e) {
                calcExpression = 'Error';
                updateCalcDisplay();
            }
        }

        function calcMemory(action) {
            const val = parseFloat(calcExpression) || 0;
            switch (action) {
                case 'MC':
                    calcMemory = 0;
                    document.getElementById('calcMemoryIndicator').textContent = '';
                    break;
                case 'MR':
                    calcExpression = calcMemory.toString();
                    updateCalcDisplay();
                    break;
                case 'M+':
                    calcMemory += val;
                    document.getElementById('calcMemoryIndicator').textContent = 'M: ' + calcMemory.toFixed(4);
                    break;
                case 'M-':
                    calcMemory -= val;
                    document.getElementById('calcMemoryIndicator').textContent = 'M: ' + calcMemory.toFixed(4);
                    break;
            }
        }

        function calcDegRad() {
            calcDegMode = !calcDegMode;
            document.getElementById('calcMode').textContent = calcDegMode ? 'DEG' : 'RAD';
            document.querySelector('.calc-btn.function[onclick*="calcDegRad"]').textContent =
                calcDegMode ? 'DEG' : 'RAD';
        }

        function calcAns() {
            calcExpression += calcLastAnswer.toString();
            updateCalcDisplay();
        }

        // ===== Reference Data =====

        // Steam Tables Data (Saturated)
        const steamData = [
            { T: 0.01, P: 0.6117, vf: 0.001000, vg: 206.136, hf: 0.00, hfg: 2501.3, hg: 2501.3, sf: 0.0000, sg: 9.1562 },
            { T: 20, P: 2.339, vf: 0.001002, vg: 57.79, hf: 83.96, hfg: 2454.1, hg: 2538.1, sf: 0.2966, sg: 8.6672 },
            { T: 40, P: 7.384, vf: 0.001008, vg: 19.52, hf: 167.57, hfg: 2406.7, hg: 2574.3, sf: 0.5725, sg: 8.2570 },
            { T: 60, P: 19.94, vf: 0.001017, vg: 7.671, hf: 251.13, hfg: 2358.5, hg: 2609.6, sf: 0.8312, sg: 7.9096 },
            { T: 80, P: 47.39, vf: 0.001029, vg: 3.407, hf: 334.91, hfg: 2308.8, hg: 2643.7, sf: 1.0753, sg: 7.6122 },
            { T: 100, P: 101.35, vf: 0.001044, vg: 1.6729, hf: 419.04, hfg: 2257.0, hg: 2676.1, sf: 1.3069, sg: 7.3549 },
            { T: 120, P: 198.53, vf: 0.001060, vg: 0.8919, hf: 503.50, hfg: 2202.6, hg: 2706.1, sf: 1.5276, sg: 7.1296 },
            { T: 140, P: 361.3, vf: 0.001080, vg: 0.5089, hf: 588.74, hfg: 2145.0, hg: 2733.8, sf: 1.7391, sg: 6.9299 },
            { T: 160, P: 617.8, vf: 0.001102, vg: 0.3071, hf: 675.09, hfg: 2083.7, hg: 2758.8, sf: 1.9427, sg: 6.7502 },
            { T: 180, P: 1002.1, vf: 0.001127, vg: 0.1941, hf: 762.79, hfg: 2018.0, hg: 2780.8, sf: 2.1396, sg: 6.5865 },
            { T: 200, P: 1553.8, vf: 0.001157, vg: 0.1274, hf: 852.26, hfg: 1947.3, hg: 2799.5, sf: 2.3309, sg: 6.4323 },
            { T: 250, P: 3973, vf: 0.001251, vg: 0.05013, hf: 1085.4, hfg: 1716.2, hg: 2801.5, sf: 2.7927, sg: 6.0730 },
            { T: 300, P: 8581, vf: 0.001404, vg: 0.02167, hf: 1344.0, hfg: 1405.0, hg: 2749.0, sf: 3.2534, sg: 5.7045 },
            { T: 350, P: 16513, vf: 0.001740, vg: 0.00881, hf: 1670.6, hfg: 893.4, hg: 2564.0, sf: 3.7777, sg: 5.2112 }
        ];

        // Fluid Properties Data
        const fluidData = [
            { name: 'Water', rho: 997, mu: 0.89, Cp: 4.18, k: 0.606, Tb: 100, Tc: 374, Pc: 22.06 },
            { name: 'Ethanol', rho: 789, mu: 1.07, Cp: 2.44, k: 0.171, Tb: 78.4, Tc: 241, Pc: 6.14 },
            { name: 'Methanol', rho: 792, mu: 0.54, Cp: 2.53, k: 0.203, Tb: 64.7, Tc: 240, Pc: 8.10 },
            { name: 'Acetone', rho: 784, mu: 0.31, Cp: 2.15, k: 0.161, Tb: 56.2, Tc: 235, Pc: 4.70 },
            { name: 'Benzene', rho: 876, mu: 0.60, Cp: 1.74, k: 0.144, Tb: 80.1, Tc: 289, Pc: 4.89 },
            { name: 'Toluene', rho: 867, mu: 0.56, Cp: 1.71, k: 0.134, Tb: 110.6, Tc: 319, Pc: 4.11 },
            { name: 'Hexane', rho: 655, mu: 0.30, Cp: 2.27, k: 0.124, Tb: 69, Tc: 234, Pc: 3.01 },
            { name: 'Heptane', rho: 684, mu: 0.39, Cp: 2.25, k: 0.124, Tb: 98.4, Tc: 267, Pc: 2.74 },
            { name: 'Ammonia (liq)', rho: 602, mu: 0.13, Cp: 4.70, k: 0.507, Tb: -33.3, Tc: 132, Pc: 11.35 },
            { name: 'Sulfuric Acid (98%)', rho: 1840, mu: 24.5, Cp: 1.38, k: 0.355, Tb: 337, Tc: 654, Pc: 6.40 },
            { name: 'Air', rho: 1.18, mu: 0.018, Cp: 1.01, k: 0.026, Tb: -194, Tc: -140, Pc: 3.77 },
            { name: 'CO2', rho: 1.80, mu: 0.015, Cp: 0.85, k: 0.017, Tb: -78, Tc: 31, Pc: 7.38 },
            { name: 'Nitrogen', rho: 1.14, mu: 0.018, Cp: 1.04, k: 0.026, Tb: -196, Tc: -147, Pc: 3.40 },
            { name: 'Oxygen', rho: 1.31, mu: 0.020, Cp: 0.92, k: 0.026, Tb: -183, Tc: -118, Pc: 5.04 },
            { name: 'Glycerol', rho: 1261, mu: 950, Cp: 2.43, k: 0.285, Tb: 290, Tc: 453, Pc: 6.69 }
        ];

        // Pipe Schedule Data
        const pipeData = {
            '10': [
                { nps: '1/2', od: 0.840, wall: 0.083 },
                { nps: '3/4', od: 1.050, wall: 0.083 },
                { nps: '1', od: 1.315, wall: 0.109 },
                { nps: '1-1/2', od: 1.900, wall: 0.109 },
                { nps: '2', od: 2.375, wall: 0.109 },
                { nps: '3', od: 3.500, wall: 0.120 },
                { nps: '4', od: 4.500, wall: 0.120 },
                { nps: '6', od: 6.625, wall: 0.134 },
                { nps: '8', od: 8.625, wall: 0.148 },
                { nps: '10', od: 10.75, wall: 0.165 },
                { nps: '12', od: 12.75, wall: 0.180 }
            ],
            '40': [
                { nps: '1/2', od: 0.840, wall: 0.109 },
                { nps: '3/4', od: 1.050, wall: 0.113 },
                { nps: '1', od: 1.315, wall: 0.133 },
                { nps: '1-1/2', od: 1.900, wall: 0.145 },
                { nps: '2', od: 2.375, wall: 0.154 },
                { nps: '3', od: 3.500, wall: 0.216 },
                { nps: '4', od: 4.500, wall: 0.237 },
                { nps: '6', od: 6.625, wall: 0.280 },
                { nps: '8', od: 8.625, wall: 0.322 },
                { nps: '10', od: 10.75, wall: 0.365 },
                { nps: '12', od: 12.75, wall: 0.406 }
            ],
            '80': [
                { nps: '1/2', od: 0.840, wall: 0.147 },
                { nps: '3/4', od: 1.050, wall: 0.154 },
                { nps: '1', od: 1.315, wall: 0.179 },
                { nps: '1-1/2', od: 1.900, wall: 0.200 },
                { nps: '2', od: 2.375, wall: 0.218 },
                { nps: '3', od: 3.500, wall: 0.300 },
                { nps: '4', od: 4.500, wall: 0.337 },
                { nps: '6', od: 6.625, wall: 0.432 },
                { nps: '8', od: 8.625, wall: 0.500 },
                { nps: '10', od: 10.75, wall: 0.593 },
                { nps: '12', od: 12.75, wall: 0.687 }
            ],
            '160': [
                { nps: '1/2', od: 0.840, wall: 0.187 },
                { nps: '3/4', od: 1.050, wall: 0.218 },
                { nps: '1', od: 1.315, wall: 0.250 },
                { nps: '1-1/2', od: 1.900, wall: 0.281 },
                { nps: '2', od: 2.375, wall: 0.343 },
                { nps: '3', od: 3.500, wall: 0.438 },
                { nps: '4', od: 4.500, wall: 0.531 },
                { nps: '6', od: 6.625, wall: 0.718 },
                { nps: '8', od: 8.625, wall: 0.906 },
                { nps: '10', od: 10.75, wall: 1.125 },
                { nps: '12', od: 12.75, wall: 1.312 }
            ]
        };

        // Materials Data
        const materialData = [
            { name: 'A36 Carbon Steel', cat: 'steel', rho: 7850, E: 200, sigmaY: 250, alpha: 11.7, k: 50, Tmax: 400 },
            { name: 'A516 Gr 70', cat: 'steel', rho: 7850, E: 200, sigmaY: 260, alpha: 11.7, k: 50, Tmax: 450 },
            { name: 'A106 Gr B', cat: 'steel', rho: 7850, E: 200, sigmaY: 240, alpha: 11.7, k: 50, Tmax: 400 },
            { name: '304 SS', cat: 'stainless', rho: 8000, E: 193, sigmaY: 215, alpha: 17.3, k: 16, Tmax: 870 },
            { name: '316 SS', cat: 'stainless', rho: 8000, E: 193, sigmaY: 220, alpha: 16.0, k: 16, Tmax: 870 },
            { name: '316L SS', cat: 'stainless', rho: 8000, E: 193, sigmaY: 170, alpha: 16.0, k: 16, Tmax: 450 },
            { name: 'Duplex 2205', cat: 'stainless', rho: 7800, E: 200, sigmaY: 450, alpha: 13.0, k: 19, Tmax: 300 },
            { name: 'Inconel 625', cat: 'alloy', rho: 8440, E: 208, sigmaY: 517, alpha: 12.8, k: 10, Tmax: 980 },
            { name: 'Hastelloy C-276', cat: 'alloy', rho: 8890, E: 205, sigmaY: 355, alpha: 11.2, k: 10, Tmax: 1090 },
            { name: 'Monel 400', cat: 'alloy', rho: 8800, E: 179, sigmaY: 240, alpha: 13.9, k: 22, Tmax: 480 },
            { name: 'PTFE (Teflon)', cat: 'plastic', rho: 2200, E: 0.5, sigmaY: 25, alpha: 120, k: 0.25, Tmax: 260 },
            { name: 'HDPE', cat: 'plastic', rho: 960, E: 1.1, sigmaY: 26, alpha: 120, k: 0.50, Tmax: 80 }
        ];

        // Render functions
        function updateSteamTable() {
            const tbody = document.getElementById('steamTableBody');
            tbody.innerHTML = steamData.map(row => `
                <tr>
                    <td>${row.T}</td>
                    <td>${row.P.toFixed(2)}</td>
                    <td>${row.vf.toFixed(6)}</td>
                    <td>${row.vg.toFixed(4)}</td>
                    <td>${row.hf.toFixed(2)}</td>
                    <td>${row.hfg.toFixed(1)}</td>
                    <td>${row.hg.toFixed(1)}</td>
                    <td>${row.sf.toFixed(4)}</td>
                    <td>${row.sg.toFixed(4)}</td>
                </tr>
            `).join('');
        }

        function filterFluids() {
            const search = document.getElementById('fluidSearch').value.toLowerCase();
            const tbody = document.getElementById('fluidsTableBody');
            const filtered = fluidData.filter(f => f.name.toLowerCase().includes(search));
            tbody.innerHTML = filtered.map(row => `
                <tr>
                    <td>${row.name}</td>
                    <td>${row.rho}</td>
                    <td>${row.mu}</td>
                    <td>${row.Cp}</td>
                    <td>${row.k}</td>
                    <td>${row.Tb}</td>
                    <td>${row.Tc}</td>
                    <td>${row.Pc}</td>
                </tr>
            `).join('');
        }

        function updatePipeTable() {
            const sch = document.getElementById('pipeSchedule').value;
            const data = pipeData[sch] || pipeData['40'];
            const tbody = document.getElementById('pipesTableBody');
            tbody.innerHTML = data.map(row => {
                const id = row.od - 2 * row.wall;
                const odMm = row.od * 25.4;
                const wallMm = row.wall * 25.4;
                const idMm = id * 25.4;
                const area = Math.PI * (id / 2) ** 2;
                const weight = 10.69 * (row.od - row.wall) * row.wall;
                return `
                    <tr>
                        <td>${row.nps}</td>
                        <td>${row.od.toFixed(3)}</td>
                        <td>${odMm.toFixed(1)}</td>
                        <td>${row.wall.toFixed(3)}</td>
                        <td>${wallMm.toFixed(2)}</td>
                        <td>${id.toFixed(3)}</td>
                        <td>${idMm.toFixed(1)}</td>
                        <td>${area.toFixed(3)}</td>
                        <td>${weight.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        function filterMaterials() {
            const search = document.getElementById('materialSearch').value.toLowerCase();
            const cat = document.getElementById('materialCategory').value;
            const tbody = document.getElementById('materialsTableBody');
            const filtered = materialData.filter(m =>
                m.name.toLowerCase().includes(search) &&
                (cat === '' || m.cat === cat)
            );
            const catNames = { steel: 'Carbon Steel', stainless: 'Stainless Steel', alloy: 'Alloy', plastic: 'Plastic' };
            tbody.innerHTML = filtered.map(row => `
                <tr>
                    <td>${row.name}</td>
                    <td>${catNames[row.cat]}</td>
                    <td>${row.rho}</td>
                    <td>${row.E}</td>
                    <td>${row.sigmaY}</td>
                    <td>${row.alpha}</td>
                    <td>${row.k}</td>
                    <td>${row.Tmax}</td>
                </tr>
            `).join('');
        }

        // Update switchTab to include new tabs
        const masterSwitchTab = switchTab;
        switchTab = function (tabName) {
            // Update tab buttons - find by matching tab name in button text
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
                const btnText = tab.textContent.toLowerCase();
                if (tabName === 'equations' && btnText.includes('equation')) tab.classList.add('active');
                else if (tabName === 'graphing' && btnText.includes('graph')) tab.classList.add('active');
                else if (tabName === 'scientific' && btnText.includes('calc')) tab.classList.add('active');
                else if (tabName === 'steam' && btnText.includes('steam')) tab.classList.add('active');
                else if (tabName === 'fluids' && btnText.includes('fluid')) tab.classList.add('active');
                else if (tabName === 'pipes' && btnText.includes('pipe')) tab.classList.add('active');
                else if (tabName === 'materials' && btnText.includes('material')) tab.classList.add('active');
            });

            // Hide all tabs
            ['equations', 'graphing', 'scientific', 'steam', 'fluids', 'pipes', 'materials'].forEach(t => {
                const el = document.getElementById(t + 'Tab');
                if (el) el.classList.remove('active');
            });

            // Show selected tab
            const tabEl = document.getElementById(tabName + 'Tab');
            if (tabEl) tabEl.classList.add('active');

            // Initialize specific tabs
            if (tabName === 'graphing') {
                initGraphCanvas();
                setupPanning();
                plotGraph();
            } else if (tabName === 'steam') {
                updateSteamTable();
            } else if (tabName === 'fluids') {
                filterFluids();
            } else if (tabName === 'pipes') {
                updatePipeTable();
            } else if (tabName === 'materials') {
                filterMaterials();
            }
        };

    </script>
</body>

</html>